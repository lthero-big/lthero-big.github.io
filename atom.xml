<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>lthero</title>
  
  <subtitle>个人博客</subtitle>
  <link href="https://blog.lthero.cn/atom.xml" rel="self"/>
  
  <link href="https://blog.lthero.cn/"/>
  <updated>2024-11-29T13:50:01.200Z</updated>
  <id>https://blog.lthero.cn/</id>
  
  <author>
    <name>lthero</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>【流媒体解锁】两种方式</title>
    <link href="https://blog.lthero.cn/2024/11/29/UnlockNetflixWithDNS/"/>
    <id>https://blog.lthero.cn/2024/11/29/UnlockNetflixWithDNS/</id>
    <published>2024-11-29T13:39:07.000Z</published>
    <updated>2024-11-29T13:50:01.200Z</updated>
    
    <content type="html"><![CDATA[<h1 id="流媒体-奈飞-迪斯尼等-一键修改解锁dns脚本">流媒体（奈飞&amp;迪斯尼等）一键修改解锁DNS脚本</h1><p><strong>支持操作系统</strong>: Debian &amp; Ubuntu</p><h3 id="项目简介">项目简介</h3><p>该脚本旨在帮助用户通过 <strong>流媒体解锁 DNS</strong> 实现快速的 DNS 分流与全局 DNS 替换。只需简单的几个步骤，即可轻松配置与解锁 DNS。适用于 VPS 用户，支持一键配置，无需复杂设置。</p><h3 id="使用指南">使用指南</h3><h4 id="步骤-1-注册-alice-账号-适用于没有解锁dns-ip的用户">步骤 1: 注册 Alice 账号(适用于没有解锁DNS IP的用户)</h4><ol><li><p>访问 <a href="https://www.nodeseek.com/jump?to=https%3A%2F%2Fapp.alice.ws">Alice DNS 官网</a> 进行注册（官方的解锁教程：<a href="https://blog.alice.ws/16%EF%BC%89">https://blog.alice.ws/16）</a></p></li><li><p>在注册后，将您的 VPS IP 地址添加至 Alice 白名单。</p><blockquote><p><strong>注意</strong>：此过程可能需要 3-5 分钟生效。</p></blockquote></li></ol><h4 id="步骤-2-运行一键分流脚本">步骤 2: 运行一键分流脚本</h4><ol><li><p>下载并运行以下脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/Jimmyzxk/DNS-Alice-Unlock/refs/heads/main/dns-unlock.sh &amp;&amp; bash dns-unlock.sh</span><br></pre></td></tr></table></figure></li></ol><hr><p>运行之前，要确保53端口没被占用</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看53端口是否被占用</span></span><br><span class="line">sudo netstat -tulnp | grep :53</span><br><span class="line"><span class="comment"># 关掉resolved</span></span><br><span class="line">sudo systemctl stop systemd-resolved</span><br><span class="line"><span class="comment"># 禁止开机自启resolved</span></span><br><span class="line">sudo systemctl <span class="built_in">disable</span> systemd-resolved</span><br></pre></td></tr></table></figure><h4 id="解锁方式-1-1：dns-分流模式-dnsmasq">解锁方式 1-1：DNS 分流模式(dnsmasq)</h4><ol><li>在脚本菜单中选择 <code>1</code>。</li><li>脚本将自动安装并配置 <code>dnsmasq</code>，实现多媒体流量的智能分流。</li><li>安装过程中会提示是否输入个人解锁IP，回车默认Alice,IP，输入y，填写个人解锁IP 。<ul><li><strong>适用场景</strong>：优化流媒体（如 Netflix、Disney等）访问体验，确保内容加载更快，解锁区域内容。</li></ul></li></ol><h4 id="选择分流区域-sg-hk">选择分流区域（SG / HK）</h4><ol><li><p>在脚本菜单中选择 <code>3</code>，进入分流区域选择界面。</p></li><li><p>脚本支持自助选择</p><p>SG（新加坡）或HK（香港）</p><p>区域进行分流优化。</p><ul><li><strong>SG（新加坡）</strong>：适用于连接东南亚地区的用户，提供更优的路由和速度。</li><li><strong>HK（香港）</strong>：适用于连接香港及周边地区的用户，提供稳定且快速的网络连接。</li><li>选择完毕后，脚本将根据选择的区域配置合适的分流策略。</li></ul></li></ol><hr><h4 id="解锁方式-1-2：dns-分流模式-smartdns">解锁方式 1-2：DNS 分流模式（smartdns）</h4><ol><li><p>在脚本菜单中选择 <code>2-1</code>。</p></li><li><p>按照提示是否替换为个人解锁DNSIP，IP1/2可同一个；</p></li><li><p>脚本将自动安装并配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smartdns</span><br></pre></td></tr></table></figure><p>，实现多媒体流量的智能分流。</p><ul><li><strong>适用场景</strong>：优化流媒体（如 Netflix、Disney等）访问体验，确保内容加载更快，解锁区域内容。</li></ul></li></ol><hr><h4 id="解锁方式-2：全局-dns-替换模式">解锁方式 2：全局 DNS 替换模式</h4><ol><li>在脚本菜单中选择 <code>3-3</code>。</li><li>输入自己的解锁IP，一键替换，并锁定resolv.conf文件。<ul><li><strong>适用场景</strong>：需要整体优化网络解析速度，提升所有已解锁自媒体请求。</li></ul></li></ol><h1 id="利用sni代理和smartdns自建dns解锁">利用sni代理和smartdns自建DNS解锁</h1><h2 id="写在前面">写在前面</h2><p>为实现自建DNS解锁可以采取两种办法：第一种直接在被解锁服务器设置解锁，适用于单个服务器需要解锁的应用场景。第二种建立私人DNS服务器，适用于多台服务器需要解锁的应用场景。</p><table><thead><tr><th></th><th>方案一</th><th>方案二</th></tr></thead><tbody><tr><td>搭建sni代理</td><td>√</td><td>√</td></tr><tr><td>搭建DNS服务器</td><td>√</td><td>×</td></tr><tr><td>被解锁机本地设置</td><td>仅需修改系统DNS</td><td>需要在所有被解锁机搭建smartdns</td></tr><tr><td>灵活性</td><td>快捷</td><td>较为复杂</td></tr><tr><td>可靠性</td><td>自建DNS服务器宕机，本地DNS瘫痪</td><td>自建DNS服务器宕机，本地DNS正常</td></tr><tr><td>应用场景</td><td>多台服务器</td><td>单台服务器</td></tr></tbody></table><p><strong>本文之所以选择用smartdns取代Dnsmasq，在于smartdns 无论是在查询速度、查询到的IP访问速度和广告过滤都强于Dnsmasq。</strong></p><h2 id="必备内容">必备内容</h2><p>1台解锁流媒体的服务器（443和80端口不能被占用）</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看80端口是否被占用</span></span><br><span class="line">sudo netstat -tulnp | grep :80</span><br><span class="line"><span class="comment"># 关掉nginx</span></span><br><span class="line">sudo systemctl stop nginx</span><br><span class="line"><span class="comment"># 禁止开机自启nginx</span></span><br><span class="line">sudo systemctl <span class="built_in">disable</span> nginx</span><br></pre></td></tr></table></figure><h2 id="搭建教程">搭建教程</h2><p>由于存在两种实现方法，教程除了sni代理为统一步骤外，其余部分因差异性将分开阐述。</p><h3 id="安装sni-proxy">安装SNI Proxy</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate -O dnsmasq_sniproxy.sh https://raw.githubusercontent.com/myxuchangbin/dnsmasq_sniproxy_install/master/dnsmasq_sniproxy.sh &amp;&amp; bash dnsmasq_sniproxy.sh -is</span><br></pre></td></tr></table></figure><h3 id="设置sni-proxy">设置SNI Proxy</h3><p>修改配置文件，将所需dns解锁的网址格式化输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/sniproxy.conf</span><br></pre></td></tr></table></figure><p>格式示例</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">user daemon</span><br><span class="line">pidfile /var/tmp/sniproxy.pid</span><br><span class="line"></span><br><span class="line">error_log &#123;</span><br><span class="line">    syslog daemon</span><br><span class="line">    priority notice</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resolver &#123;</span><br><span class="line">    nameserver 8.8.8.8</span><br><span class="line">    nameserver 8.8.4.4 <span class="comment"># local dns should be better</span></span><br><span class="line">    mode ipv4_only</span><br><span class="line">&#125;</span><br><span class="line">listener 0.0.0.0:80 &#123;</span><br><span class="line">    proto http</span><br><span class="line">    access_log &#123;</span><br><span class="line">        filename /var/log/sniproxy/http_access.log</span><br><span class="line">        priority notice</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">listener 0.0.0.0:443 &#123;</span><br><span class="line">    proto tls</span><br><span class="line">    access_log &#123;</span><br><span class="line">        filename /var/log/sniproxy/https_access.log</span><br><span class="line">        priority notice</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">table &#123;</span><br><span class="line">    .*ai\.com$ *</span><br><span class="line">    .*openai\.com$ *</span><br><span class="line">    .*chatgpt.com$ *</span><br><span class="line">    .*oaistatic.com$ *</span><br><span class="line">    .*oaiusercontent.com$ *</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重启SNI Proxy</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart sniproxy</span><br></pre></td></tr></table></figure><h3 id="解锁机设置解锁白名单">解锁机设置解锁白名单</h3><p>如未安装ufw，请先执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ufw</span><br><span class="line">ufw enable</span><br></pre></td></tr></table></figure><p><strong>第一次安装一定要放行当前使用的ssh端口</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow 22/tcp</span><br></pre></td></tr></table></figure><p>修改下面示例的IP（写被解锁机IP），执行即可。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow from 2.2.2.2 to any port 443 proto tcp</span><br><span class="line">sudo ufw allow from 2.2.2.2 to any port 443 proto udp</span><br><span class="line">sudo ufw allow from 2.2.2.2 to any port 80 proto tcp</span><br><span class="line">sudo ufw allow from 2.2.2.2 to any port 80 proto udp</span><br></pre></td></tr></table></figure><h2 id="方案一：安装smartdns-搭建dns服务器">方案一：安装smartdns 搭建DNS服务器</h2><p>此处可以用另一台服务器，也可以就用搭建sni代理那台服务器。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/pymumu/smartdns/releases/download/Release46/smartdns.1.2024.06.12-2222.x86-linux-all.tar.gz</span><br><span class="line">tar zxf smartdns.1.2024.06.12-2222.x86-linux-all.tar.gz</span><br><span class="line">cd smartdns</span><br><span class="line">chmod +x ./install</span><br><span class="line">./install -i</span><br></pre></td></tr></table></figure><h3 id="设置smardns">设置smardns</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/smartdns/smartdns.conf</span><br></pre></td></tr></table></figure><p>编辑配置，自行添加需要解锁的网址，常见流媒体域名可以参考<a href="https://www.nodeseek.com/jump?to=https%3A%2F%2Fgithub.com%2F1-stream%2F1stream-public-utils%2Fblob%2Fmain%2Fstream.smartdns.list">1stream写好的</a>。<br>格式示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">bind[::]:53@eth0 -no-dualstack-selection -no-speed-check #不要动</span><br><span class="line">dualstack-ip-selection no</span><br><span class="line">speed-check-mode none</span><br><span class="line">serve-expired-prefetch-time 21600</span><br><span class="line">prefetch-domain yes</span><br><span class="line">cache-size 32768</span><br><span class="line">cache-persist yes</span><br><span class="line">cache-file /etc/smartdns/cache</span><br><span class="line">prefetch-domain yes</span><br><span class="line">serve-expired yes</span><br><span class="line">serve-expired-ttl 259200</span><br><span class="line">serve-expired-reply-ttl 3</span><br><span class="line">prefetch-domain yes</span><br><span class="line">serve-expired-prefetch-time 21600</span><br><span class="line">cache-checkpoint-time 86400</span><br><span class="line">#force-AAAA-SOA yes</span><br><span class="line">server 210.0.255.250 #默认上游DNS</span><br><span class="line">server 210.0.255.251 #默认上游DNS</span><br><span class="line"></span><br><span class="line"># ---------- &gt; Global Plaform</span><br><span class="line"># &gt; GPT</span><br><span class="line">address /openai.com/解锁机IP</span><br><span class="line">address /chatgpt.com/解锁机IP</span><br><span class="line">address /oaistatic.com/解锁机IP</span><br><span class="line">address /oaiusercontent.com/解锁机IP</span><br></pre></td></tr></table></figure><p>保存并启动</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable smartdns</span><br><span class="line">systemctl start smartdns</span><br></pre></td></tr></table></figure><h3 id="dns服务器开启dns白名单">DNS服务器开启DNS白名单</h3><p><strong>强烈建议开启DNS白名单，不开启会被别人白嫖，也可能被D哥用作DNS放大攻击</strong></p><h3 id="开启白名单">开启白名单</h3><p>修改下面示例的IP即可。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw allow from 2.2.2.2 to any port 53 proto udp</span><br></pre></td></tr></table></figure><h3 id="被解锁服务器修改dns">被解锁服务器修改DNS</h3><p>修改DNS为解锁机或者DNS服务器的IP。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/resolv.conf</span><br></pre></td></tr></table></figure><h2 id="方案二">方案二</h2><p>在被解锁服务器本地搭建smartdns</p><p>安装步骤和方案一相同，此处不再赘述。</p><p>配置文件有所改变，具体改动为第一行的DNS设置，该设置限制了仅本地可以访问<br>格式示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">bind :53@lo -no-dualstack-selection -no-speed-check #不要动</span><br><span class="line">dualstack-ip-selection no</span><br><span class="line">speed-check-mode none</span><br><span class="line">serve-expired-prefetch-time 21600</span><br><span class="line">prefetch-domain yes</span><br><span class="line">cache-size 32768</span><br><span class="line">cache-persist yes</span><br><span class="line">cache-file /etc/smartdns/cache</span><br><span class="line">prefetch-domain yes</span><br><span class="line">serve-expired yes</span><br><span class="line">serve-expired-ttl 259200</span><br><span class="line">serve-expired-reply-ttl 3</span><br><span class="line">prefetch-domain yes</span><br><span class="line">serve-expired-prefetch-time 21600</span><br><span class="line">cache-checkpoint-time 86400</span><br><span class="line">#force-AAAA-SOA yes</span><br><span class="line">server 210.0.255.250 #默认上游DNS</span><br><span class="line">server 210.0.255.251 #默认上游DNS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ---------- &gt; Global Plaform</span><br><span class="line"># &gt; GPT</span><br><span class="line">address /openai.com/解锁机IP</span><br><span class="line">address /chatgpt.com/解锁机IP</span><br><span class="line">address /oaistatic.com/解锁机IP</span><br><span class="line">address /oaiusercontent.com/解锁机IP</span><br></pre></td></tr></table></figure><h3 id="被解锁服务器修改dns">被解锁服务器修改DNS</h3><p>修改DNS为127.0.0.1</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/resolv.conf</span><br></pre></td></tr></table></figure><h2 id="高级玩法">高级玩法</h2><h3 id="玩法一-嵌套解锁">玩法一 嵌套解锁</h3><p>其实，在某些商家提供DNS解锁的服务器也可以利用本教程给其他服务器提供解锁，就是嵌套解锁（<strong>该行为可能违反TOS</strong>）。<br>借助方案一，使用自建DNS，只需要改一下上游DNS设置和域名对应的DNS设置即可实现。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server 210.0.255.250 #默认上游DNS</span><br><span class="line">server 210.0.255.251 #默认上游DNS</span><br><span class="line">server 此处写商家提供的DNS IP -group dnsproxy -exclude-default-group</span><br><span class="line"></span><br><span class="line"># &gt; Netflix</span><br><span class="line">nameserver /netflix.com/dnsproxy</span><br><span class="line">nameserver /netflix.net/dnsproxy</span><br><span class="line">nameserver /nflximg.com/dnsproxy </span><br><span class="line">nameserver /nflximg.net/dnsproxy</span><br><span class="line">nameserver /nflxvideo.net/dnsproxy </span><br><span class="line">nameserver /nflxext.com/dnsproxy </span><br><span class="line">nameserver /nflxso.net/dnsproxy </span><br></pre></td></tr></table></figure><h3 id="玩法二-自建doh服务器">玩法二 自建DOH服务器</h3><p>某些厂商强制劫持了53端口的UDP流量，导致无论怎么改DNS都无法摆脱商家的解锁服务，此时DOH就派上了用处。<br>DOH简单说就是DNS over HTTPS，通过DOH 走TCP流量使用TLS可以完美绕过DNS劫持。<br>smartdns可以搭建DOH服务器，但是我没搭建成功，so sad。所以仅介绍adguardhome搭建DOH。<br><a href="https://www.nodeseek.com/jump?to=https%3A%2F%2Faoyouer.com%2Fposts%2Fadguardhome-public-dns%2F">具体adguardhome搭建DOH的教程网络已有很多</a>，此处就省去了。搭建过程中，唯一需要注意的是，上游DNS需要写127.0.0.1。<br>被DNS劫持的服务器只需要在smartdns中将默认DNS设置为自己刚建好的DOH地址即可。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server-https https://cloudflare-dns.com/dns-query</span><br></pre></td></tr></table></figure><p>小建议由于TLS三次握手的特性，查询DNS的延迟肯定会提升，建议开启smartdns的缓存功能。</p><h3 id="玩法三-smartdns开启广告过滤">玩法三 smartdns开启广告过滤</h3><p>下载配置文件到/etc/smartdns目录：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://anti-ad.net/anti-ad-for-smartdns.conf -O /etc/smartdns/anti-ad-smartdns.conf</span><br></pre></td></tr></table></figure><p>修改该/etc/smartdns/smartdns.conf文件以包含上述配置文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conf-file /etc/smartdns/anti-ad-smartdns.conf</span><br></pre></td></tr></table></figure><h2 id="扩展聊一聊-与本文主题无关">扩展聊一聊（与本文主题无关）</h2><p>其实直接通过修改系统DNS方式解锁流媒体弊端有很多，常见的弊端比如：DNS服务器宕机导致本地服务无法解析域名、由于厂商分流规则没有细分导致常见CDN 分配的IP在别的地区（常见于akamai的CDN），这时候DNS分流就尤为重要。利用smartdns，可以实现对解锁域名走厂商DNS，对其他域名走公共DNS。举个例子，下面那个配置意思是：DAZN和Hotstar走DNS，其他的全用8.8.8.8解析，这样即使66.66.66.66宕机，本地只要不访问DAZN和Hotstar就不受任何影响。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server 8.8.8.8</span><br><span class="line">server 66.66.66.66（厂商给的dns ip） -group dns -exclude-default-group</span><br><span class="line"></span><br><span class="line"># ---------- &gt; Global Plaform</span><br><span class="line"># &gt; DAZN</span><br><span class="line">nameserver /upos-hz-mirrorakam.akamaized.net/dns</span><br><span class="line"># &gt; Hotstar</span><br><span class="line">nameserver /hotstar.com/dns</span><br></pre></td></tr></table></figure><h2 id="相关项目官网">相关项目官网</h2><p><a href="https://www.nodeseek.com/jump?to=https%3A%2F%2Fgithub.com%2Fxsidc%2Fdnsmasq">sni代理</a><br><a href="https://www.nodeseek.com/jump?to=https%3A%2F%2Fpymumu.github.io%2Fsmartdns">smartdns</a><br><a href="https://www.nodeseek.com/jump?to=https%3A%2F%2Fgithub.com%2FAdguardTeam%2FAdGuardHome">AdGuardHome</a></p><h1 id="流媒体解锁检测">流媒体解锁检测</h1><p>RegionRestrictionCheck 检测脚本检测项目比较全面，且支持Docker运行，杜绝污染VPS服务器，检测流媒体除了主流的Netflix、Disney+、YouTube Premium，还可以支持检测Dazn、Viu TV、4GTV和KKTV等比较冷门的流媒体服务。</p><blockquote><p>支持OS/Platform：CentOS 6+, Ubuntu 14.04+, Debian 8+, MacOS, Android with Termux</p></blockquote><h3 id="使用方法">使用方法</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L -s check.unlock.media)</span><br></pre></td></tr></table></figure><p>只检测IPv4结果:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L -s check.unlock.media) -M 4</span><br></pre></td></tr></table></figure><p>只检测IPv6结果：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L -s check.unlock.media) -M 6</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;流媒体-奈飞-迪斯尼等-一键修改解锁dns脚本&quot;&gt;流媒体（奈飞&amp;amp;迪斯尼等）一键修改解锁DNS脚本&lt;/h1&gt;
&lt;p&gt;&lt;strong&gt;支持操作系统&lt;/strong&gt;: Debian &amp;amp; Ubuntu&lt;/p&gt;
&lt;h3 id=&quot;项目简介&quot;&gt;项目简介&lt;/h3</summary>
      
    
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/tags/%E6%8A%98%E8%85%BE/"/>
    
    <category term="流媒体" scheme="https://blog.lthero.cn/tags/%E6%B5%81%E5%AA%92%E4%BD%93/"/>
    
  </entry>
  
  <entry>
    <title>【自建】建立自己的代理机场</title>
    <link href="https://blog.lthero.cn/2024/11/26/BuildYourOwnProxyhub/"/>
    <id>https://blog.lthero.cn/2024/11/26/BuildYourOwnProxyhub/</id>
    <published>2024-11-26T12:58:48.000Z</published>
    <updated>2024-11-29T07:10:01.394Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://blog.lthero.top/2024/11/26/BuildYourOwnProxyhub/">跳转到搭建hysteria2文章</a></p><p><a href="https://blog.lthero.top/2024/07/18/Install-vless-reality/">跳转到搭建vless-realit文章</a></p><h1 id="自建机场">自建机场</h1><p><strong>声明：本方法建立的机场仅限技术交流，无实际交易教程！</strong></p><p><strong>本方法搭建的机场属于代理直连的方式，非中转机场等高级玩法</strong></p><blockquote><p>先用两句话说明自建机场的逻辑</p><p>1、用<code>Xboard</code>创建机场的前端，<strong>在一台服务器A上部署</strong>即可，用户管理、流量管理等功能全在这上面</p><p>2、使用<code>V2bX</code>创建机场的后端（运行了各种代理服务，如ss, v2ray, hysteria2等）。V2bX会获取节点信息、用户鉴权信息与上报用户流量到服务器A，<strong>V2bX部署在服务器A,B,C,D等</strong></p></blockquote><h2 id="xboard部署教程">Xboard部署教程</h2><h3 id="安装">安装</h3><p>下面是使用Docker-Compose进行部署</p><blockquote><p><strong>仅在服务器A上部署</strong></p><p>Xboard更多安装方式参考：<a href="https://github.com/cedar2025/Xboard">https://github.com/cedar2025/Xboard</a></p></blockquote><p>安装docker</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://get.docker.com | bash</span><br></pre></td></tr></table></figure><p>获取Docker compose 文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone -b  docker-compose --depth 1 https://github.com/cedar2025/Xboard</span><br><span class="line">cd Xboard</span><br></pre></td></tr></table></figure><p>执行数据库安装命令</p><blockquote><p>自动选择 <strong>启用sqlite</strong> 和 <strong>Docker内置的Redis</strong></p><p>修改下面的your_admin_email@example.com 为自己的管理员账号</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose run -it --rm -e enable_sqlite=true -e enable_redis=true -e admin_account=your_admin_email@example.com xboard php artisan xboard:install</span><br></pre></td></tr></table></figure><blockquote><p>手动根据自己的需要在运行时选择sqlite和redis，以及手动输入管理员账号</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose run -it --rm xboard php artisan xboard:install</span><br></pre></td></tr></table></figure><blockquote><p>执行这条命令之后，会返回你的后台地址(asdfasqeb)和管理员账号密码（<strong>你需要记录下来后台地址</strong>）！<br>你需要执行下面的 <strong>启动xborad</strong> 步骤之后才能访问后台</p></blockquote><p>启动Xboard</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure><blockquote><p>安装完成之后即可访问你的站点</p></blockquote><p>访问站点</p><blockquote><p>启动之后网站端口默认为7001, 你可以配置nginx反向代理使用80端口</p></blockquote><p>网站地址: <a href="http://xn--IP-0p3cm89l:7001/">http://你的IP:7001/</a></p><p>后台地址：<a href="http://xn--IP-0p3cm89l:7001/asdfasqeb">http://你的IP:7001/asdfasqeb</a></p><p>在此你已经成功部署了, 你可以访问网址体验Xboard的完整功能，</p><blockquote><p>如果你需要使用mysql，请自行安装Mysql后重新部署</p></blockquote><h3 id="更新"><strong>更新</strong></h3><p>修改版本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd Xboard</span><br><span class="line">vi docker-compose.yaml</span><br></pre></td></tr></table></figure><blockquote><p>修改docker-compose.yaml 当中image后面的版本号为你需要的版本<br>如果为版本为latest 则可以忽略这一步，直接进行第二步</p></blockquote><p>更新数据库（可以执行多次都是安全的）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker compose pull</span><br><span class="line">docker compose down</span><br><span class="line">docker compose run -it --rm xboard php artisan xboard:update</span><br><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure><blockquote><p>即可更新成功</p></blockquote><h3 id="回滚"><strong>回滚</strong></h3><blockquote><p>此回滚不回滚数据库，是否回滚数据库请查看相关文档</p></blockquote><p>回退版本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi docker-compose.yaml</span><br></pre></td></tr></table></figure><blockquote><p>修改docker-compose.yaml 当中image后面的版本号为更新前的版本号</p></blockquote><p>启动</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure><h3 id="注意">注意</h3><p>启用webman后做的任何代码修改都需要重启生效</p><h2 id="xboard添加节点">Xboard添加节点</h2><blockquote><p>在Xboard的管理页面添加节点，在添加节点前，先添加一个订阅服务（金额流量等信息可以随便填写）</p></blockquote><p>这里以配置hysteria2为例，并且是使用自签证书的形式，<a href="http://xn--bing-494f58bbyus1hf9y35i7i9b1o8e.com">所以下面的域名是bing.com</a></p><p>在Xboard里先一个节点</p><ul><li><p>节点名称 ：任意</p></li><li><p>倍率：任意</p></li><li><p>节点地址：<strong>将运行hysteria的服务器</strong>（可以是服务器A,B,C,D等），写公网<strong>IP地址</strong></p></li><li><p>连接端口：选择服务器A（运行了board）上<strong>空闲的端口</strong></p></li><li><p>服务端口：将运行hysteria2的服务器（如B,C,D）中hysteria2进程的端口</p><ul><li><strong>连接端口和服务端口要写一样的，否则无法正常使用</strong>，理论上应该是可以不同的，但可能是bug</li></ul></li><li><p>允许不安全：是</p></li><li><p>协议版本：v2</p></li><li><p>开启obfs：否</p></li><li><p>sni：<a href="http://bing.com">bing.com</a></p><ul><li>如果使用公认证书，请输入指向这台服务器的域名（A,B,C,D等运行hy协议的服务器）</li></ul></li><li><p>上行带宽：100</p></li><li><p>下行带宽：200</p></li><li><p>父节点：无</p></li></ul><p><img src="https://cdn.lthero.cn/post_images/course/ML/image-20241125235329948.png" alt="image-20241125235329948"></p><p>至此，已经完成了前端的工作，后面是将添加的节点进行实际运行起来，<strong>节点的部署</strong>可以运行在不同于服务器A(运行了Xboard)的机器B,C,D上</p><blockquote><p>强烈推荐在部署节点之前，<strong>先配置好https访问</strong>，后面两步是配置https的过程</p></blockquote><ol><li>先配置http访问</li><li>再配置https访问，不要跳过</li></ol><h2 id="使用http访问">使用HTTP访问</h2><p>要将运行在Docker容器中的服务通过域名访问，并使用Nginx作为反向代理来转发到宿主机的7001端口，你需要完成几个步骤。这包括设置DNS记录、配置Nginx以及确保网络安全。下面是具体步骤：</p><h3 id="步骤-1-设置dns记录">步骤 1: 设置DNS记录</h3><p>确保你的域名 <code>board.lthero.top</code> 的DNS记录指向托管Nginx的服务器的IP地址。这通常在你的域名注册商处进行设置：</p><ul><li><strong>A记录</strong>：将域名指向IPv4地址。</li><li><strong>AAAA记录</strong>：将域名指向IPv6地址（如果适用）。</li></ul><h3 id="步骤-2-安装并启动nginx">步骤 2: 安装并启动Nginx</h3><p>步骤 1: 更新软件包列表</p><p>打开终端，首先使用<code>apt</code>命令更新你的包列表，以确保你安装的是最新版本的Nginx。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure><p>步骤 2: 安装Nginx</p><p>使用<code>apt</code>安装Nginx。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure><h3 id="步骤-3-配置nginx">步骤 3: 配置Nginx</h3><p>你需要在Nginx中创建一个新的服务器块（server block），或者在已有的默认配置中修改，以设置反向代理。以下是一个基本的Nginx配置示例，将会把所有到 <code>board.lthero.top</code> 的请求转发到本地的7001端口：</p><ol><li><p>打开或创建一个新的Nginx配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-available/board.lthero.top</span><br></pre></td></tr></table></figure></li><li><p>添加以下配置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> board.lthero.top;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:7001;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&#x27;upgrade&#x27;</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个配置做了以下几点：</p><ul><li><code>listen 80;</code> 告诉Nginx监听80端口（HTTP标准端口）。</li><li><code>server_name board.lthero.top;</code> 设置这个块应当响应的域名。</li><li><code>proxy_pass http://localhost:7001;</code> 指定所有传入的请求转发到本地的7001端口。</li><li><code>proxy_set_header</code> 指令将重要的HTTP头信息转发给后端应用。</li></ul></li><li><p>启用配置文件通过创建一个符号链接：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -s /etc/nginx/sites-available/board.lthero.top /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure></li><li><p>检查Nginx配置文件是否有语法错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br></pre></td></tr></table></figure></li><li><p>如果没有错误，重启Nginx以应用配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure></li></ol><h3 id="步骤-4-调整防火墙规则">步骤 4: 调整防火墙规则</h3><p>确保你的服务器的防火墙规则允许HTTP（端口80）和HTTPS（端口443，如果你使用SSL）的流量。如果你正在使用<code>ufw</code>，可以使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow <span class="string">&#x27;Nginx Full&#x27;</span></span><br><span class="line">sudo ufw reload</span><br></pre></td></tr></table></figure><h3 id="步骤-5-测试配置">步骤 5: 测试配置</h3><p>在浏览器中输入 <code>http://board.lthero.top</code> 或使用命令行工具如 <code>curl</code> 来测试你的配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://board.lthero.top</span><br></pre></td></tr></table></figure><p>你应该能看到从Docker容器中运行的服务响应的内容。</p><p>这样，你就配置好了Nginx作为反向代理，将域名 <code>board.lthero.top</code> 的流量转发到宿主机的7001端口上的服务。如果你希望使用HTTPS，你还需要设置SSL证书，可以考虑使用Let’s Encrypt免费证书并配置HTTPS。</p><h2 id="使用https访问">使用HTTPS访问</h2><p>要让你的域名 <code>board.lthero.top</code> 使用 HTTPS，你需要获取 SSL/TLS 证书，并配置 Nginx 以使用这些证书来加密网页内容。以下是详细的步骤，包括如何使用 Let’s Encrypt 提供的免费证书自动化这个过程。</p><h3 id="步骤-1-安装-certbot">步骤 1: 安装 Certbot</h3><p>Certbot 是一个自动获取并安装 Let’s Encrypt 证书的客户端。在 Ubuntu 上安装 Certbot 及其 Nginx 插件非常简单：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install certbot python3-certbot-nginx -y</span><br></pre></td></tr></table></figure><h3 id="步骤-2-获取和安装证书">步骤 2: 获取和安装证书</h3><p>使用 Certbot 获取并为你的域名安装证书：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot --nginx -d board.lthero.top</span><br></pre></td></tr></table></figure><p>此命令会自动为指定的域名 <code>board.lthero.top</code> 配置 SSL 证书，并更新 Nginx 配置以使用这些证书。</p><p>Certbot 会询问你一些问题，比如电子邮件地址（用于紧急联系和证书续订提醒）</p><p>以及<strong>是否重定向所有 HTTP 请求到 HTTPS（强烈建议启用）</strong>，如果启用，它用自动修改board.lthero.top的nginx配置文件，</p><p>生成的证书位置<code>/etc/letsencrypt/live/</code></p><h3 id="步骤-3-更新-nginx-配置">步骤 3: 更新 Nginx 配置</h3><p>如果你想手动编辑 Nginx 配置文件，可以按以下方式配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-available/board.lthero.top</span><br></pre></td></tr></table></figure><ol><li>如果你的配置文件里已经出现“# managed by Certbot”等内容，说明Certbot已经将配置文件修改好了，直接重启nginx即可</li><li>记得将下面所有的board.lthero.top换成你的域名</li><li>这里的7001端口是Xboard运行端口</li></ol><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> board.lthero.top;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:7001;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&#x27;upgrade&#x27;</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/board.lthero.top/fullchain.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/board.lthero.top/privkey.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">include</span> /etc/letsencrypt/options-ssl-nginx.conf; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_dhparam</span> /etc/letsencrypt/ssl-dhparams.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$host</span> = board.lthero.top) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> board.lthero.top;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">404</span>; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-4-重新加载-nginx">步骤 4: 重新加载 Nginx</h3><p>更改配置后，需要重新加载 Nginx 以应用新的配置：</p><blockquote><p>检查配置文件是否有语法错误，如果有warn!直接看“遇到的问题”部分，重新加载配置是不一定能work的</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t  <span class="comment"># 检查配置文件是否有语法错误</span></span><br><span class="line">sudo systemctl reload nginx  <span class="comment"># 重新加载配置</span></span><br><span class="line"><span class="comment"># 如果重新加载配置后无效，可以尝试重启nginx</span></span><br><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure><h3 id="步骤-5-验证-https">步骤 5: 验证 HTTPS</h3><p>在浏览器中访问 <code>https://board.lthero.top</code> 来检查是否配置成功。你应该能够看到一个安全锁标志，表明连接是通过 HTTPS 加密的。</p><h3 id="步骤-6-自动续订证书">步骤 6: 自动续订证书</h3><p>Let’s Encrypt 的证书有效期为90天，因此建议设置自动续订：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot renew</span><br></pre></td></tr></table></figure><p>这个命令会测试证书续订过程。如果这个测试成功，添加定时任务<code>crontab</code>：</p><p><code>crontab -e</code>再填写下面内容，表示每月第一天会自动执行</p><p>通过<code>which certbot</code>查看具体程序位置<code>/usr/local/bin/certbot</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1 * * /usr/local/bin/certbot renew --deploy-hook <span class="string">&quot;nginx -s reload&quot;</span></span><br></pre></td></tr></table></figure><p>续签的证书位置<code>/etc/letsencrypt/renewal</code></p><p>通过以上步骤，你的站点 <code>board.lthero.top</code> 现在应该能够安全地使用 HTTPS 进行通信了。</p><p>如果要换crontab编辑器，运行下面的命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select-editor</span><br></pre></td></tr></table></figure><p>至此，已经配置好https访问，下面开始<strong>部署代理服务</strong></p><hr><h2 id="v2bx部署代理服务">V2bX部署代理服务</h2><blockquote><p>在需要**运行节点的服务器（A,B,C,D等）**上安装V2bX，从而运行hysteria2, v2ray, vless, ss等协议</p><p>在V2bX上运行的代理协议可对接到Xboard上，会将用户使用情况上传到Xboard上并统计</p><p>视频参考：<a href="https://youtu.be/Fwn0nFbB0zY?t=720">https://youtu.be/Fwn0nFbB0zY?t=720</a></p></blockquote><h3 id="v2bx安装">V2bX安装</h3><p>执行下面的命令，安装V2bX</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -N https://raw.githubusercontent.com/wyx2685/V2bX-script/master/install.sh &amp;&amp; bash install.sh</span><br></pre></td></tr></table></figure><p>配置文件路径：<code>/etc/V2bX</code> 配置文件详见：<a href="https://v2bx.v-50.me/v2bx/v2bx-pei-zhi-wen-jian-shuo-ming/config">配置文件说明</a></p><p>下面是在<strong>服务器B</strong>上运行hysteria2协议的配置过程</p><ul><li><p>输入机场网址与API Key</p><ul><li>机场网址就是域名https://board.lthero.top，而API key在Xboard的管理网页中，找到“系统配置”-&gt;“节点”-&gt;“通讯密钥”</li><li>原理是V2bX拿着密钥，到board.lthero.top上面获取你配置的节点的信息；根据这些节点信息，V2bX在服务器(A,B,C,D)上运行服务（如hysteria2协议，Vless协议等）</li></ul></li><li><p>选择核心：<strong>singbox</strong> 对应的序号</p></li><li><p>选择协议：<strong>hysteria2</strong> 对应的序号</p></li><li><p>证书模式：<strong>self模式</strong> 对应的序号</p><ul><li>如果使用公认证书，请使用<strong>http模式</strong>，你需要解析一个域名到这个<strong>服务器B的节点服务</strong>，如：hy-jp-b.lthero.top</li><li>如果你仍然使用<strong>服务器A</strong>运行节点，请不要使用board.lthero.top，请重新配置一条域名解析到<strong>节点服务</strong>,如：，如：hy-jp-a.lthero.top</li></ul></li><li><p>输入节点证书域名：<strong><a href="http://bing.com">bing.com</a></strong></p><ul><li>如果使用公认证书，请输入指向这台VPS的域名</li></ul></li><li><p>输入n退出（除非想添加其它协议）</p></li></ul><p><img src="https://cdn.lthero.cn/post_images/course/ML/image-20241125235810854.png" alt="image-20241125235810854"></p><p>随后，输入 <code>V2bX</code> 查看V2bX的配置或修改配置文件，<strong>每次修改配置文件后V2bX会自动重启</strong></p><p>这里吐槽一句啊，它只能初始化的时候使用交互方式进行文件配置，后续只能手动修改配置文件，对新手不友好。</p><p>如果想重新使用交互方式，只能将V2bX卸载后重装。</p><h3 id="hysteria2自签证书的配置文件">hysteria2自签证书的配置文件</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Output&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Cores&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sing&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Timestamp&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;NTP&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Enable&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time.apple.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ServerPort&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;OriginalPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/V2bX/sing_origin.json&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Core&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sing&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ApiHost&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://xxx.lthero.top&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ApiKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;NodeID&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;NodeType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hysteria2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Timeout&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ListenIP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;::&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;SendIP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;DeviceOnlineMinTraffic&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;TCPFastOpen&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;SniffEnabled&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;CertConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;CertMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;self&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;RejectUnknownSni&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;CertDomain&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bing.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;CertFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/V2bX/fullchain.cer&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;KeyFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/V2bX/cert.key&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;Email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v2bx@github.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;Provider&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cloudflare&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;DNSEnv&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;EnvName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;env1&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="hysteria2使用证书">hysteria2使用证书</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;Nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Core&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sing&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ApiHost&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://board.lthero.top&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ApiKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;NodeID&quot;</span><span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;NodeType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hysteria2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Timeout&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ListenIP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;::&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;SendIP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;DeviceOnlineMinTraffic&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;TCPFastOpen&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;SniffEnabled&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;CertConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;CertMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;RejectUnknownSni&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">                <span class="comment">//唯一的区别是，这里写解析到节点服务的域名</span></span><br><span class="line">                <span class="attr">&quot;CertDomain&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ak-jp.lthero.top&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;CertFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/V2bX/fullchain.cer&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;KeyFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/V2bX/cert.key&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;Email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v2bx@github.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;Provider&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cloudflare&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;DNSEnv&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;EnvName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;env1&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><hr><h2 id="其它对接xboard的工具">其它对接Xboard的工具</h2><p>除了V2bX，还有个对接Xboard的工具：</p><p><a href="https://github.com/FireinRainLab/hysteria-v2board">https://github.com/FireinRainLab/hysteria-v2board</a></p><p><a href="https://github.com/cedar2025/hysteria">https://github.com/cedar2025/hysteria</a></p><p>这工具是将hysteria2打包到docker中，并且将用户使用数据对接到Xboard/V2board</p><h1 id="蒸蒸日上的工具">蒸蒸日上的工具</h1><h2 id="一键抢主机脚本">一键抢主机脚本</h2><p><a href="https://chromewebstore.google.com/detail/one-click-checkout-for-wh/">https://chromewebstore.google.com/detail/one-click-checkout-for-wh/</a></p><p>支持 * RackNerd * SpartanHost * GreenCloudVPS</p><h2 id="主机全方面测试">主机全方面测试</h2><blockquote><p>包含主机cpu性能、磁盘测试、流媒体解锁测试、速度及延迟测试等</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://github.com/spiritLHLS/ecs/raw/main/ecs.sh -o ecs.sh &amp;&amp; <span class="built_in">chmod</span> +x ecs.sh &amp;&amp; bash ecs.sh</span><br></pre></td></tr></table></figure><p>工具来源：<a href="https://digvps.com/tools/ecs">https://digvps.com/tools/ecs</a></p><h2 id="流媒体解锁检测">流媒体解锁检测</h2><p>RegionRestrictionCheck 检测脚本检测项目比较全面，且支持Docker运行，杜绝污染VPS服务器，检测流媒体除了主流的Netflix、Disney+、YouTube Premium，还可以支持检测Dazn、Viu TV、4GTV和KKTV等比较冷门的流媒体服务。</p><blockquote><p>支持OS/Platform：CentOS 6+, Ubuntu 14.04+, Debian 8+, MacOS, Android with Termux</p></blockquote><h3 id="使用方法">使用方法</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L -s check.unlock.media)</span><br></pre></td></tr></table></figure><p>只检测IPv4结果:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L -s check.unlock.media) -M 4</span><br></pre></td></tr></table></figure><p>只检测IPv6结果：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L -s check.unlock.media) -M 6</span><br></pre></td></tr></table></figure><h2 id="部分测试结果">部分测试结果</h2><h3 id="do">DO</h3><p>美国SF-1c2g</p><p><a href="https://paste.spiritlhl.net/code/K1XMh0.txt">https://paste.spiritlhl.net/code/K1XMh0.txt</a></p><h3 id="racknerd">RackNerd</h3><p>美国LA-1c2g</p><p><a href="https://paste.spiritlhl.net/code/ECrxxe.txt">https://paste.spiritlhl.net/code/ECrxxe.txt</a></p><p>美国LA-2c2.5g</p><p><a href="https://paste.spiritlhl.net/code/dKstV2.txt">https://paste.spiritlhl.net/code/dKstV2.txt</a></p><p>美国LA-黑五闪够 2c2g</p><p><a href="https://paste.spiritlhl.net/code/t9bdNE.txt">https://paste.spiritlhl.net/code/t9bdNE.txt</a></p><h3 id="akile">Akile</h3><p>美国LA-1c1g</p><p><a href="https://paste.spiritlhl.net/code/GWNS6v.txt">https://paste.spiritlhl.net/code/GWNS6v.txt</a></p><h3 id="vkvm">vkvm</h3><p>美国LA-2c4g</p><p><a href="https://paste.spiritlhl.net/u/9taqwb.txt">https://paste.spiritlhl.net/u/9taqwb.txt</a></p><p>vkvm家的不大行，超售，导致机器实际性能与纸上数据相差非常大；</p><p>Akile的跑分不错，实际测试性能还行，至少一边运行docker并上传一个500MB文件，另一边使用hy2看4k视频能到9万分；</p><p>Racknerd和DO的，主打个内存大，但cpu性能一般；</p><h1 id="遇到的问题">遇到的问题</h1><h2 id="用户订阅链接无输出">用户订阅链接无输出</h2><p>如果所有节点都是hysteria2协议，会出现订阅链接输出是空白；此时直接在pc端导入到clash是正常的</p><p>尝试添加如vless协议的节点，但在安卓、苹果端仍然无法直接导入hysteria2协议</p><h2 id="数据迁移">数据迁移</h2><p>数据库位置：/root/Xboard/.docker/.data/database.sqlite</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://blog.lthero.top/2024/11/26/BuildYourOwnProxyhub/&quot;&gt;跳转到搭建hysteria2文章&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://blog.lthero.top/2024/07/1</summary>
      
    
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/tags/%E6%8A%98%E8%85%BE/"/>
    
    <category term="代理" scheme="https://blog.lthero.cn/tags/%E4%BB%A3%E7%90%86/"/>
    
    <category term="vps" scheme="https://blog.lthero.cn/tags/vps/"/>
    
    <category term="机场" scheme="https://blog.lthero.cn/tags/%E6%9C%BA%E5%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>在线文件共享平台</title>
    <link href="https://blog.lthero.cn/2024/11/24/OnlineFileSharing/"/>
    <id>https://blog.lthero.cn/2024/11/24/OnlineFileSharing/</id>
    <published>2024-11-24T09:34:49.000Z</published>
    <updated>2024-11-27T08:23:57.073Z</updated>
    
    <content type="html"><![CDATA[<h1 id="在线文件共享平台">在线文件共享平台</h1><blockquote><p>提供短时/长期（类似蓝奏云）的文件分享，无文件类型限制</p></blockquote><h1 id="项目安装">项目安装</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/stonith404/pingvin-share.git</span><br><span class="line"><span class="built_in">cd</span> pingvin-share</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据实际需求，修改映射端口等，如映射到宿主机的3001端口</span></span><br><span class="line"><span class="comment"># vim docker-compose.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行</span></span><br><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure><h1 id="使用http访问">使用HTTP访问</h1><p>要将运行在Docker容器中的服务通过域名访问，并使用Nginx作为反向代理来转发到宿主机的3001端口，你需要完成几个步骤。这包括设置DNS记录、配置Nginx以及确保网络安全。下面是具体步骤：</p><h2 id="步骤-1-设置dns记录">步骤 1: 设置DNS记录</h2><p>确保你的域名 <code>fs.lthero.top</code> 的DNS记录指向托管Nginx的服务器的IP地址。这通常在你的域名注册商处进行设置：</p><ul><li><strong>A记录</strong>：将域名指向IPv4地址。</li><li><strong>AAAA记录</strong>：将域名指向IPv6地址（如果适用）。</li></ul><h2 id="步骤-2-安装并启动nginx">步骤 2: 安装并启动Nginx</h2><p>步骤 1: 更新软件包列表</p><p>打开终端，首先使用<code>apt</code>命令更新你的包列表，以确保你安装的是最新版本的Nginx。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure><p>步骤 2: 安装Nginx</p><p>使用<code>apt</code>安装Nginx。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure><h2 id="步骤-3-配置nginx">步骤 3: 配置Nginx</h2><p>你需要在Nginx中创建一个新的服务器块（server block），或者在已有的默认配置中修改，以设置反向代理。以下是一个基本的Nginx配置示例，将会把所有到 <code>fs.lthero.top</code> 的请求转发到本地的3001端口：</p><ol><li><p>打开或创建一个新的Nginx配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-available/fs.lthero.top</span><br></pre></td></tr></table></figure></li><li><p>添加以下配置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> fs.lthero.top;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:3001;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&#x27;upgrade&#x27;</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个配置做了以下几点：</p><ul><li><code>listen 80;</code> 告诉Nginx监听80端口（HTTP标准端口）。</li><li><code>server_name fs.lthero.top;</code> 设置这个块应当响应的域名。</li><li><code>proxy_pass http://localhost:3001;</code> 指定所有传入的请求转发到本地的3001端口。</li><li><code>proxy_set_header</code> 指令将重要的HTTP头信息转发给后端应用。</li></ul></li><li><p>启用配置文件通过创建一个符号链接：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -s /etc/nginx/sites-available/fs.lthero.top /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure></li><li><p>检查Nginx配置文件是否有语法错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br></pre></td></tr></table></figure></li><li><p>如果没有错误，重启Nginx以应用配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure></li></ol><h2 id="步骤-4-调整防火墙规则">步骤 4: 调整防火墙规则</h2><p>确保你的服务器的防火墙规则允许HTTP（端口80）和HTTPS（端口443，如果你使用SSL）的流量。如果你正在使用<code>ufw</code>，可以使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow <span class="string">&#x27;Nginx Full&#x27;</span></span><br><span class="line">sudo ufw reload</span><br></pre></td></tr></table></figure><h2 id="步骤-5-测试配置">步骤 5: 测试配置</h2><p>在浏览器中输入 <code>http://fs.lthero.top</code> 或使用命令行工具如 <code>curl</code> 来测试你的配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://fs.lthero.top</span><br></pre></td></tr></table></figure><p>你应该能看到从Docker容器中运行的服务响应的内容。</p><p>这样，你就配置好了Nginx作为反向代理，将域名 <code>fs.lthero.top</code> 的流量转发到宿主机的3001端口上的服务。如果你希望使用HTTPS，你还需要设置SSL证书，可以考虑使用Let’s Encrypt免费证书并配置HTTPS。</p><h1 id="使用https访问">使用HTTPS访问</h1><p>要让你的域名 <code>fs.lthero.top</code> 使用 HTTPS，你需要获取 SSL/TLS 证书，并配置 Nginx 以使用这些证书来加密网页内容。以下是详细的步骤，包括如何使用 Let’s Encrypt 提供的免费证书自动化这个过程。</p><h2 id="步骤-1-安装-certbot">步骤 1: 安装 Certbot</h2><p>Certbot 是一个自动获取并安装 Let’s Encrypt 证书的客户端。在 Ubuntu 上安装 Certbot 及其 Nginx 插件非常简单：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install certbot python3-certbot-nginx -y</span><br></pre></td></tr></table></figure><h2 id="步骤-2-获取和安装证书">步骤 2: 获取和安装证书</h2><p>使用 Certbot 获取并为你的域名安装证书：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot --nginx -d fs.lthero.top</span><br></pre></td></tr></table></figure><p>此命令会自动为指定的域名 <code>fs.lthero.top</code> 配置 SSL 证书，并更新 Nginx 配置以使用这些证书。Certbot 会询问你一些问题，比如电子邮件地址（用于紧急联系和证书续订提醒），以及是否重定向所有 HTTP 请求到 HTTPS（强烈建议启用）。</p><p>生成的证书位置<code>/etc/letsencrypt/live/</code></p><h2 id="步骤-3-更新-nginx-配置">步骤 3: 更新 Nginx 配置</h2><p>如果你想手动编辑 Nginx 配置文件，可以按以下方式配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-available/fs.lthero.top</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    server_name fs.lthero.top;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://localhost:3001;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection &#x27;upgrade&#x27;;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_cache_bypass $http_upgrade;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    listen 443 ssl; # managed by Certbot</span><br><span class="line">    ssl_certificate /etc/letsencrypt/live/fs.lthero.top/fullchain.pem; # managed by Certbot</span><br><span class="line">    ssl_certificate_key /etc/letsencrypt/live/fs.lthero.top/privkey.pem; # managed by Certbot</span><br><span class="line">    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot</span><br><span class="line">    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    if ($host = fs.lthero.top) &#123;</span><br><span class="line">        return 301 https://$host$request_uri;</span><br><span class="line">    &#125; # managed by Certbot</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    listen 80;</span><br><span class="line">    server_name fs.lthero.top;</span><br><span class="line">    return 404; # managed by Certbot</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> fs.lthero.top;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;  <span class="comment"># 强制重定向所有 HTTP 请求到 HTTPS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span> fs.lthero.top;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/fs.lthero.top/fullchain.pem;  <span class="comment"># 证书文件路径</span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/fs.lthero.top/privkey.pem;  <span class="comment"># 私钥文件路径</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">1d</span>;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:MozSSL:<span class="number">10m</span>;  <span class="comment"># 缓存 SSL 会话以提升性能</span></span><br><span class="line">    <span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 现代加密套件配置</span></span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> <span class="string">&#x27;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384&#x27;</span>;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 其他 SSL 优化设置</span></span><br><span class="line">    <span class="attribute">ssl_stapling</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">ssl_stapling_verify</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 允许最大请求体大小为 1000MB</span></span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">1000m</span>;  </span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:3001;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&#x27;upgrade&#x27;</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个配置不仅启用了 HTTPS，还包括了一些现代的安全实践，如启用 HTTP/2，配置加密套件和协议等。</p><blockquote><p>允许最大请求体大小为 1000MB</p><p>client_max_body_size 1000m;</p><p>这行最好与config.js中保持一致，如果<strong>nginx设置小了，会出现“上传失败”的结果！</strong></p></blockquote><h2 id="步骤-4-重新加载-nginx">步骤 4: 重新加载 Nginx</h2><p>启用配置文件通过创建一个符号链接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -s /etc/nginx/sites-available/fs.lthero.top /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure><p>更改配置后，需要重新加载 Nginx 以应用新的配置：</p><blockquote><p>检查配置文件是否有语法错误，如果有warn!直接看“遇到的问题”部分，重新加载配置是不一定能work的</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t  <span class="comment"># 检查配置文件是否有语法错误</span></span><br><span class="line">sudo systemctl reload nginx  <span class="comment"># 重新加载配置</span></span><br><span class="line"><span class="comment"># 如果重新加载配置后无效，可以尝试重启nginx</span></span><br><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure><h2 id="步骤-5-验证-https">步骤 5: 验证 HTTPS</h2><p>在浏览器中访问 <code>https://fs.lthero.top</code> 来检查是否配置成功。你应该能够看到一个安全锁标志，表明连接是通过 HTTPS 加密的。</p><h2 id="步骤-6-自动续订证书">步骤 6: 自动续订证书</h2><p>Let’s Encrypt 的证书有效期为90天，因此建议设置自动续订：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot renew</span><br></pre></td></tr></table></figure><p>这个命令会测试证书续订过程。如果这个测试成功，添加定时任务<code>crontab</code>：</p><p><code>crontab -e</code>再填写下面内容，表示每月第一天会自动执行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1 * * /usr/local/bin/certbot renew --deploy-hook <span class="string">&quot;nginx -s reload&quot;</span></span><br></pre></td></tr></table></figure><p>通过<code>which certbot</code>查看具体程序位置<code>/usr/local/bin/certbot</code></p><p>续签的证书位置<code>/etc/letsencrypt/renewal</code></p><p>通过以上步骤，你的站点 <code>fs.lthero.top</code> 现在应该能够安全地使用 HTTPS 进行通信了。</p><p>如果要换crontab编辑器，运行下面的命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select-editor</span><br></pre></td></tr></table></figure><h2 id="解析到阿里云dns的申请方法">解析到阿里云DNS的申请方法</h2><blockquote><p>如果域名解析在阿里云，可以安装这个插件从而完成证书申请，<a href="https://github.com/tengattack/certbot-dns-aliyun">https://github.com/tengattack/certbot-dns-aliyun</a></p></blockquote><h3 id="credentials-file">Credentials File</h3><p>在某个熟悉的目录下，把下面的内容写入<code>credentials.ini</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dns_aliyun_access_key = 12345678</span><br><span class="line">dns_aliyun_access_key_secret = 1234567890abcdef1234567890abcdef</span><br></pre></td></tr></table></figure><p>dns_aliyun_access_key是阿里云账号的AccessKey ID</p><p>dns_aliyun_access_key_secret是阿里云账号的AccessKey Secret</p><p>这两个值可以在阿里云控制台-&gt;用户头像-&gt;accesskeys按指引获取AccessKey/SecretKey</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 600 /path/to/credentials.ini</span><br></pre></td></tr></table></figure><h3 id="obtain-certificates">Obtain Certificates</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">certbot certonly \</span><br><span class="line">    --authenticator=dns-aliyun \</span><br><span class="line">    --dns-aliyun-credentials=<span class="string">&#x27;/path/to/credentials.ini&#x27;</span> \</span><br><span class="line">    -d <span class="string">&quot;*.example.com,example.com&quot;</span></span><br></pre></td></tr></table></figure><p>申请下来的证书位置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/letsencrypt/archive/</span><br></pre></td></tr></table></figure><p>适合阿里云的自动命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1 * * /usr/local/bin/certbot renew --manual --preferred-challenges dns --manual-auth-hook <span class="string">&quot;alidns&quot;</span> --manual-cleanup-hook <span class="string">&quot;alidns clean&quot;</span> --deploy-hook <span class="string">&quot;nginx -s reload&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;在线文件共享平台&quot;&gt;在线文件共享平台&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;提供短时/长期（类似蓝奏云）的文件分享，无文件类型限制&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;项目安装&quot;&gt;项目安装&lt;/h1&gt;
&lt;figure class=&quot;highlig</summary>
      
    
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/tags/%E6%8A%98%E8%85%BE/"/>
    
  </entry>
  
  <entry>
    <title>【PPT】生成高清的PDF格式矢量图片</title>
    <link href="https://blog.lthero.cn/2024/11/22/CreateHighResolutionPic/"/>
    <id>https://blog.lthero.cn/2024/11/22/CreateHighResolutionPic/</id>
    <published>2024-11-22T05:46:43.000Z</published>
    <updated>2024-11-26T13:04:38.968Z</updated>
    
    <content type="html"><![CDATA[<h2 id="步骤">步骤</h2><p>1、新建个PPT（如：export.pptx），在PPT的“设计”-&gt;“幻灯片大小”改成“自定义”，宽度,高度：100cm</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/image-20241122134900256.png" alt="image-20241122134900256"></p><p>2、将原来的PPT（包含构架图）一整页直接复制到export.pptx中</p><p>3、选择“文件”-&gt;“导出”-&gt;“导出为pdf”（这里有个“选项”，可以选择导出到具体的某页）</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/image-20241122140000983.png" alt="image-20241122140000983"></p><p><img src="https://cdn.lthero.cn/post_images/course/ML/image-20241122140030833.png" alt="image-20241122140030833"></p><p>4、导出为pdf后，使用“编辑”功能中的“裁剪”，对图像进行裁剪并保存。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;步骤&quot;&gt;步骤&lt;/h2&gt;
&lt;p&gt;1、新建个PPT（如：export.pptx），在PPT的“设计”-&amp;gt;“幻灯片大小”改成“自定义”，宽度,高度：100cm&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn.lthero.cn/post_images/c</summary>
      
    
    
    
    <category term="技巧" scheme="https://blog.lthero.cn/categories/%E6%8A%80%E5%B7%A7/"/>
    
    
    <category term="技巧" scheme="https://blog.lthero.cn/tags/%E6%8A%80%E5%B7%A7/"/>
    
    <category term="PPT" scheme="https://blog.lthero.cn/tags/PPT/"/>
    
  </entry>
  
  <entry>
    <title>GetSSLforWebsite</title>
    <link href="https://blog.lthero.cn/2024/08/19/GetSSLforWebsite/"/>
    <id>https://blog.lthero.cn/2024/08/19/GetSSLforWebsite/</id>
    <published>2024-08-19T10:40:40.000Z</published>
    <updated>2024-08-19T10:46:50.651Z</updated>
    
    <content type="html"><![CDATA[<h2 id="宝塔">宝塔</h2><p>在宝塔网络管理，选择<strong>DNS验证</strong>，手动解析<strong>阿里云DNS</strong>，设置密钥后自动申请即可</p><h2 id="阿里云平台">阿里云平台</h2><p>搜索：数字证书管理服务</p><p>在SSL证书管理中，可以申请免费的DigiCert证书，时效三个月，好处是对于部署在阿里云的cdn服务，在申请证书后，平台会自动更新cdn相关服务。</p><h2 id="certbot自动">certbot自动</h2><h3 id="安装certbot和阿里云dns插件">安装certbot和阿里云DNS插件</h3><p>安装步骤在<a href="https://certbot.eff.org/">certbot (opens new window)</a>的官网上有，而且很详细。但最大的问题是，官网上的安装方法要求使用snapd，而七牛云服务器（实际上是阿里云服务器）并不支持snapd，所以需要使用yum安装。</p><h4 id="安装手动申请证书所需工具">安装手动申请证书所需工具</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install certbot</span><br></pre></td></tr></table></figure><h4 id="安装自动续期证书所需工具">安装自动续期证书所需工具</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt install certbot python3-certbot-nginx</span><br><span class="line">pip3 install certbot-dns-aliyun</span><br><span class="line">pip3 install certbot-nginx</span><br></pre></td></tr></table></figure><h3 id="申请证书">申请证书</h3><h4 id="手动申请证书">手动申请证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certbot -d *.sunxiaolong.net -d sunxiaolong.net --manual certonly</span><br></pre></td></tr></table></figure><p>这个<code>--manual</code>参数很重要，如果没有这个参数，就必须得用dns插件了~<br>随后会有提示，给域名添加一个TXT解析，按照提示去域名解析控制台添加对应记录。这里一定要注意这个解析记录不要区分大陆还是海外线路，否则可能会失败。<br>解析记录添加完成后，回到命令行按下回车键。<br>证书和私钥文件会保存到<code>/etc/letsenctypt/live</code>下，命令行上有回显。</p><h4 id="自动申请证书">自动申请证书</h4><p>将阿里云DNS的key写到本地，格式如下：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dns_aliyun_access_key</span>=<span class="string">*******</span></span><br><span class="line"><span class="attr">dns_aliyun_access_key_secret</span>=<span class="string">******</span></span><br></pre></td></tr></table></figure><p>随后保存到服务器上，如<code>/opt/cert/aliyun-dns.conf</code>。access_key和access_key_secret是阿里云的多用户访问控制中相应用户的key和secret。</p><ol start="2"><li>签发证书</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certbot certonly --authenticator=dns-aliyun --dns-aliyun-credentials=&#x27;/opt/cert/aliyun-dns.conf&#x27; -d &quot;*.sunxiaolong.net,sunxiaolong.net&quot;</span><br></pre></td></tr></table></figure><p>然后就签发成功了～证书位置可以看回显，确认配置没错之后，reload一下nginx就可以了。</p><h3 id="修改nginx配置">修改nginx配置</h3><p>将nginx配置中对应域名的证书和私钥文件路径指定到certbot回显的路径上。</p><h3 id="reload-nginx">reload nginx</h3><p>重新加载nginx即可生效</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">NGINX_HOME/sbin/nginx -s reload</span></span><br></pre></td></tr></table></figure><h3 id="验证是否生效">验证是否生效</h3><p>重新打开对应的HTTPS站点，不再提示证书不安全，且证书过期时间和certbot命令行回显能对应上即为成功。</p><h3 id="配置自动续期">配置自动续期</h3><h4 id="手动续期">手动续期</h4><p>待证书要过期，执行<code>certbot renew</code>，再reload nginx即可。</p><h4 id="自动续期">自动续期</h4><p>编辑crontab</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br></pre></td></tr></table></figure><p>添加记录，<code>0 0 1 * * /root/renew-cert.sh</code>，表示每月1日0点执行续期脚本。</p><p>编写续期脚本 <code>/root/renew-cert.sh</code>的内容如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">certbot certonly -n --authenticator=dns-aliyun --dns-aliyun-credentials=&#x27;/opt/cert/aliyun-dns.conf&#x27; -d &quot;*.sunxiaolong.net,sunxiaolong.net&quot;</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure><p>重新加载crond服务。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service crond reload</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;宝塔&quot;&gt;宝塔&lt;/h2&gt;
&lt;p&gt;在宝塔网络管理，选择&lt;strong&gt;DNS验证&lt;/strong&gt;，手动解析&lt;strong&gt;阿里云DNS&lt;/strong&gt;，设置密钥后自动申请即可&lt;/p&gt;
&lt;h2 id=&quot;阿里云平台&quot;&gt;阿里云平台&lt;/h2&gt;
&lt;p&gt;搜索：数字证书管理服务</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>【vless-reality】安装</title>
    <link href="https://blog.lthero.cn/2024/07/18/Install-vless-reality/"/>
    <id>https://blog.lthero.cn/2024/07/18/Install-vless-reality/</id>
    <published>2024-07-18T07:26:50.000Z</published>
    <updated>2024-07-18T08:20:50.823Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>官方说法是 REALITY 可以<strong>消除服务端 TLS 指纹特征</strong>，同时保留前向保密性等功能，证书链攻击也无效，安全性超越了常规的 TLS。还有个优点是 REALITY <strong>可以指向别人的网站，无需自己购买域名和配置 TLS 服务端</strong>，通俗来说就是伪装性和便捷性都得到了提升。</p></blockquote><h1 id="一键安装脚本">一键安装脚本</h1><blockquote><p>本文参考：<a href="https://oooutman.github.io/reality-v2ray/">https://oooutman.github.io/reality-v2ray/</a></p><p>下面这个安装脚本，默认使用“无需域名”的方法</p><p>如果需要设置自己的域名，可以使用另一个脚本：<a href="https://www.v2ray-agent.com/archives/1680104902581">https://www.v2ray-agent.com/archives/1680104902581</a></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate -O $&#123;HOME&#125;/Xray-script.sh https://raw.githubusercontent.com/zxcvos/Xray-script/main/reality.sh &amp;&amp; bash $&#123;HOME&#125;/Xray-script.sh</span><br></pre></td></tr></table></figure><p>复制上面👆一整行命令运行后会出现如下👇安装向导，有各种选项设置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">--------------- Xray-script ---------------</span><br><span class="line"> Version      : v2023-03-15(beta)</span><br><span class="line"> Description  : Xray 管理脚本</span><br><span class="line">----------------- 装载管理 ----------------</span><br><span class="line">1. 安装</span><br><span class="line">2. 更新</span><br><span class="line">3. 卸载</span><br><span class="line">----------------- 操作管理 ----------------</span><br><span class="line">4. 启动</span><br><span class="line">5. 停止</span><br><span class="line">6. 重启</span><br><span class="line">----------------- 配置管理 ----------------</span><br><span class="line">101. 查看配置</span><br><span class="line">102. 信息统计</span><br><span class="line">103. 修改 <span class="built_in">id</span></span><br><span class="line">104. 修改 dest</span><br><span class="line">105. 修改 x25519 key</span><br><span class="line">106. 修改 shortIds</span><br><span class="line">107. 修改 xray 监听端口</span><br><span class="line">108. 刷新已有的 shortIds</span><br><span class="line">109. 追加自定义的 shortIds</span><br><span class="line">110. 使用 WARP 分流，开启 OpenAI</span><br><span class="line">----------------- 其他选项 ----------------</span><br><span class="line">201. 更新至最新稳定版内核</span><br><span class="line">202. 卸载多余内核</span><br><span class="line">203. 修改 ssh 端口</span><br><span class="line">204. 网络连接优化</span><br><span class="line">-------------------------------------------</span><br><span class="line">0. 退出</span><br><span class="line">Choose:</span><br></pre></td></tr></table></figure><p>先选 1 安装， 输入 <code>1</code> 回车即可安装。</p><p>以后如果要进入这个管理脚本界面可以输入 <code>bash Xray-script.sh</code> 命令回车即可</p><p>安装过程进行一会儿会提示你输入自定义端口，这里直接回车不填就会使用默认 <code>443</code> 端口了。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请输入自定义的端口(1-65535), 默认不修改:</span><br></pre></td></tr></table></figure><p>接着提示输入 UUID，也可以直接回车让它自动生成</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请输入自定义 UUID, 默认则自动生成:</span><br></pre></td></tr></table></figure><p>出现让你设置目标网站的选项，也可以看情况输入 <code>0</code> 来自填网址。</p><blockquote><p>填写的网站建议跟你 VPS 所在地差不多，比如我的 IP 是大版的，我可以找家日本动画公司官网填写。不过这里选项里已经有几个 .jp 域名后缀的日本网站，我就直接填 <code>5</code> 回车。</p></blockquote><p>选项 1 和 2 的微软和苹果因为是全球化的公司，到处都有服务器，通用性很好不用太在意地址。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">---------------- dest 列表 -----------------</span><br><span class="line">1) learn.microsoft.com</span><br><span class="line">2) www.apple.com</span><br><span class="line">3) music.apple.com</span><br><span class="line">4) www.fandom.com</span><br><span class="line">5) www.lovelive-anime.jp</span><br><span class="line">6) tidal.com</span><br><span class="line">7) zoro.to</span><br><span class="line">8) www.pixiv.co.jp</span><br><span class="line">9) mxj.myanimelist.net</span><br><span class="line">10) mora.jp</span><br><span class="line">11) www.j-wave.co.jp</span><br><span class="line">12) www.dmm.com</span><br><span class="line">13) booth.pm</span><br><span class="line">14) www.ivi.tv</span><br><span class="line">15) fmovies.to/home</span><br><span class="line">16) www.leercapitulo.com</span><br><span class="line">17) www.sky.it</span><br><span class="line">18) www.sky.com</span><br><span class="line">19) www.smdyy.cc</span><br><span class="line">20) www.telecinco.es</span><br><span class="line">请选择你的 dest, 当前默认使用 <span class="string">&quot;learn.microsoft.com&quot;</span>, 自填选 0:</span><br></pre></td></tr></table></figure><p>这里问你要选哪个 UUID 的配置，只有一个选项自然填 <code>1</code> ，也可以不填，使用“默认全选”直接回车。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1) 422939fd-f699-4a26-a6d7-61e17ee3dd88</span><br><span class="line">请选择生成分享链接的 UUID ，用英文逗号分隔， 默认全选:</span><br></pre></td></tr></table></figure><p>让你选网址，虽然之前只设置了一个网址，不过这里拆分成带和不带 <code>www</code> 两种，也不填直接回车默认全选。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1) lovelive-anime.jp</span><br><span class="line">2) www.lovelive-anime.jp</span><br><span class="line">请选择生成分享链接的 serverName ，用英文逗号分隔， 默认全选:</span><br></pre></td></tr></table></figure><p>让选 shortId，这个脚本默认生成了 5 个 shortId，还是不填直接回车。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1) <span class="string">&quot;&quot;</span></span><br><span class="line">2) <span class="string">&quot;6d&quot;</span></span><br><span class="line">3) <span class="string">&quot;85dd&quot;</span></span><br><span class="line">4) <span class="string">&quot;e04cccd5&quot;</span></span><br><span class="line">5) <span class="string">&quot;5042dcec226b1621&quot;</span></span><br><span class="line">请选择生成分享链接的 shortId ，用英文逗号分隔， 默认全选:</span><br></pre></td></tr></table></figure><p>如果想自己设定 shortId 要遵循规则，可以使用十六进制：也就是这些数字和字母 <code>0123456789abcdef</code>，长度要求是 2 的倍数，不能写 3 位、5 位这种数字字母组合，长度最长到 16 位。</p><blockquote><p>🎉大功告成！出现如下共 10 个分享链接。随便复制一个到本地 v2rayN 客户端上粘贴就可以用了，注意分享链接开头是 <code>Vless://</code>，结尾是 <code>VLESS-XTLS-uTLS-REALITY</code>。</p></blockquote><h1 id="客户端配置">客户端配置</h1><p><strong>REALITY 这个新协议对客户端和内核是有要求的</strong></p><ul><li>Windows 端 v2rayN 至少要 v6.21 以上版本</li><li>安卓端 v2rayNG要 1.8.0 及以上版本</li><li>iPhone 端不清楚，自行查阅。</li></ul><h2 id="pc-端-v2rayn-配置">PC 端 v2rayN 配置</h2><p><a href="https://github.com/2dust/v2rayN/releases">点我进入 v2rayN 下载页面</a> ，当下最新正式版是 6.43 ，这里以此为例。</p><ol><li>下载下方的 <code>v2rayN-With-Core.zip</code>，解压即用无需安装，建议先将解压后的文件夹找个地方放好，然后将里面的 <code>v2rayN.exe</code> 程序创建个快捷方式。</li></ol><p><img src="https://oooutman.github.io/img/post/Reality/reality_02.jpg" alt="reality_02"></p><ol start="2"><li>打开文件夹，双击里面的 <code>v2rayN.exe</code> 即可运行，运行后可能窗口闪一下就消失了，去右下角托盘图标里找到它。也可能先弹出提示要求下载 <code>Microsoft .NET 8.0 Desktop Runtime</code> ，按提示下载安装即可。</li><li>运行后先右键图标在菜单 <code>自动配置系统代理</code> 打上勾，并确保路由是 <code>绕过大陆</code>。</li></ol><p><img src="https://oooutman.github.io/img/post/Reality/reality_03.jpg" alt="reality_03"></p><ol start="4"><li>再双击图标打开界面，开始里面是空白没有配置的，<strong>将你上面生成的分享链接复制</strong>，然后直接在这个界面 <code>Cltr+V</code> 粘贴就可以添加配置</li><li>打开浏览器访问被墙网站看能不能上，也可以在配置文件上右键使用 <code>测试服务器速度</code> 看看能不能跑起来。</li></ol><p><img src="https://oooutman.github.io/img/post/Reality/reality_04.jpg" alt="reality_04"></p><h2 id="安卓端-v2rayng-配置">安卓端 v2rayNG 配置</h2><p><a href="https://github.com/2dust/v2rayNG/releases">点我进入 v2rayNG 下载页面</a>，当前最新 Latest 版本为 1.8.19，下载下方的 <code>v2rayNG_1.8.19.apk</code>。</p><p><img src="https://oooutman.github.io/img/post/Reality/reality_05.jpg" alt="reality_05"></p><p>手机上安装后打开应用，点击右上角 <code>+</code> 图标， 选择 <code>扫描二维码</code>或<code>从剪贴板导入</code> 选项，不过手机上想获得电脑端的分享链接可能有点麻烦，用扫描二维码会方便点，可以先在PC端 v2rayN 配置上右键点击 <code>分享服务器(Ctrl+F)</code>这个选项（安卓端配置上面那张测试速度的图片里能看到），然后扫描出现的二维码窗口 。</p><p><img src="https://oooutman.github.io/img/post/Reality/reality_06.gif" alt="reality_06"></p><h2 id="sing-box配置">sing-box配置</h2><blockquote><p>经测试使用sing-box需要能连接通，但速度不快，延迟也高，体验上不如v2rayNG</p><p>配置文件来源：<a href="https://www.youtube.com/watch?v=e8EU29_YlOo">https://www.youtube.com/watch?v=e8EU29_YlOo</a></p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;log&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;disabled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;level&quot;</span>: <span class="string">&quot;info&quot;</span>,</span><br><span class="line">    <span class="string">&quot;output&quot;</span>: <span class="string">&quot;sing-box.log&quot;</span>,</span><br><span class="line">    <span class="string">&quot;timestamp&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;dns&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;servers&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;alidns&quot;</span>,</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;https://dns.alidns.com/dns-query&quot;</span>,</span><br><span class="line">        <span class="string">&quot;address_resolver&quot;</span>: <span class="string">&quot;cf&quot;</span>,</span><br><span class="line">        <span class="string">&quot;address_strategy&quot;</span>: <span class="string">&quot;prefer_ipv4&quot;</span>,</span><br><span class="line">        <span class="string">&quot;strategy&quot;</span>: <span class="string">&quot;ipv4_only&quot;</span>,</span><br><span class="line">        <span class="string">&quot;detour&quot;</span>: <span class="string">&quot;direct&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;cf&quot;</span>,</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;https://1.1.1.1/dns-query&quot;</span>,</span><br><span class="line">        <span class="string">&quot;strategy&quot;</span>: <span class="string">&quot;ipv4_only&quot;</span>,</span><br><span class="line">        <span class="string">&quot;detour&quot;</span>: <span class="string">&quot;direct&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;block&quot;</span>,</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;rcode://success&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;rules&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;geosite&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;cn&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;domain&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;myChinaDnsSite.com&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;domain_suffix&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;.cn&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;server&quot;</span>: <span class="string">&quot;alidns&quot;</span>,</span><br><span class="line">        <span class="string">&quot;disable_cache&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;geosite&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;category-ads-all&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;server&quot;</span>: <span class="string">&quot;block&quot;</span>,</span><br><span class="line">        <span class="string">&quot;disable_cache&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;final&quot;</span>: <span class="string">&quot;cf&quot;</span>,</span><br><span class="line">    <span class="string">&quot;strategy&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;disable_cache&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;disable_expire&quot;</span>: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;inbounds&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;tun-in&quot;</span>,</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;tun&quot;</span>,</span><br><span class="line">      <span class="string">&quot;inet4_address&quot;</span>: <span class="string">&quot;172.19.0.1/30&quot;</span>,</span><br><span class="line">      <span class="string">&quot;auto_route&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;strict_route&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;stack&quot;</span>: <span class="string">&quot;gvisor&quot;</span>,</span><br><span class="line">      <span class="string">&quot;mtu&quot;</span>: 9000,</span><br><span class="line">      <span class="string">&quot;sniff&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;sniff_timeout&quot;</span>: <span class="string">&quot;300ms&quot;</span>,</span><br><span class="line">      <span class="string">&quot;domain_strategy&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;udp_timeout&quot;</span>: 300</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;outbounds&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;proxy&quot;</span>,</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;vless&quot;</span>,</span><br><span class="line">      <span class="string">&quot;server&quot;</span>: <span class="string">&quot;你的服务器IP&quot;</span>,</span><br><span class="line">      <span class="string">&quot;server_port&quot;</span>: 你用的端口,</span><br><span class="line">      <span class="string">&quot;uuid&quot;</span>: <span class="string">&quot;你服务端的用户UUID&quot;</span>,</span><br><span class="line">      <span class="string">&quot;flow&quot;</span>: <span class="string">&quot;xtls-rprx-vision&quot;</span>,</span><br><span class="line">      <span class="string">&quot;network&quot;</span>: <span class="string">&quot;tcp&quot;</span>,</span><br><span class="line">      <span class="string">&quot;packet_encoding&quot;</span>: <span class="string">&quot;xudp&quot;</span>,</span><br><span class="line">      <span class="string">&quot;tls&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;server_name&quot;</span>: <span class="string">&quot;你的服务端设置的serverNames其一&quot;</span>,</span><br><span class="line">        <span class="string">&quot;utls&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;enabled&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="string">&quot;fingerprint&quot;</span>: <span class="string">&quot;chrome&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;reality&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;enabled&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="string">&quot;public_key&quot;</span>: <span class="string">&quot;你服务端生成的公钥&quot;</span>,</span><br><span class="line">          <span class="string">&quot;short_id&quot;</span>: <span class="string">&quot;你服务端shortIds其一，截止发文sing-box必须使用16位的short_id&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;direct&quot;</span>,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;direct&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;block&quot;</span>,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;block&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;dns&quot;</span>,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;dns-out&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;route&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;geoip&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;path&quot;</span>: <span class="string">&quot;geoip.db&quot;</span>,</span><br><span class="line">      <span class="string">&quot;download_url&quot;</span>: <span class="string">&quot;https://github.com/SagerNet/sing-geoip/releases/latest/download/geoip.db&quot;</span>,</span><br><span class="line">      <span class="string">&quot;download_detour&quot;</span>: <span class="string">&quot;direct&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;geosite&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;path&quot;</span>: <span class="string">&quot;geosite.db&quot;</span>,</span><br><span class="line">      <span class="string">&quot;download_url&quot;</span>: <span class="string">&quot;https://github.com/SagerNet/sing-geosite/releases/latest/download/geosite.db&quot;</span>,</span><br><span class="line">      <span class="string">&quot;download_detour&quot;</span>: <span class="string">&quot;direct&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;rules&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;dns&quot;</span>,</span><br><span class="line">        <span class="string">&quot;outbound&quot;</span>: <span class="string">&quot;dns-out&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;domain&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;myProxy.com&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outbound&quot;</span>: <span class="string">&quot;proxy&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;domain&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;myDirect.com&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outbound&quot;</span>: <span class="string">&quot;direct&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;geosite&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;cn&quot;</span>,</span><br><span class="line">          <span class="string">&quot;private&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;geoip&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;cn&quot;</span>,</span><br><span class="line">          <span class="string">&quot;private&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;domain_suffix&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;.cn&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outbound&quot;</span>: <span class="string">&quot;direct&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;geosite&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;category-ads-all&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outbound&quot;</span>: <span class="string">&quot;block&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;auto_detect_interface&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;final&quot;</span>: <span class="string">&quot;proxy&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;experimental&quot;</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;官方说法是 REALITY 可以&lt;strong&gt;消除服务端 TLS 指纹特征&lt;/strong&gt;，同时保留前向保密性等功能，证书链攻击也无效，安全性超越了常规的 TLS。还有个优点是 REALITY &lt;strong&gt;可以指向别人的网站，无需自己购买域</summary>
      
    
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/tags/%E6%8A%98%E8%85%BE/"/>
    
  </entry>
  
  <entry>
    <title>将Nas共享到虚拟局域网内</title>
    <link href="https://blog.lthero.cn/2024/07/04/ShareNasWithZerotier/"/>
    <id>https://blog.lthero.cn/2024/07/04/ShareNasWithZerotier/</id>
    <published>2024-07-04T15:38:11.000Z</published>
    <updated>2024-07-04T15:45:37.144Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>起因：局域网内有个Nas，但没法安装Docker，不能安装Zerotier；</p><p>目的：通过Zerotier创建个虚拟局域网，让Nas被虚拟局域网其它设备使用</p><p>做法：</p><ol><li>把Nas挂载到局域网内的Ubuntu设备上</li><li>Ubuntu上运行Zerotier并加入到虚拟局域网</li><li>Ubuntu上将挂载的目录共享，从而让虚拟局域网内的其它设备访问到这个目录</li></ol></blockquote><h1 id="挂载nas到ubuntu">挂载Nas到ubuntu</h1><blockquote><p>目的：把局域网的Nas设备挂载到Ubuntu电脑上</p></blockquote><h2 id="单次挂载">单次挂载</h2><p>首先在Ubuntu 的 <code>/mnt</code> 目录下新建一个 NAS 挂载目录 <code>nas</code>：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /mnt/nas</span><br><span class="line"><span class="comment"># 下面这个命令是为了共享时，允许匿名直接访问，解决权限问题</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 777 /mnt/nas</span><br></pre></td></tr></table></figure><p>安装 <code>cifs-utils</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install cifs-utils</span><br></pre></td></tr></table></figure><p>查看用户的 <code>uid</code> 和 <code>gid</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">id</span> root</span><br></pre></td></tr></table></figure><p>运行下面的命令，完成单次挂载</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t cifs -o uid=root,username=admin,password=xxxx,iocharset=utf8,file_mode=0777,dir_mode=0777 //192.168.6.154/public /mnt/nas/ </span><br></pre></td></tr></table></figure><ul><li>uid 选择<strong>ubuntu系统上</strong>普通用户或root</li><li>username 是<strong>nas上</strong>的用户名</li><li>password 是<strong>nas上</strong>的密码</li><li>iocharset=utf8 防止有中文路径</li><li><a href="//192.168.6.154/public">//192.168.6.154/public</a> 是nas下的public目录</li><li>/mnt/nas/ 挂载到ubuntu的这个目录下</li><li>file_mode=0777,dir_mode=0777  权限全开</li></ul><h2 id="开机自动挂载">开机自动挂载</h2><p>编辑启动挂载文件 <code>fstab</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/fstab</span><br></pre></td></tr></table></figure><p>在文件最后追加一行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 仅给root用户全部权限</span></span><br><span class="line">//192.168.6.154/public /mnt/nas/ cifs uid=root,username=admin,password=xxx,iocharset=utf8 0 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面这行是将权限全部开放</span></span><br><span class="line">//192.168.6.154/public /mnt/nas cifs uid=root,username=admin,password=xxxx,iocharset=utf8,file_mode=0777,dir_mode=0777 0 0</span><br></pre></td></tr></table></figure><p>在重启之前，你可以手动测试这个配置是否有效。</p><p>首先，卸载之前可能已经手动挂载的共享：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo umount /mnt/nas/</span><br></pre></td></tr></table></figure><p>运行以下命令来挂载所有在<code>/etc/fstab</code>中定义的文件系统：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -a</span><br></pre></td></tr></table></figure><p>如果没有错误提示，说明配置成功。</p><p>重启系统，并检查CIFS共享是否自动挂载了。</p><p>通过上述步骤，每次系统启动时，CIFS共享就会自动挂载到指定的挂载点。如果遇到问题，检查日志文件（如<code>/var/log/syslog</code>）中的错误信息</p><h1 id="ubuntu上运行zerotier">Ubuntu上运行Zerotier</h1><blockquote><p>参考早前的一篇文章</p><p><a href="https://blog.lthero.cn/2024/05/25/install-zeroTier/">https://blog.lthero.cn/2024/05/25/install-zeroTier/</a></p></blockquote><h1 id="ubuntu共享文件">Ubuntu共享文件</h1><blockquote><p>ubuntu共享其目录给局域网内的其它设备</p><p>这里注意下，如果使用了下面的方法，就不要在“桌面版”上进行操作了（对某个目录右键，选择局域网共享，设置名字之类的），<strong>容易冲突</strong></p></blockquote><h2 id="通过-samba-共享目录">通过 Samba 共享目录</h2><p>安装samba</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install samba</span><br></pre></td></tr></table></figure><p>编辑 Samba 配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/samba/smb.conf</span><br></pre></td></tr></table></figure><p>在文件末尾添加以下内容：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[nas]</span><br><span class="line">    path = <span class="regexp">/mnt/</span>nas</span><br><span class="line">    browseable = yes</span><br><span class="line">    read only = no</span><br><span class="line">    guest ok = yes</span><br><span class="line">    force user = nobody</span><br><span class="line">    create mask = <span class="number">0777</span></span><br><span class="line">    directory mask = <span class="number">0777</span></span><br></pre></td></tr></table></figure><h2 id="重启-samba-服务">重启 Samba 服务</h2><p>每次修改配置文件后，都需要重启 Samba 服务以使更改生效：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart smbd</span><br></pre></td></tr></table></figure><h2 id="测试-samba-共享">测试 Samba 共享</h2><p>你现在可以从其他计算机访问共享目录。比如在 Windows 上，通过文件资源管理器访问：</p><p>（可以从物理局域网内进行访问，也可以直接使用虚拟ip进行访问）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\your_ubuntu_ip\nas</span><br></pre></td></tr></table></figure><p>在 Linux 上，可以使用以下命令挂载共享目录：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t cifs //your_ubuntu_ip/nas /path/to/mount -o guest</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;起因：局域网内有个Nas，但没法安装Docker，不能安装Zerotier；&lt;/p&gt;
&lt;p&gt;目的：通过Zerotier创建个虚拟局域网，让Nas被虚拟局域网其它设备使用&lt;/p&gt;
&lt;p&gt;做法：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;把Nas挂载到局域网内的Ubu</summary>
      
    
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/tags/%E6%8A%98%E8%85%BE/"/>
    
  </entry>
  
  <entry>
    <title>国外内大模型行业分析报告</title>
    <link href="https://blog.lthero.cn/2024/07/01/AReportAboutLLM/"/>
    <id>https://blog.lthero.cn/2024/07/01/AReportAboutLLM/</id>
    <published>2024-07-01T12:22:11.000Z</published>
    <updated>2024-07-01T12:48:49.028Z</updated>
    
    <content type="html"><![CDATA[<h1 id="大模型的定义">大模型的定义</h1><p>大模型是指具有<strong>大规模参数和复杂计算结构</strong>的机器学习模型，<strong>拥有数十亿甚至数千亿个参数</strong>。</p><p>大模型的设计目的：为了<strong>提高模型的表达能力和预测性能</strong>，能够处理更加复杂的任务和数据。</p><p>大模型在各种领域都有广泛的应用，包括自然语言处理、计算机视觉、语音识别和推荐系统等。</p><h2 id="大模型和小模型有什么区别？">大模型和小模型有什么区别？</h2><p><strong>小模型</strong>通常指参数较少、层数较浅的模型，它们具有轻量级、高效率、易于部署等优点，适用于数据量较小、计算资源有限的场景，例如移动端应用、嵌入式设备、物联网等。</p><p>而当模型的训练数据和参数不断扩大，直到<strong>达到一定的临界规模后</strong>，其表现出了一些未能预测的、更复杂的能力和特性，<strong>模型能够从原始训练数据中自动学习并发现新的、更高层次的特征和模式</strong>，这种能力被称为“<strong>涌现能力</strong>”。</p><blockquote><p><strong>具备涌现能力的机器学习模型</strong>就被认为是独立意义上的大模型，这也是其和小模型最大意义上的区别。</p></blockquote><p><img src="https://cdn.lthero.cn/post_images/course/ML/Chatgpt1.png" alt="AI 大模型的三大特征：泛化性、通用性、涌现性"></p><p>相比小模型，大模型通常参数较多、层数较深，具有更强的表达能力和更高的准确度，但也需要更多的计算资源和时间来训练和推理，适用于数据量较大、计算资源充足的场景，例如云端计算、高性能计算、人工智能等。</p><h2 id="大模型的核心突破是什么？">大模型的核心突破是什么？</h2><p>与传统AI仅能处理单一任务相比，大模型技术通过<strong>其庞大的参数规模、强大的泛化能力</strong>、<strong>对多模态数据的支持</strong>，展现出类似人类的通用智能**“涌现”能力**，能够学习多个领域知识、处理多种数据和任务。</p><p>OpenAI提出的“规模定律”（Scaling Law）驱动了大模型的快速发展，</p><blockquote><p>规模定律即：模型的性能与模型的规模、数据集大小和训练用的计算量之间存在幂律关系，性能会随着这三个因素的指数增加而线性提高</p></blockquote><ol><li><strong>模型参数规模</strong>：随着模型参数数量增加，模型的表现会有显著提升。但这种提升会在一定程度上出现递减效应，即每增加一倍的参数数量所带来的性能提升会逐渐减小。</li><li><strong>计算量</strong>：增加训练计算量（通常通过<strong>增加训练步数或更复杂的模型结构</strong>）也可以提升模型性能。这种提升同样存在递减效应。</li><li><strong>数据量</strong>：<strong>增加训练数据量</strong>同样能够提升模型性能，并且在某些情况下，数据量的增加比增加参数数量或计算量更为有效。</li><li><strong>组合效应</strong>：最理想的情况是同时<strong>增加模型的参数规模、计算量和数据量</strong>，这样可以最大化模型的性能提升。</li></ol><blockquote><p>通俗而言就是“<strong>大力出奇迹</strong>”。</p></blockquote><p>传统AI模型参数量通常在数万至数亿之间，大模型的参数量则至少在亿级，并已发展到过万亿级的规模。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/Chatgpt.png" alt="image-20240701190534784"></p><h1 id="大模型相关概念区分">大模型相关概念区分</h1><p><strong>大模型（Large Model,也称基础模型，即Foundation Model）</strong>，是指具有大量参数和复杂结构的机器学习模型，能够处理海量数据、完成各种复杂的任务，如自然语言处理、计算机视觉、语音识别等。</p><p><strong>超大模型</strong>：超大模型是大模型的一个子集，它们的参数量远超过大模型。</p><p><strong>大语言模型（Large Language Model）</strong>：通常是具有大规模参数和计算能力的自然语言处理模型，例如 OpenAI 的 GPT-3 模型。这些模型可以通过大量的数据和参数进行训练，以生成人类类似的文本或回答自然语言的问题。大型语言模型在自然语言处理、文本生成和智能对话等领域有广泛应用。</p><p><strong>GPT（Generative Pre-trained Transformer</strong>）：GPT 和ChatGPT都是基于Transformer架构的语言模型，但它们在设计和应用上存在区别：GPT模型旨在生成自然语言文本并处理各种自然语言处理任务，如文本生成、翻译、摘要等。它通常在单向生成的情况下使用，即根据给定的文本生成连贯的输出。</p><p><strong>ChatGPT</strong>：ChatGPT则专注于对话和交互式对话。它经过特定的训练，以更好地处理多轮对话和上下文理解。ChatGPT设计用于提供流畅、连贯和有趣的对话体验，以响应用户的输入并生成合适的回复。</p><h1 id="大模型的发展历程">大模型的发展历程</h1><p>大模型的发展历程可以追溯到早期的深度学习模型，并随着计算能力的提升和大数据的积累逐渐演进。以下是大模型发展的几个重要阶段：</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/Hi.png" alt="image-20240701190534784"></p><h2 id="早期深度学习模型">早期深度学习模型</h2><p>在大模型之前，深度学习已经在图像和语音识别等领域取得了显著成果。早期的卷积神经网络（CNN）和递归神经网络（RNN）在特定任务上表现出色，但这些模型的参数数量和复杂度相对较小，主要应用于单一任务。</p><h4 id="代表性模型：">代表性模型：</h4><ul><li>LeNet（1998年）：LeNet是最早的CNN模型之一，主要用于手写数字识别。</li><li>AlexNet（2012年）：AlexNet在ImageNet比赛中取得了突破性胜利，显著推动了深度学习的发展。</li></ul><h2 id="转折点：transformer模型">转折点：Transformer模型</h2><p>2017年，Transformer模型的提出标志着深度学习领域的一个重要转折点。Transformer引入了自注意力机制，极大地提高了模型在处理自然语言任务时的性能，并成为后续大模型的基础架构。</p><h4 id="代表性模型：">代表性模型：</h4><ul><li>Transformer（2017年）：由Vaswani等人提出，引入了自注意力机制和多头注意力机制，显著提升了自然语言处理的效果。</li></ul><h2 id="预训练和微调：bert和gpt">预训练和微调：BERT和GPT</h2><p>Transformer的成功带来了预训练和微调范式的兴起。这一阶段的代表模型包括BERT和GPT系列，它们通过在大规模数据上进行预训练，再在特定任务上进行微调，展示了强大的迁移学习能力。</p><h4 id="代表性模型：">代表性模型：</h4><ul><li>BERT（2018年）：由Google提出，通过双向编码器表示实现了在多个NLP任务上的显著提升。</li><li>GPT（2018年）：由OpenAI提出，采用生成预训练策略，通过单向生成实现了强大的文本生成能力。</li></ul><h2 id="大模型时代的开启：gpt-3">大模型时代的开启：GPT-3</h2><p>2020年，OpenAI发布了GPT-3，标志着大模型时代的正式开启。GPT-3拥有1750亿参数，展示了前所未有的生成和理解能力，使得大模型在NLP领域的应用取得了突破性进展。</p><h4 id="代表性模型：">代表性模型：</h4><ul><li>GPT-3（2020年）：OpenAI的GPT-3模型通过大规模预训练和参数扩展，展示了在多种任务上的强大性能。</li></ul><p><img src="https://cdn.lthero.cn/post_images/course/ML/ChatgptExp.png" alt="解释chatgpt工作原理"></p><h2 id="多模态模型的发展">多模态模型的发展</h2><p>随着大模型技术的不断进步，研究者开始探索多模态模型，这些模型能够处理和理解多种数据形式（如文本、图像、音频等），进一步提升了AI的应用范围和智能水平。</p><h4 id="代表性模型：">代表性模型：</h4><ul><li>DALL-E（2021年）：由OpenAI提出，能够根据文本描述生成图像，展示了文本到图像生成的强大能力。</li><li>CLIP（2021年）：由OpenAI提出，能够同时处理文本和图像，并实现跨模态理解和生成。</li></ul><h2 id="生成式模型的发展">生成式模型的发展</h2><p>生成式模型是大模型的重要分支，通过学习数据的分布来生成新的数据。这些模型在图像生成、文本生成、音频生成等领域展现了强大的能力。</p><h4 id="代表性模型：">代表性模型：</h4><ul><li>Diffusion模型：一种通过逐步添加噪声并逆向去噪的方式生成图像的模型，展示了高质量图像生成的潜力。</li><li>ChatGPT（2022年）：基于GPT架构，专注于对话和交互，通过微调优化对话质量，提供流畅的对话体验。</li></ul><h1 id="国内外大模型对比">国内外大模型对比</h1><h2 id="chatgpt成功原因简要分析">ChatGPT成功原因简要分析</h2><blockquote><p>ChatGPT的成功并非偶然，而是多因素综合作用的结果，凸显了战略方向和执行路径的至关重要性。</p></blockquote><p>首先，OpenAI自非营利向半营利模式转型，为ChatGPT这一明确商业化方向的产品提供了有力的市场导向。其次，OpenAI始终秉持实现安全的通用人工智能（Artificial General Intelligence，AGI）的初心，由创始团队用第一性原理定位研发路线，成功突破各种技术瓶颈，从而确立在通用AI领域的领先地位</p><p>资金投入与发展策略为 ChatGPT成功带来至关重要的影响</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/Chatgpt2-3.png" alt="资金投入与发展策略为 ChatGPT成功带来至关重要的影响"></p><p>在数据方面，GPT-3模型训练了高达45TB的数据，涵盖数千万本文学作品。资金上，从GPT-1到ChatGPT的开发周期中，总投入资金高达数十亿美元，这些资金主要用于数据采集、模型训练、运营以及人力资源。算力方面，OpenAI通过与微软Azure的合作，动用了大约1万块NVIDIA A100 GPU，确保模型能够高效运行。</p><p>更不可或缺的是人才因素。ChatGPT团队由87名全球顶尖的AI专家组成，主要毕业于斯坦福、伯克利和麻省理工等名校，其中5人被评选为2023年度“AI 2000全球人工智能学者”。综上所述，ChatGPT的成功是多维度要素，包括初心、数据、资金、算力和人才，共同作用下的必然结果。</p><blockquote><p>通用基础大语言模型的价值与自研卡点如下</p></blockquote><p><img src="https://cdn.lthero.cn/post_images/course/ML/Chatgpt3-1.png" alt="图3-1 通用基础大语言模型的价值与自研卡点"></p><p>在通用基础大语言模型的研发和应用方面，价值与挑战并存（如图3-1所示）。</p><p>首先，从<strong>价值角度看</strong>，自主可控的模型在全球政治经济格局下具有战略意义，能有效规避数据跨境的合规风险，满足中大型企业和政府的私有化部署需求，同时还能抵御美国科技保护主义的影响。更进一步，<strong>如能成功开发，其将像“超级大脑”一样，成为具有巨大商业价值的资产</strong>。</p><p><strong>面临的主要卡点包括</strong></p><ol><li>美国的芯片禁令导致的高端AI算力不足</li><li>中文高质量数据资源相较于英文的明显不足</li><li>研发过程中必要的技术和工程能力，例如分布式训练和模型蒸馏等</li><li>此外，如何将“know-how”数据有效转化为问答能力，还需要大量的提示工程师投入。</li></ol><p>综合来看，虽有巨大价值等待挖掘，但也需面对一系列复杂的挑战和限制因素。</p><h2 id="中国自研通用基础大语言模型">中国自研通用基础大语言模型</h2><p>在2023年3月，OpenAI发布了具有GPT-4架构的ChatGPT，实现了多模态交互、显著优化了长文本理解与生成能力，并在可控性方面取得了重大突破，此举在全球科技界引发了强烈震荡。</p><p>与此同时，中国的科技与投资界也高度关注这一趋势，<strong>百度紧跟其后，发布了“文心一言”产品</strong>。尽管在产品功能、成熟度和用户并发处理等方面与ChatGPT尚有较大差距，但百度的这一行动标志着中国在新一轮全球“科技军备竞赛”中积极的探索与表态。</p><p>目前，百度已启动了应用程序编程接口的开放测试，并针对B端市场进行战略定位。其它科技巨头如360、阿里、华为、商汤、京东、科大讯飞、字节跳动等也在加速动作，各自从自身业务生态出发，选择了不同的战略路径。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/834e858aee044bfd832117e1d183bf46.png" alt="国内外大模型发展"></p><p>从<strong>全球政治经济局势</strong>看，<strong>自主研发通用预训练大语言模型具有至关重要的战略价值</strong>，它是确保网络安全和信息安全的基础。</p><p>从<strong>自研可行性角度</strong>来看，考虑到算力、数据、算法、人才和资金等多个要素，中国仅有少数头部企业具备进行此类研发的资格。可以预见，未来大模型技术将成为各大企业竞相争夺的关键资源，谁能在这场竞赛中领跑，不仅在应用层有更多的营收话语权，甚至在算力层也将具有明显优势。</p><p>从自研通用预训练大语言模型（Large Language Model，LLM）的<strong>必要性</strong>角度，自主可控是确保网络和信息安全的基础，而自研模型在全球政治经济格局下具有战略意义。</p><p>从<strong>可行性角度</strong>，鉴于研发LLM所需的算力、数据、算法、人才和资金，<strong>仅有少数中国顶级互联网公司具备相应条件</strong>。各大参与者根据自身业务生态选择不同的战略路线，但一个大胆的假设是，未来拥有先进的大模型和生态系统的企业将更有可能在应用层到算力层掌握营收话语权。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/Chatgpt3-2.png" alt="图3-2 中国大语言模型产业价值链"></p><p><img src="https://cdn.lthero.cn/post_images/course/ML/Chatgpt3-2-2.png" alt="图3-2 中国大语言模型产业价值链"></p><p>整个价值链不仅依赖于算法和模型，更离不开算力基础设施和数据基础设施的支持。算力基础设施提供了大模型训练和运行所需的底层能力，而数据基础设施则为模型提供丰富的训练数据和用户反馈，共同构建了一个健壮和高效的大语言模型产业生态系统。</p><h2 id="硬件资源全面对比">硬件资源全面对比</h2><p>OpenAI以其对前沿AI技术的领导地位，使用了<strong>800张NVIDIA A100显卡</strong>，总耗电量达到1500千瓦时，以实现其GPT系列模型的高效训练。</p><p>Google则依靠了自家开发的TPU v4，<strong>部署了1000张显卡</strong>，总耗电量约为1300千瓦时，以支持其各类大规模机器学习项目。</p><p>Meta采用了<strong>NVIDIA的V100显卡，共计900张</strong>，总耗电量达到1400千瓦时，支持其虚拟现实和增强现实等先进技术的研发。</p><p>中国科技巨头百度则选择了<strong>AMD的Instinct MI100显卡，共部署了700张</strong>，耗电量大约1200千瓦时，以推动其自动驾驶和智能搜索等关键业务的进展。</p><p>清华大学也在AI领域发挥了重要作用，<strong>采用了600张NVIDIA的A30显卡</strong>，总耗电量约为1000千瓦时，用于支持各类学术研究和创新项目。</p><p>总体而言，从上述各大公司和机构的硬件资源配置可以看出，显卡类型、数量和耗电量的选择反映了各自的技术方向和战略目标。无论是选择业界领先的显卡产品，还是自主开发硬件，都体现了大语言模型训练领域竞争的激烈和多样化。这一竞赛不仅推动了硬件技术的进步，也为AI的未来发展奠定了坚实的基础。</p><h2 id="研发路径与技术对比">研发路径与技术对比</h2><p>在大语言模型（LLMs）的全球竞技场中，ChatGPT与Google的Gopher、LaMDA，以及Meta的Llama等构成了国际标杆</p><p>而国内则由百度的“文心一言”、360的大语言模型、阿里的“通义千问”和商汤的“商量”等引领潮流。</p><p>从对话和文本生成能力的角度，<strong>ChatGPT暂居优势，但这并非因为技术壁垒不可逾越</strong>。实际上，Google等国外企业因战略和技术理念选择了不同的发展路径，这是其暂时落后的主因。<strong>随着新技术的不断涌现，赶超ChatGPT并非不可能</strong>。相对而言，百度等国内企业在数据集、计算能力和工程化方面存在短板，短期内难以实现对国外模型的迎头赶上，这更多地需要国内AI产业全链条的协同进步。</p><p>在影响大语言模型性能的因素方面，训练数据、模型规模（即参数数量）、生成算法和优化技术被认为是核心变量。</p><p>然而，如何准确量化这些因素对模型性能的具体影响，目前还处于探索阶段，没有明确的结论。总体来看，世界顶级的大语言模型在技术层面上尚未拉开明显的差距。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/Chatgpt3-3-3.png" alt="图3-3 国内外主要大语言模型研发路径与技术对比"></p><h2 id="商业路径对比">商业路径对比</h2><h3 id="chatgpt">ChatGPT</h3><p>在战略业务拓展方面，<strong>ChatGPT</strong>已经形成了明确且差异化的商业路线，<strong>主要围绕API、订阅制和战略合作</strong>（例如与微软的Bing、Office等软件的嵌入合作）三大营收模式（如图3-4所示）。在用户数据积累、产品布局和生态建设等方面已具备明显的先发优势。</p><p>在C端生态布局方面，ChatGPT采取双管齐下的战略。一方面，通过引进各种上游插件来增强应用能力，目标打造成一个super APP以吸引更多用户。另一方面，通过创新软件交互方式将用户纳入生态圈，从而完成C端生态的全面布局。</p><p>对于B端生态，OpenAI通过与微软Azure的合作，间接实现了“模型即服务”的模式，同时也直接提供大模型API，以服务小型B端开发者，进一步完善了B端生态体系。</p><h3 id="google">Google</h3><p>相对之下，<strong>Google由于其主营业务是搜索引擎</strong>，对于聊天机器人等产品的发展相对保守，更注重利用大模型能力来推动“模型即服务”范式，以拓展其在云服务市场的份额。与此同时，谷歌也在积极拉动B端业务，通过多款大模型能力的组合拳来提升市场竞争力。</p><h3 id="百度">百度</h3><p>百度的战略更接近Google，主要针对B端市场，通过全栈优势来构建全链能力</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/Chatgpt3-4.png" alt="图3-4 国内外主要大语言模型厂商商业路径对比"></p><h3 id="商业发展前景">商业发展前景</h3><blockquote><p>AI云侧与端侧大模型满足不同需求，C端用户将成为端侧的主要客群</p></blockquote><p>一方面，面向C端个人用户，云侧大模型提供智能问答、文本生成、图片生成、视频生成等功能。</p><p>另一方面，面向B端企业用户，云侧大模型变革企业传统业务模式，提供营销、客服、会议记录、文本翻译、预算管理等个性化服务。</p><p>端侧大模型具有成本低、移动性强、数据安全等优势,主要应用在手机、PC等终端设备上。<strong>端侧大模型主要面向C端用户</strong>，重塑传统个人设备的使用方式和习惯，提供手机文档搜索、智能识屏、图像创作、生活助手、出行助手等专属服务。</p><p><strong>成本方面</strong>，根据云侧大模型每次调用成本、用户数、用户使用频率不同，云侧大模型服务器每年成本可达数亿或数十亿，高昂的服务器支出成为各大厂商发展大模型的障碍。将大模型端侧化，能把一部分云端计算转移给终端，从而大大降低云端服务器成本。</p><p><strong>安全方面</strong>，由于端侧大模型数据保存在本地，个人数据不需要上传云端，个人隐私数据更加安全。</p><p>丰富的使用场景、较低的模型成本、安全的隐私保护，使得未来大模型端侧化可能成为趋势。</p><p><strong>瑞银预计生成式AI 智能手机出货量将从2023 年的5000 万部增长到2027 年的5.83 亿部，到2027 年收入将达5130 亿美元</strong>。未来面向广大C 端用户的端侧大模型市场前景广阔。</p><h2 id="国内大模型发展缺陷分析">国内大模型发展缺陷分析</h2><h3 id="技术层面">技术层面</h3><p>当前国内技术比ChatGPT主要差在大模型环节，<strong>包括清洗、标注、模型结构设计、训练推理的技术积累</strong>。</p><blockquote><p>ChatGPT背后是文本/跨模态大模型、多轮对话、强化学习等多技术的融合创新，<strong>而国内大部分科技企业、科研院所多聚焦垂直应用，缺乏多技术融合创新能力</strong>。</p></blockquote><p>从落地应用来看，国内头部企业均表示已开展相关技术研发或部分模型进入内测阶段，但仍未出现与ChatGPT抗衡的大模型产品。加之大模型的训练成本较高，技术应用面临着亿元级研发投入和海量训练试错，国内企业投入严重不足，研发推广和产业落地整体落后于海外。</p><h3 id="算力瓶颈">算力瓶颈</h3><blockquote><p>当前，主流大模型所使用的<strong>Transformer 架构存在消耗算力资源大、占用内存储量多等局限性</strong>。</p></blockquote><h4 id="算力需求来源">算力需求来源</h4><p>首先，Transformer架构消耗的算力资源普遍较大。传统Transformer 架构由于算法特性，计算量会随着上下文长度的增加呈平方级上升。假如用户输入的上下文增加32 倍，计算量可能会增加1000倍以上。</p><p>其次，基于Transformer 架构的大模型对存储设备的要求也更高。在训练过程中需要在内存中存储参数的当前值、梯度以及其他优化器状态。模型的参数越多，所需的计算就越多，需要的存储空间就越大。如1000亿个参数的Transformer模型，存储这些参数就需要400GB的空间</p><h4 id="全球主导的芯片">全球主导的芯片</h4><blockquote><p>随着大模型规模呈现指数级增长，<strong>训练大模型越发依赖高性能芯片。</strong></p></blockquote><p>大模型的训练速度、产出质量，都和算力直接相关，对于GPT 这种大语言模型（LLM）来说，算力的要求更高，也决定了模型的“智商”。<strong>目前在全球AI 高性能芯片市场中，主要以英伟达的A100、H100 为代表的高性能芯片应用到主流大模型的训练过程</strong>。英伟达的芯片产品采用最前沿半导体工艺和创新GPU 架构保持行业的领先地位。目前，英伟达的A100 芯片在主流AI 大模型训练中占据重要市场份额，H100 虽性能强劲但难以获取。</p><p>以ChatGPT 为例，<strong>微软Azure 云服务为其提供了1万枚英伟达A100 GPU</strong>，这个算力也正是国内云计算技术人士共识的AI 大模型门槛。</p><p>然而<strong>国内拥有1 万枚GPU 的企业很少，而且单枚GPU 普遍弱于英伟达A100</strong>。由于英伟达A100 及以上性能GPU被列入管制清单，目前中国企业能获取的替代品为英伟达A800，然而A800 也存在缺货和溢价的情况。</p><h4 id="我国芯片产业简介">我国芯片产业简介</h4><p>从我国自研AI芯片来看，中国本土的高性能芯片龙头以华为海思、寒武纪、地平线、昆仑芯等为代表。我国正在高性能芯片领域加大投入并取得极大进展，部分解决方案正替代英伟达成为一些大厂的选择。<strong>但国产芯片性能目前仍与国际顶尖水平存在一定差距。</strong></p><p>在国内，AI 高性能芯片近年来发展速度加快。其中，华为昇腾主要包括310 和910 两款主力芯片，其中昇腾910 采用了7nm 工艺，最高可提供256 TFLOPS的FP16 计算能力，其能效比在行业中处于领先水平。寒武纪是中国具有代表性的另一本土AI 芯片厂商，公司先后推出了思元290 和思元370 芯片及相应的云端智能加速卡系列产品、训练整机。</p><p>总体而言，<strong>国内AI高性能芯片市场受进口限制和国内技术瓶颈的双重影响，大模型产业发展受到算力层面的一些制约。</strong></p><h3 id="数据集">数据集</h3><blockquote><p>高质量的训练数据集仍需扩展</p></blockquote><p>国内的AI大模型数据主要来自互联网、电商、社交、搜索等渠道，存在数据类型不全面，信息可信度不高等问题。</p><h4 id="数据集数量对比">数据集数量对比</h4><p>整体来看，<strong>我国可用于大模型训练的中文数据库体量严重不足</strong>。如悟道语料库，其包括文本、图文和对话数据集，最大的仅5TB，其中开源的文本部分仅为200GB。另外一个开源的中文本数据集CLUECorps 为100G。<strong>相比之下，GPT-3 的训练数据量，以英语为主，达到45TB。</strong></p><h4 id="数量不足原因">数量不足原因</h4><p>国内大模型的<strong>数据还缺乏多数据源的调用</strong>，可供大模型训练的有效<strong>数据源呈现碎片化分散状态</strong>，如<strong>微信公众号的文章仅在搜狗引擎支持调用</strong>，而多数大模型如智谱清言在联网收集数据时无法直接调用微信公众号文章。</p><p>当前，政府部门的权威数据、大型企业掌握的行业或内部数据通常不对外公开。以<strong>阿里巴巴的“通义千问”大模型为例，训练数据来自公开来源的混合数据，中文语料主要来自知乎、百度百科、百度知道等公开网络数据，来源于政府及企业数据较少</strong>。未来，仍需构建高质量的AI 大模型训练数据集，不断扩充数据源提高数据质量。</p><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;大模型的定义&quot;&gt;大模型的定义&lt;/h1&gt;
&lt;p&gt;大模型是指具有&lt;strong&gt;大规模参数和复杂计算结构&lt;/strong&gt;的机器学习模型，&lt;strong&gt;拥有数十亿甚至数千亿个参数&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;大模型的设计目的：为了&lt;strong&gt;提高模型的表达</summary>
      
    
    
    
    <category term="大模型" scheme="https://blog.lthero.cn/categories/%E5%A4%A7%E6%A8%A1%E5%9E%8B/"/>
    
    
    <category term="大模型" scheme="https://blog.lthero.cn/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B/"/>
    
  </entry>
  
  <entry>
    <title>使用Sunshine软件远程控制Ubuntu</title>
    <link href="https://blog.lthero.cn/2024/06/27/InstallSunshineStreaming/"/>
    <id>https://blog.lthero.cn/2024/06/27/InstallSunshineStreaming/</id>
    <published>2024-06-27T12:59:25.000Z</published>
    <updated>2024-06-27T13:12:26.155Z</updated>
    
    <content type="html"><![CDATA[<p>原打算使用Windows自带的远程控制软件控制Ubuntu，需要在Ubuntu安装xrdp，但最终无法进入桌面（闪退）</p><p>附加一个在ubuntu一键安装与配置xrdp脚本：<a href="https://c-nergy.be/blog/?p=19814">https://c-nergy.be/blog/?p=19814</a></p><blockquote><p>后来想到使用<strong>游戏串流神器sunshine+moonlight</strong>，尝试后发现<strong>安装简单，体验非常好</strong></p><p>如果主控和被控都在同一个局域网或虚拟局域网（直连）下，体验最佳</p></blockquote><h1 id="安装sunshine">安装Sunshine</h1><p>在<strong>被控端</strong>下载sunshine</p><blockquote><p>下载链接：<a href="https://github.com/LizardByte/Sunshine/releases/tag/v0.23.1">https://github.com/LizardByte/Sunshine/releases/tag/v0.23.1</a></p></blockquote><p>安装后打开sunshine，它会跳转到浏览器<code>localhost:47990</code></p><p>简单<strong>配置下账号密码</strong>即可</p><h1 id="安装moonlight">安装Moonlight</h1><p>在<strong>主控端</strong>下载moonlight，支持多平台</p><blockquote><p>官网：<a href="https://moonlight-stream.org/">https://moonlight-stream.org/</a></p><p>PC端下载链接<code>https://github.com/moonlight-stream/moonlight-qt/releases</code></p></blockquote><p>安装后会自动识别局域网内的设备（已经启动了sunshine服务的设备）</p><p>随后需要进行<strong>Pin匹配</strong>，<strong>在被控制端输入pin码即可</strong></p><p>在Moonlight配置中可以设置分辨率、帧数，根据网络情况自行调整即可</p><h1 id="快捷键">快捷键</h1><h3 id="pc客户端">PC客户端</h3><p>PC客户端支持键盘、鼠标和触摸屏输入，以及最多4个游戏控制器（包含大多数常见游戏手柄的映射）。</p><ul><li><strong>Ctrl+Alt+Shift+Q</strong> - 退出流媒体会话（<strong>游戏将在被控主机PC上继续运行</strong>，常用！！！！！）</li><li><strong>Ctrl+Alt+Shift+Z</strong> - 切换鼠标和键盘捕获（<strong>切出到主控端</strong>，常用！！！！！）</li><li><strong>Ctrl+Alt+Shift+X</strong> - 在全屏和窗口模式之间切换</li><li><strong>Ctrl+Alt+Shift+S</strong> - 打开性能统计叠加（不支持Steam Link或Raspberry Pi）</li><li><strong>Ctrl+Alt+Shift+M</strong> - 切换鼠标模式（指针捕获或直接控制）</li><li><strong>Ctrl+Alt+Shift+V</strong> - 在主机上键入剪贴板文本</li><li><strong>Ctrl+Alt+Shift+D</strong> - 最小化流媒体窗口</li><li><strong>Ctrl+Alt+Shift+C</strong> - 在远程桌面鼠标模式下切换本地光标显示（由于GameStream限制，远程光标将始终显示）</li><li><strong>Ctrl+Alt+Shift+L</strong> - 切换将鼠标指针锁定到视频区域（需要启用“优化鼠标用于远程桌面而非游戏”选项）</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;原打算使用Windows自带的远程控制软件控制Ubuntu，需要在Ubuntu安装xrdp，但最终无法进入桌面（闪退）&lt;/p&gt;
&lt;p&gt;附加一个在ubuntu一键安装与配置xrdp脚本：&lt;a href=&quot;https://c-nergy.be/blog/?p=19814&quot;&gt;ht</summary>
      
    
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/tags/%E6%8A%98%E8%85%BE/"/>
    
  </entry>
  
  <entry>
    <title>禁用每次开机启动的Python进程</title>
    <link href="https://blog.lthero.cn/2024/06/10/DisableAuto-StartProcesses/"/>
    <id>https://blog.lthero.cn/2024/06/10/DisableAuto-StartProcesses/</id>
    <published>2024-06-10T11:51:29.000Z</published>
    <updated>2024-06-10T11:52:34.564Z</updated>
    
    <content type="html"><![CDATA[<h1 id="禁用每次开机启动的python进程">禁用每次开机启动的Python进程</h1><blockquote><p>Ubuntu系统遇到个问题，每次开机有个python进程（使用ps查到“pt_main_thread”）占用1.5GB显存，下面是查找这个进程的方法</p></blockquote><h2 id="查找工作目录">查找工作目录</h2><p><code>pt_main_thread</code> 可能是某个特定 Python 应用程序或服务的主线程，要禁用这个进程的开机启动，可以进一步排查启动项和服务配置。以下是更详细的步骤：</p><ol><li><p><strong>获取进程 ID (PID)</strong>：<br>如果你已经知道进程 ID，可以直接使用它。如果不知道，可以用以下命令查找：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep pt_main_thread</span><br></pre></td></tr></table></figure></li><li><p><strong>通过 PID 获取执行文件路径</strong>：<br>使用以下命令查看该进程的执行文件路径：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l /proc/&lt;PID&gt;/exe</span><br></pre></td></tr></table></figure><p>将 <code>&lt;PID&gt;</code> 替换为实际的进程 ID。该命令将返回指向执行文件的符号链接。</p></li><li><p><strong>查找进程启动命令和工作目录</strong>：<br>使用以下命令查看进程的启动命令和工作目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/&lt;PID&gt;/cmdline</span><br><span class="line"><span class="built_in">cat</span> /proc/&lt;PID&gt;/cwd</span><br></pre></td></tr></table></figure><p><code>cmdline</code> 文件包含了<strong>进程的启动命令</strong>，<code>cwd</code> 文件包含了进程的当前工作目录。</p></li></ol><p>通过以上步骤，可以确定 <code>pt_main_thread</code> 进程对应的执行文件和启动命令，从而更好地排查其启动来源并进行禁用或删除操作。</p><hr><h2 id="进入应用目录">进入应用目录</h2><p>首先，进入该进程的工作目录，查看其中的内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /proc/2632/cwd</span><br><span class="line"><span class="built_in">ls</span> -la</span><br></pre></td></tr></table></figure><blockquote><p>结合前面的<code>cat /proc/&lt;PID&gt;/cmdline</code>应该就能确定是哪个程序执行的</p></blockquote><h3 id="查找启动脚本或服务">查找启动脚本或服务</h3><ol><li><p><strong>检查 systemd 服务</strong>：<br>进入应用目录后，检查是否有 <code>systemd</code> 服务文件或者启动脚本。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/systemd/system</span><br><span class="line"><span class="built_in">ls</span> -la | grep -i app</span><br></pre></td></tr></table></figure><p>如果找到相关服务文件，可以禁用它：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">disable</span> &lt;service_name&gt;</span><br></pre></td></tr></table></figure></li><li><p><strong>检查 rc.local 文件</strong>：<br>查看 <code>/etc/rc.local</code> 文件，看是否有启动该 Python 脚本的命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/rc.local</span><br></pre></td></tr></table></figure><p>如果有相关命令，将其注释或删除。</p></li><li><p><strong>检查 crontab</strong>：<br>查看是否有与该 Python 脚本相关的 cron 任务：</p><ul><li><p>用户 crontab：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br></pre></td></tr></table></figure></li><li><p>系统级别的 crontab：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo crontab -e</span><br></pre></td></tr></table></figure></li></ul><p>查找并删除与该 Python 脚本相关的启动条目。</p></li><li><p><strong>检查用户启动项</strong>：<br>检查 <code>~/.config/autostart</code> 目录，看是否有与该 Python 脚本相关的启动项文件。如果有，将其删除：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> ~/.config/autostart</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;禁用每次开机启动的python进程&quot;&gt;禁用每次开机启动的Python进程&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;Ubuntu系统遇到个问题，每次开机有个python进程（使用ps查到“pt_main_thread”）占用1.5GB显存，下面是查找这个进程的方法</summary>
      
    
    
    
    <category term="运维" scheme="https://blog.lthero.cn/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
    <category term="运维" scheme="https://blog.lthero.cn/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>使用pm2管理代码运行</title>
    <link href="https://blog.lthero.cn/2024/06/05/pm2InstallAndUse/"/>
    <id>https://blog.lthero.cn/2024/06/05/pm2InstallAndUse/</id>
    <published>2024-06-05T14:18:07.000Z</published>
    <updated>2024-06-05T14:24:42.903Z</updated>
    
    <content type="html"><![CDATA[<h1 id="使用pm2管理代码运行">使用pm2管理代码运行</h1><blockquote><p>要在conda环境下使用pm2管理运行带有参数<code>--listen 0.0.0.0</code>的<code>main.py</code>脚本，可以按照以下步骤操作</p></blockquote><h2 id="安装pm2">安装pm2</h2><p>如果还没有安装pm2，可以使用npm安装。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install pm2 -g</span><br></pre></td></tr></table></figure><h2 id="创建一个启动脚本">创建一个启动脚本</h2><p>可以创建一个shell脚本，比如<code>start.sh</code>，来激活conda环境并运行<code>main.py</code>。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">source</span> activate sdv3</span><br><span class="line">python main.py --listen 0.0.0.0</span><br></pre></td></tr></table></figure><h2 id="给予执行权限">给予执行权限</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x start.sh</span><br></pre></td></tr></table></figure><h2 id="使用pm2管理脚本">使用pm2管理脚本</h2><p>使用<code>pm2</code>启动shell脚本时，使用<code>--interpreter</code>参数指定使用<code>bash</code>来运行该脚本：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 start start.sh --name Comfyui --interpreter bash</span><br></pre></td></tr></table></figure><h2 id="pm2常用命令">pm2常用命令</h2><h3 id="查看所有运行的应用">查看所有运行的应用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 list</span><br></pre></td></tr></table></figure><h3 id="查看运行状态">查看运行状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 status</span><br></pre></td></tr></table></figure><h3 id="停止应用">停止应用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 stop Comfyui</span><br></pre></td></tr></table></figure><h3 id="重启应用">重启应用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 restart Comfyui</span><br></pre></td></tr></table></figure><h3 id="查看日志">查看日志</h3><ol><li><p><strong>查看所有应用的实时日志</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 logs</span><br></pre></td></tr></table></figure></li><li><p><strong>查看特定应用的实时日志</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 logs &lt;app-name&gt;</span><br></pre></td></tr></table></figure><p>例如，如果你的应用名为<code>sdv3-app</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 logs sdv3-app</span><br></pre></td></tr></table></figure></li><li><p><strong>查看特定应用的错误日志</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 logs &lt;app-name&gt; --err</span><br></pre></td></tr></table></figure><p>例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 logs sdv3-app --err</span><br></pre></td></tr></table></figure></li><li><p><strong>查看特定应用的标准输出日志</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 logs &lt;app-name&gt; --out</span><br></pre></td></tr></table></figure><p>例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 logs sdv3-app --out</span><br></pre></td></tr></table></figure></li><li><p><strong>查看最近的100行日志</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 logs --lines 100</span><br></pre></td></tr></table></figure></li><li><p><strong>查看特定应用的最近100行日志</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 logs &lt;app-name&gt; --lines 100</span><br></pre></td></tr></table></figure><p>例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 logs sdv3-app --lines 100</span><br></pre></td></tr></table></figure></li><li><p><strong>查看日志文件位置</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 info &lt;app-name&gt;</span><br></pre></td></tr></table></figure><p>例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 info sdv3-app</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;使用pm2管理代码运行&quot;&gt;使用pm2管理代码运行&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;要在conda环境下使用pm2管理运行带有参数&lt;code&gt;--listen 0.0.0.0&lt;/code&gt;的&lt;code&gt;main.py&lt;/code&gt;脚本，可以按照以下步骤操作</summary>
      
    
    
    
    <category term="机器学习" scheme="https://blog.lthero.cn/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="机器学习" scheme="https://blog.lthero.cn/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>监控GPU是否可用</title>
    <link href="https://blog.lthero.cn/2024/05/26/shell-monitorGPU/"/>
    <id>https://blog.lthero.cn/2024/05/26/shell-monitorGPU/</id>
    <published>2024-05-26T15:28:59.000Z</published>
    <updated>2024-05-27T14:52:58.732Z</updated>
    
    <content type="html"><![CDATA[<h1 id="创建脚本">创建脚本</h1><blockquote><p>脚本功能：脚本监控GPU使用率，并在GPU内存使用率低于20%时执行指定脚本</p></blockquote><p>在任意位置创建<code>mgpu</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim mgpu</span><br></pre></td></tr></table></figure><p>把下面的内容粘贴上去</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">param1=<span class="variable">$1</span></span><br><span class="line">param2=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ANSI color codes</span></span><br><span class="line">GREEN=<span class="string">&quot;\033[0;32m&quot;</span></span><br><span class="line">RED=<span class="string">&quot;\033[0;31m&quot;</span></span><br><span class="line">BLUE=<span class="string">&quot;\033[0;34m&quot;</span></span><br><span class="line">RESET=<span class="string">&quot;\033[0m&quot;</span></span><br><span class="line">threshold=20</span><br><span class="line"></span><br><span class="line">log_file_global=<span class="string">&quot;/home/dongli911/mgpu.log&quot;</span>  <span class="comment"># 全局日志文件路径</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成一个基于时间戳的唯一ID</span></span><br><span class="line">script_id=$(<span class="built_in">date</span> +%s)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否请求查看当前运行的脚本</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$param1</span>&quot;</span> == <span class="string">&quot;ps&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;BLUE&#125;</span>当前正在运行的脚本:<span class="variable">$&#123;RESET&#125;</span>&quot;</span></span><br><span class="line">    grep <span class="string">&quot;Status: Running&quot;</span> <span class="variable">$log_file_global</span></span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果输入了-g参数，根据后续参数生成模板并退出</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$param1</span>&quot;</span> == <span class="string">&quot;-g&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    script_name=<span class="string">&quot;<span class="variable">$&#123;param2:-run_python&#125;</span>&quot;</span></span><br><span class="line">    template_path=<span class="string">&quot;./<span class="variable">$&#123;script_name&#125;</span>.sh&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;正在当前目录<span class="variable">$&#123;template_path&#125;</span>生成 <span class="variable">$&#123;GREEN&#125;</span> <span class="variable">$&#123;script_name&#125;</span>.sh <span class="variable">$&#123;RESET&#125;</span> 模板...&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &gt; <span class="string">&quot;<span class="variable">$template_path</span>&quot;</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 激活 Conda 环境 (不要删除下面这行!)</span></span><br><span class="line"><span class="string">source /opt/anaconda3/etc/profile.d/conda.sh</span></span><br><span class="line"><span class="string"># 选择要激活的环境 (修改下一行以激活你偏好的环境)</span></span><br><span class="line"><span class="string">conda activate sdv3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 执行 Python 脚本, 后面可以接参数</span></span><br><span class="line"><span class="string">python ~/.wan/aigc/main.py</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">chmod</span> +x <span class="string">&quot;<span class="variable">$template_path</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>模板 &#x27;<span class="variable">$&#123;script_name&#125;</span>.sh&#x27; <span class="variable">$&#123;RESET&#125;</span> 已创建并设置为可执行状态，位于当前目录。&quot;</span></span><br><span class="line">    <span class="comment"># 记录生成模板操作</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$script_id</span> - <span class="subst">$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)</span> - <span class="variable">$&#123;USER&#125;</span> - <span class="variable">$&#123;PWD&#125;</span> - Generated script template: <span class="variable">$&#123;script_name&#125;</span>.sh&quot;</span> &gt;&gt; <span class="variable">$log_file_global</span></span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否有输入参数或者是否输入了 -h</span></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="string">&quot;<span class="variable">$param1</span>&quot;</span> || <span class="string">&quot;<span class="variable">$param1</span>&quot;</span> == <span class="string">&quot;-h&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;BLUE&#125;</span>此脚本监控GPU使用率，并在GPU内存使用率低于20%时执行指定脚本。<span class="variable">$&#123;RESET&#125;</span>\n&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;生成脚本模板&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;用法: <span class="variable">$&#123;GREEN&#125;</span><span class="variable">$0</span> -g [script_name]<span class="variable">$&#123;RESET&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;  如: <span class="variable">$&#123;GREEN&#125;</span><span class="variable">$0</span> -g lthero<span class="variable">$&#123;RESET&#125;</span>，则生成lthero.sh&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;  如: <span class="variable">$&#123;GREEN&#125;</span><span class="variable">$0</span> -g <span class="variable">$&#123;RESET&#125;</span>，则生成默认名run_python.sh\n&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;运行脚本&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;用法: <span class="variable">$&#123;GREEN&#125;</span><span class="variable">$0</span> &lt;要执行的脚本&gt;<span class="variable">$&#123;RESET&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;  如: <span class="variable">$&#123;GREEN&#125;</span><span class="variable">$0</span> lthero.sh<span class="variable">$&#123;RESET&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;  如: <span class="variable">$&#123;GREEN&#125;</span><span class="variable">$0</span> run_python.sh<span class="variable">$&#123;RESET&#125;</span>\n&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;查看正在运行的脚本&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;用法: <span class="variable">$&#123;GREEN&#125;</span><span class="variable">$0</span> ps<span class="variable">$&#123;RESET&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查文件是否存在</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$param1</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;如果GPU可用，将执行脚本 <span class="variable">$&#123;GREEN&#125;</span> $param1<span class="variable">$&#123;RESET&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>错误：未找到脚本 <span class="variable">$param1</span> 或脚本不可执行。<span class="variable">$&#123;RESET&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置日志文件</span></span><br><span class="line">log_file=<span class="string">&quot;./<span class="variable">$&#123;param1%.*&#125;</span>.log&quot;</span></span><br><span class="line">counter=0</span><br><span class="line"><span class="keyword">while</span> [[ -f <span class="string">&quot;<span class="variable">$log_file</span>&quot;</span> ]]; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">let</span> counter+=1</span><br><span class="line">    log_file=<span class="string">&quot;./<span class="variable">$&#123;param1%.*&#125;</span><span class="variable">$counter</span>.log&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录执行脚本操作</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$script_id</span> - <span class="subst">$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)</span> - <span class="variable">$&#123;USER&#125;</span> - <span class="variable">$&#123;PWD&#125;</span> - Executed script: <span class="variable">$param1</span> - Status: Running&quot;</span> &gt;&gt; <span class="variable">$log_file_global</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 持续检测GPU占用，并将输出重定向到日志文件</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    usage=$(nvidia-smi --query-gpu=memory.used,memory.total --format=csv,noheader,nounits | awk <span class="string">&#x27;&#123;print ($1/$2)*100&#125;&#x27;</span>)</span><br><span class="line">    usage_lt_threshold=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$usage</span> &lt; <span class="variable">$threshold</span> &quot;</span> | bc)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;当前GPU内存使用率为 <span class="variable">$usage</span>%&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$log_file</span>&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$usage_lt_threshold</span>&quot;</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;当前GPU内存使用率低于<span class="variable">$&#123;threshold&#125;</span>%，将执行脚本&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$log_file</span>&quot;</span></span><br><span class="line">        bash <span class="variable">$param1</span> &gt;&gt; <span class="string">&quot;<span class="variable">$log_file</span>&quot;</span> 2&gt;&amp;1</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>脚本 <span class="variable">$param1</span> 已执行。<span class="variable">$&#123;RESET&#125;</span>&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$log_file</span>&quot;</span></span><br><span class="line">        sed -i <span class="string">&quot;/<span class="variable">$script_id</span>/c\\<span class="variable">$script_id</span> - <span class="subst">$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)</span> - <span class="variable">$&#123;USER&#125;</span> - <span class="variable">$&#123;PWD&#125;</span> - Executed script: <span class="variable">$param1</span> - Status: Completed&quot;</span> <span class="variable">$log_file_global</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">sleep</span> 60</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">) &amp;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>脚本已转至后台运行。<span class="variable">$&#123;RESET&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>随后，放在全局可用的地方</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mv</span> ./mgpu /usr/local/bin/mgpu</span><br></pre></td></tr></table></figure><h1 id="使用脚本">使用脚本</h1><h2 id="说明">说明</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_file_global=<span class="string">&quot;/home/mgpu.log&quot;</span>  <span class="comment"># 全局日志文件路径</span></span><br></pre></td></tr></table></figure><p>这里设置了全局的日志文件位置，可以修改</p><p>全局日志会记录ID号、运行时刻，运行状态、目录、脚本名等信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1716812372 - 2024-05-27 20:19:32 - dongli911 - /home/ - Executed script: 1picwait4extract.sh - Status: Running</span><br></pre></td></tr></table></figure><h3 id="脚本说明">脚本说明</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mgpu</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">mgpu -h</span><br></pre></td></tr></table></figure><h3 id="生成脚本模板">生成脚本模板</h3><p>​        用法: <code>/usr/local/bin/mgpu -g [script_name]</code><br>​        如 <code>mgpu -g lthero</code> 会生成:lthero.sh<br>​        如 <code>mgpu -g</code>  会生成默认名:run_python.sh</p><h3 id="运行脚本">运行脚本</h3><p>​        用法: <code>/usr/local/bin/mgpu &lt;要执行的脚本&gt;</code><br>​        如 <code>/usr/local/bin/mgpu lthero.sh</code></p><h2 id="举例">举例</h2><blockquote><p>进入要运行的py目录，如~/test/目录下有main.py，需要的conda环境为sdv3</p></blockquote><h3 id="生成脚本模板">生成脚本模板</h3><p>先进入输入<code>mgpu -g</code>，随后在~/test/目录下有<code>run_python.sh</code>文件，打开run_python.sh进行编辑，在第6行修改成需要用的环境，第9行修改成需要运行的main.py代码</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 激活 Conda 环境 (不要删除下面这行!)</span></span><br><span class="line"><span class="built_in">source</span> /opt/anaconda3/etc/profile.d/conda.sh</span><br><span class="line"><span class="comment"># 选择要激活的环境 (修改下一行以激活你偏好的环境)</span></span><br><span class="line">conda activate sdv3 <span class="comment"># 修改这行内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行 Python 脚本, 后面可以接参数</span></span><br><span class="line">python ~/.wan/aigc/main.py <span class="comment"># 修改这行内容</span></span><br></pre></td></tr></table></figure><p>修改好后，保存这个<code>run_python.sh</code>文件</p><h3 id="运行定制脚本">运行定制脚本</h3><p>在<code>~/test/</code>目录下运行以下代码即可在后台监控GPU，并空闲时执行代码</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mgpu run_python.sh</span><br></pre></td></tr></table></figure><p>代码输出的日志保存在<code>~/test/</code>目录下的run_python.log，如果多次运行，日志会自动排序run_python.log1，run_python.log2……</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;创建脚本&quot;&gt;创建脚本&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;脚本功能：脚本监控GPU使用率，并在GPU内存使用率低于20%时执行指定脚本&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;在任意位置创建&lt;code&gt;mgpu&lt;/code&gt;&lt;/p&gt;
&lt;figure cla</summary>
      
    
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/tags/%E6%8A%98%E8%85%BE/"/>
    
  </entry>
  
  <entry>
    <title>zeroTier|自建服务器与旁路由使用</title>
    <link href="https://blog.lthero.cn/2024/05/25/install-zeroTier/"/>
    <id>https://blog.lthero.cn/2024/05/25/install-zeroTier/</id>
    <published>2024-05-25T14:54:59.000Z</published>
    <updated>2024-09-06T15:21:44.434Z</updated>
    
    <content type="html"><![CDATA[<h1 id="安装zerotier">安装zerotier</h1><blockquote><p>参考：<a href="https://zhuanlan.zhihu.com/p/123956151">https://zhuanlan.zhihu.com/p/123956151</a></p><p><a href="https://blog.csdn.net/coldboy258/article/details/93133860">https://blog.csdn.net/coldboy258/article/details/93133860</a></p><p><a href="https://post.smzdm.com/p/a7nwn8q9/">https://post.smzdm.com/p/a7nwn8q9/</a></p><p>视频解释：<a href="https://www.bilibili.com/video/BV1Vh411F7Mr/">https://www.bilibili.com/video/BV1Vh411F7Mr/</a></p></blockquote><p>Zerotier服务分为两部分，控制器和root</p><p>Zerotier官方提供了自建的文档，其中web后台属于“controllers（控制器）”，控制器是开源的，但不提供webui，GitHub上有开源的ui项目，比如zero-ui和ztncui。</p><p><strong>控制器</strong>使用根的API创建和管理网络，不参与流量通信。</p><p><strong>根服务器</strong>（Root Server）负责流量转发和P2P通信，根服务器如果是完全自建的话，那就是私服，不参与官方的节点网络，也就是Zerotier中的“Planet（行星节点）”的概念。</p><p>如果想<strong>使用官方的Planet的同时使用自己的根服务器</strong>，那就是以<strong>Moon</strong>（月亮节点）的形式加入到网络中。两者用起来其实没有区别，只是标识不同，无论是自建的Planet还是Moon，都可以被自建的控制器调用。</p><p>但有一点需要注意，<strong>自建控制器的网络和官方web后台不通用</strong>，你不会在官方web后台看到你在自建控制器上创建的网络，反过来也一样，自建控制器也看不到官方控制器创建的网络。但网络ID的加入是可以通用的，即使你不搭建自己的Moon节点，同样也可以使用自己的控制器+官方的Planet进行通信。</p><hr><h2 id="创建虚拟局域网">创建虚拟局域网</h2><p>在zerotier官网上注册账号，并创建一个虚拟局域网</p><h2 id="下载与自动安装">下载与自动安装</h2><p>zerotier官方提供了比较方便的安装方式,一条命令即可完成:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s https://install.zerotier.com/ | sudo bash</span><br></pre></td></tr></table></figure><h2 id="加入网络">加入网络</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zerotier-cli <span class="built_in">join</span> fadxxxxx5eb45a9</span><br></pre></td></tr></table></figure><p>随后，在zerotier官网上同意这个设备的接入，此设备就加入虚拟局域网成功了</p><h1 id="注册成为moon">注册成为Moon</h1><blockquote><p>这里的Moon是中继服务器，默认用使用官方的中继服务器，但延迟较高；</p><p>Moon只有在直连失败时才会使用中继服务器进行中转</p></blockquote><h2 id="生成moon配置文件">生成moon配置文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/lib/zerotier-one <span class="comment">#安装好zerotier后,自动会安装到此目录</span></span><br><span class="line">sudo zerotier-idtool initmoon identity.public &gt; moon.json    <span class="comment">#该命令将id文件转换为能用于配置的json</span></span><br></pre></td></tr></table></figure><h2 id="修改配置文件moon-json">修改配置文件moon.json</h2><p>主要是添加公网IP，修改内容如下, 9993是默认端口</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;stableEndpoints&quot;</span>: [ <span class="string">&quot;23.23.23.23/9993&quot;</span> ]</span><br></pre></td></tr></table></figure><blockquote><p>注:23.23.23.23为公网ip, 一定要配置正确,Zerotier依靠此配置去连接moon.</p><p>后面的端口若没有改变则默认都是9993端口, 且是UDP协议的, 此处在防火墙上需要开放UDP,否则是连接不上Moon的.</p></blockquote><p>该配置里面,有一个id字段,10个字符,如: [ “id”: “18fasd2319” ] 就是moon的id, 在客户端连接时,需要用到它</p><blockquote><p>这里的id还可以通过以下两个命令得到</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">grep <span class="built_in">id</span> /var/lib/zerotier-one/moon.json | <span class="built_in">head</span> -n 1</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">zerotier-cli info</span><br></pre></td></tr></table></figure><h2 id="生成moon文件">生成moon文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo zerotier-idtool genmoon moon.json </span><br></pre></td></tr></table></figure><p>执行该命令后,会在在/var/lib/zerotier-one目录下生成一个类似000000<strong>18fasd2319</strong>.moon的文件…这个文件非常重要,所有的客户端要连接上moon都是依靠该文件关联的…</p><h2 id="使moon配置文件生效">使moon配置文件生效</h2><p>在<code>/var/lib/zerotier-one</code>目录下,新建一个 <code>moons.d</code> 文件夹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> moons.d/</span><br></pre></td></tr></table></figure><p>并将刚生成的<code>moon配置文件</code>放到该文件夹下</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> 000000**18fasd2319**.moon moons.d/</span><br></pre></td></tr></table></figure><h2 id="重新启动moon服务器">重新启动Moon服务器</h2><p>由于使用命令安装时会自动注册为服务,所以可以依靠以下命令完成启动或重启**（执行一个即可）**</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">service zerotier-one restart  <span class="comment">#服务重启命令</span></span><br><span class="line"></span><br><span class="line">/etc/init.d/zerotier-one restart <span class="comment">#服务重启命令</span></span><br><span class="line"></span><br><span class="line">service zerotier-one start <span class="comment">#服务启动命令</span></span><br><span class="line"></span><br><span class="line">zerotier-one -d <span class="comment">#或直接程序启动</span></span><br></pre></td></tr></table></figure><p>经过以上配置,服务器上的moon即配置并应用完闭.</p><h1 id="客户端使用moon">客户端使用Moon</h1><blockquote><p>假设已经“A服务器”为了Moon，此时让&quot;B服务器&quot;设置&quot;A&quot;为其Moon服务器</p><p>接下来就需要在各客户端zerotier上配置,并连接此服务器</p></blockquote><p>有两种方法可以完成.</p><h2 id="方法1-自动">方法1(自动)</h2><p>只需执行此命令即可,<strong>此处需要输入两遍id</strong>:</p><blockquote><p>zerotier-cli orbit <strong>18fasd2319</strong> <strong>18fasd2319</strong></p></blockquote><p>(此种方法依赖<strong>zerotier的根服务器</strong>,若根服务器连接不上,则会无效,由于不确定性</p><h2 id="方法2-手动">方法2(手动)</h2><p><strong>Linux:</strong></p><ol><li>直接在zerotier目录(<code>/var/lib/zerotier-one/</code>)下,创建<code>moons.d</code>文件夹</li><li>并且将生成的000000<strong>18fasd2319</strong>.moon文件拷入</li><li><strong>重启服务</strong>即可</li></ol><p><strong>Windows:</strong></p><ol><li>打开服务程序services.msc, 找到服务&quot;ZeroTier One&quot;</li><li>在属性内找到该服务可执行文件路径,我的环境下为C:\ProgramData\ZeroTier\One\zerotier-one_x64.exe</li><li>打开该文件夹, 并且在其下建立moons.d文件夹</li><li>将moon服务器下生成的000000<strong>18fasd2319</strong>.moon文件,拷贝到此文件夹内…<strong>再重启该服务即可</strong>…</li></ol><blockquote><p>此处<strong>重启的是该项服务</strong>,<strong>不是电脑右下角的图标程序</strong>…网上大多资料都没法特别说明,或者含糊没说清,甚至重启电脑之类的说法都说出来了,比较马虎…右下角任务栏程序路径是在C:\Program Files (x86)\ZeroTier\One目录下,而服务路径却并非在该路径,若将moons.d文件夹放不对位置,是无法连上Moon服务器的.)</p></blockquote><h2 id="验证生效">验证生效</h2><p>要验证是否moon生效,只需要在客户端zerotier程序目录下,执行以下命令即可:</p><p>windows/linux通用命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zerotier-cli listpeers</span><br></pre></td></tr></table></figure><p>若有类似地址,即可证明moon连接成功</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">200 listpeers 18fasd2319 23.23.23.23/9994;4242;4038 224 1.2.12 MOON</span><br></pre></td></tr></table></figure><hr><h1 id="在旁路由使用zerotier">在旁路由使用zerotier</h1><blockquote><p>假设openwrt旁路由的实际局域网为192.168.6.155</p><p>这种方式，必须让<strong>192.168.6.0/24</strong>网段下的设备，设置其网关和DNS为旁路由ip地址</p></blockquote><p>打开openwrt网页中的zerotier软件，填写虚拟局域网ID，点击启用即可，随后保存并应用</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/image-20240525231051219.png" alt="image-20240525231051219"></p><p>随后在zerotier的网站上，允许openwrt系统接入，在旁路由输入以下命令来判断是否加入成功</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zerotier-cli listnetworks</span><br></pre></td></tr></table></figure><p>返回值如下即加入成功，并且虚拟局域网ip为：<strong>172.22.33.155</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">200 listnetworks &lt;nwid&gt; &lt;name&gt; &lt;mac&gt; &lt;status&gt; &lt;<span class="built_in">type</span>&gt; &lt;dev&gt; &lt;ZT assigned ips&gt;</span><br><span class="line">200 listnetworks fada252630165xxx xxxxxx bb:95:e9:ff:ee:64 OK PRIVATE zasdhyt5n4 172.22.33.155/16</span><br></pre></td></tr></table></figure><blockquote><p>为了让旁路由下的所有设备（不下载zerotier）直接可以访问虚拟局域网所有设备</p><p>并且这些<strong>设备本身不要在zerotier加入虚拟局域网，否则会出现环路，如果已经加入了就取消auth</strong></p></blockquote><p><strong>自动允许客户端 NAT</strong> 要打开，随后保存并应用</p><p>随后在zerotier的网站上，<strong>Add Routes</strong>填写以下内容</p><p>Destination写局域网的网段，如<strong>192.168.6.0/24</strong>；Via写旁路由的虚拟ip：<strong>172.22.33.155</strong></p><p><img src="https://cdn.lthero.cn/post_images/course/ML/image-20240525231559150.png" alt="image-20240525231559150"></p><blockquote><p>从而，虚拟局域网所有设备与<strong>192.168.6.0/24</strong>网段下的所有设备互通</p></blockquote><hr><h1 id="查看所有设备">查看所有设备</h1><p>由于ZeroTier的Web管理端做的不是很易用，每次都登录<code>my.zerotier.com</code>查看信息特别不方便。调研了一下，发现ZeroTier官方提供的API接口 <a href="https://docs.zerotier.com/central/v1/#tag/network-member">Returns a list of Members on the network</a>正好能提供我所需要的信息。所以写了一个one-line shell命令在终端用表格展示一下结果。</p><p>首先，安装必备的软件。这行命令需要<code>curl</code>和<code>jq</code>这两个工具。Linux一般默认安装了<code>curl</code>，<code>jq</code>则需要手动安装。安装命令为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jq官方安装文档：https://stedolan.github.io/jq/download/</span></span><br><span class="line"><span class="comment"># Ubuntu</span></span><br><span class="line">sudo apt-get install jq</span><br><span class="line"><span class="comment"># Arch</span></span><br><span class="line">sudo pacman -S  jq</span><br><span class="line"><span class="comment"># Mac</span></span><br><span class="line">sudo brew install jq</span><br></pre></td></tr></table></figure><p>然后，申请一个ZeroTier的管理Token，在 <a href="https://my.zerotier.com/account">Account</a>页面的<code>API Access Tokens</code>处新建一个Token即可。</p><p>最后，执行下面的one-line脚本：</p><p>请自行替换<Token>和<NetworkID>为你申请的Token和你的网络ID</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># bearer和token中间的空格不能省略。这个是ZeroTier官方指定的。</span></span><br><span class="line">curl -s -X GET -H <span class="string">&quot;Authorization: bearer &lt;Token&gt;&quot;</span> https://my.zerotier.com/api/v1/network/&lt;NetworkID&gt;/member  |  jq -r <span class="string">&#x27;([&quot;   NodeID   &quot;, &quot;Online&quot;, &quot;ZerotierIP&quot;, &quot;  PhysicalIP  &quot;, &quot;Name&quot;] | (., map(length*&quot;-&quot;))),(.[] | [.config.id, .online,.config.ipAssignments[0] , .physicalAddress, .name]) | @tsv&#x27;</span></span><br></pre></td></tr></table></figure><p>输出结果类似于：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   NodeID       Online  ZerotierIP        PhysicalIP    Name</span><br><span class="line">------------    ------  ----------      --------------  ----</span><br><span class="line">f481514ad3      true    10.4.1.1        125.155.212.118 A1</span><br><span class="line">f55176bfa2      false   10.4.1.2        125.157.213.8   A2</span><br><span class="line">f765b69b0a      false   10.4.1.3        125.158.146.205 A3</span><br></pre></td></tr></table></figure><h1 id="附录">附录</h1><blockquote><p>由于很多人对配置服务端的moon都会有修改端口的需求，方法如下，但我没成功</p></blockquote><p><strong>在运行程序同级目录下建立local.conf文件:</strong></p><p><strong>文件内容配置如下,primaryPort即为想要配置的端口:</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="string">&quot;settings&quot;</span>:</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="string">&quot;primaryPort&quot;</span>:9994</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>local.conf 完整配置示例如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;physical&quot;: &#123; /* Settings that apply to physical L2/L3 network paths. */</span><br><span class="line">        &quot;NETWORK/bits&quot;: &#123; /* Network e.g. 10.0.0.0/24 or fd00::/32 */</span><br><span class="line">            &quot;blacklist&quot;: true|false, /* If true, blacklist this path for all ZeroTier traffic */</span><br><span class="line">            &quot;trustedPathId&quot;: 0|!0 /* If present and nonzero, define this as a trusted path (see below) */</span><br><span class="line">        &#125; /* ,... additional networks */</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;virtual&quot;: &#123; /* Settings applied to ZeroTier virtual network devices (VL1) */</span><br><span class="line">        &quot;##########&quot;: &#123; /* 10-digit ZeroTier address */</span><br><span class="line">            &quot;try&quot;: [ &quot;IP/port&quot;/*,...*/ ], /* Hints on where to reach this peer if no upstreams/roots are online */</span><br><span class="line">            &quot;blacklist&quot;: [ &quot;NETWORK/bits&quot;/*,...*/ ] /* Blacklist a physical path for only this peer. */</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;settings&quot;: &#123; /* Other global settings */</span><br><span class="line">        &quot;primaryPort&quot;: 0-65535, /* If set, override default port of 9993 and any command line port */</span><br><span class="line">        &quot;portMappingEnabled&quot;: true|false, /* If true (the default), try to use uPnP or NAT-PMP to map ports */</span><br><span class="line">        &quot;softwareUpdate&quot;: &quot;apply&quot;|&quot;download&quot;|&quot;disable&quot;, /* Automatically apply updates, just download, or disable built-in software updates */</span><br><span class="line">        &quot;softwareUpdateChannel&quot;: &quot;release&quot;|&quot;beta&quot;, /* Software update channel */</span><br><span class="line">        &quot;softwareUpdateDist&quot;: true|false, /* If true, distribute software updates (only really useful to ZeroTier, Inc. itself, default is false) */</span><br><span class="line">        &quot;interfacePrefixBlacklist&quot;: [ &quot;XXX&quot;,... ], /* Array of interface name prefixes (e.g. eth for eth#) to blacklist for ZT traffic */</span><br><span class="line">        &quot;allowManagementFrom&quot;: &quot;NETWORK/bits&quot;|null, /* If non-NULL, allow JSON/HTTP management from this IP network. Default is 127.0.0.1 only. */</span><br><span class="line">        &quot;allowTcpFallbackRelay&quot;: true|false /* Allow or disallow establishment of TCP relay connections (true by default) */</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;安装zerotier&quot;&gt;安装zerotier&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://zhuanlan.zhihu.com/p/123956151&quot;&gt;https://zhuanlan.zhihu.com/p/1239561</summary>
      
    
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/tags/%E6%8A%98%E8%85%BE/"/>
    
  </entry>
  
  <entry>
    <title>服务器上建立画廊</title>
    <link href="https://blog.lthero.cn/2024/05/12/InstallHomeGalleryOnSelfHost/"/>
    <id>https://blog.lthero.cn/2024/05/12/InstallHomeGalleryOnSelfHost/</id>
    <published>2024-05-12T14:22:33.000Z</published>
    <updated>2024-10-21T07:24:44.889Z</updated>
    
    <content type="html"><![CDATA[<h1 id="自建画廊">自建画廊</h1><blockquote><p>home-gallery项目：<a href="https://docs.home-gallery.org/install/">https://docs.home-gallery.org/install/</a></p></blockquote><p>我是将Onedrive挂载到服务器上，再在服务器运行home-gallery</p><p>挂载Onedrive到服务器的教程：<a href="https://blog.lthero.cn/2024/05/12/MountOneDriveUsingRclone/">https://blog.lthero.cn/2024/05/12/MountOneDriveUsingRclone/</a></p><h2 id="docker">Docker</h2><p>HomeGallery 的docker镜像下载 <a href="https://hub.docker.com/r/xemle/home-gallery">xemle/home-gallery</a> (amd64, arm64, arm/v7 and arm/v6 architecture).</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull xemle/home-gallery</span><br></pre></td></tr></table></figure><h3 id="data-volume-structure">Data volume structure</h3><p>The gallery application is located at <code>/app</code> whereas the data is stored in <code>/data</code> within the container. The <code>/data</code> folder has following structure:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">`-- /data - Docker data volume</span><br><span class="line">  +-- sources - Your media file sources or other volumne mounts</span><br><span class="line">  +-- config - File index, database and configuration files</span><br><span class="line">  | `-- gallery.config.yml - Main configuration file</span><br><span class="line">  `-- storage - Preview images and meta data</span><br></pre></td></tr></table></figure><p>The media volumes should be mounted into the <code>/data</code> directory. Eg. mount your host directory <code>~/Pictures</code> to <code>/data/Pictures</code> in the container and add it as source to your <code>gallery.config.yml</code>.</p><p>To avoid user permission problems it is advisable to run the container with your user and group id via <code>-u</code> parameter.</p><h3 id="quickstart">Quickstart</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建home-gallery，保存数据</span></span><br><span class="line"><span class="built_in">mkdir</span> home-gallery</span><br><span class="line"><span class="built_in">cd</span> home-gallery</span><br><span class="line"><span class="built_in">mkdir</span> -p data</span><br><span class="line"><span class="built_in">alias</span> gallery=<span class="string">&quot;docker run -d -ti --rm \</span></span><br><span class="line"><span class="string">  -v <span class="subst">$(pwd)</span>/data:/data \</span></span><br><span class="line"><span class="string">  -v /root/OneDrive/Photos/Z30/:/data/Pictures \</span></span><br><span class="line"><span class="string">  -u <span class="subst">$(id -u)</span>:<span class="subst">$(id -g)</span> \</span></span><br><span class="line"><span class="string">  -p 3000:3000 xemle/home-gallery \</span></span><br><span class="line"><span class="string">  -e GALLERY_WATCH_POLL_INTERVAL=60&quot;</span></span><br><span class="line">gallery run init --<span class="built_in">source</span> /data/Pictures</span><br><span class="line">gallery run server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">sudo docker logs -f 容器<span class="built_in">id</span></span><br></pre></td></tr></table></figure><p>把<code>/root/Onedrive/Photos/Z30/</code>修改成本地的相册目录（后面的<code>:/data/Pictures</code>不要动），运行server后，浏览器上打开<a href="http://localhost:3000/">localhost:3000</a>即可</p><blockquote><p>The docker container is configured to poll image sources each 5 minutes for compatibility reasons of slow or large media volumes. Check if inotify through disabled polling by <code>GALLERY_WATCH_POLL_INTERVAL=0</code> is working for you.</p><p>它会在后台生成图像的缩略图，这里有个间隔设置啊(-e GALLERY_WATCH_POLL_INTERVAL=60)，每1分钟会更新一批照片，所以运行了<code>gallery run server</code>后，可以多等一会儿</p></blockquote><h1 id="使用http访问">使用HTTP访问</h1><p>要将运行在Docker容器中的服务通过域名访问，并使用Nginx作为反向代理来转发到宿主机的3000端口，你需要完成几个步骤。这包括设置DNS记录、配置Nginx以及确保网络安全。下面是具体步骤：</p><h2 id="步骤-1-设置dns记录">步骤 1: 设置DNS记录</h2><p>确保你的域名 <code>gallery.lthero.top</code> 的DNS记录指向托管Nginx的服务器的IP地址。这通常在你的域名注册商处进行设置：</p><ul><li><strong>A记录</strong>：将域名指向IPv4地址。</li><li><strong>AAAA记录</strong>：将域名指向IPv6地址（如果适用）。</li></ul><h2 id="步骤-2-安装并启动nginx">步骤 2: 安装并启动Nginx</h2><p>步骤 1: 更新软件包列表</p><p>打开终端，首先使用<code>apt</code>命令更新你的包列表，以确保你安装的是最新版本的Nginx。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure><p>步骤 2: 安装Nginx</p><p>使用<code>apt</code>安装Nginx。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure><h2 id="步骤-3-配置nginx">步骤 3: 配置Nginx</h2><p>你需要在Nginx中创建一个新的服务器块（server block），或者在已有的默认配置中修改，以设置反向代理。以下是一个基本的Nginx配置示例，将会把所有到 <code>gallery.lthero.top</code> 的请求转发到本地的3000端口：</p><ol><li><p>打开或创建一个新的Nginx配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-available/gallery.lthero.top</span><br></pre></td></tr></table></figure></li><li><p>添加以下配置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> gallery.lthero.top;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:3000;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&#x27;upgrade&#x27;</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个配置做了以下几点：</p><ul><li><code>listen 80;</code> 告诉Nginx监听80端口（HTTP标准端口）。</li><li><code>server_name gallery.lthero.top;</code> 设置这个块应当响应的域名。</li><li><code>proxy_pass http://localhost:3000;</code> 指定所有传入的请求转发到本地的3000端口。</li><li><code>proxy_set_header</code> 指令将重要的HTTP头信息转发给后端应用。</li></ul></li><li><p>启用配置文件通过创建一个符号链接(一定要做)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -s /etc/nginx/sites-available/gallery.lthero.top /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure></li><li><p>检查Nginx配置文件是否有语法错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br></pre></td></tr></table></figure></li><li><p>如果没有错误，重启Nginx以应用配置(一定要做)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure></li></ol><h2 id="步骤-4-调整防火墙规则">步骤 4: 调整防火墙规则</h2><p>确保你的服务器的防火墙规则允许HTTP（端口80）和HTTPS（端口443，如果你使用SSL）的流量。如果你正在使用<code>ufw</code>，可以使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow <span class="string">&#x27;Nginx Full&#x27;</span></span><br><span class="line">sudo ufw reload</span><br></pre></td></tr></table></figure><h2 id="步骤-5-测试配置">步骤 5: 测试配置</h2><p>在浏览器中输入 <code>http://gallery.lthero.top</code> 或使用命令行工具如 <code>curl</code> 来测试你的配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://gallery.lthero.top</span><br></pre></td></tr></table></figure><p>你应该能看到从Docker容器中运行的服务响应的内容。</p><p>这样，你就配置好了Nginx作为反向代理，将域名 <code>gallery.lthero.top</code> 的流量转发到宿主机的3000端口上的服务。如果你希望使用HTTPS，你还需要设置SSL证书，可以考虑使用Let’s Encrypt免费证书并配置HTTPS。</p><h1 id="使用https访问">使用HTTPS访问</h1><p>要让你的域名 <code>gallery.lthero.top</code> 使用 HTTPS，你需要获取 SSL/TLS 证书，并配置 Nginx 以使用这些证书来加密网页内容。以下是详细的步骤，包括如何使用 Let’s Encrypt 提供的免费证书自动化这个过程。</p><h2 id="步骤-1-安装-certbot">步骤 1: 安装 Certbot</h2><p>Certbot 是一个自动获取并安装 Let’s Encrypt 证书的客户端。在 Ubuntu 上安装 Certbot 及其 Nginx 插件非常简单：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install certbot python3-certbot-nginx</span><br></pre></td></tr></table></figure><h2 id="步骤-2-获取和安装证书">步骤 2: 获取和安装证书</h2><p>使用 Certbot 获取并为你的域名安装证书：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot --nginx -d gallery.lthero.top</span><br></pre></td></tr></table></figure><p>此命令会自动为指定的域名 <code>gallery.lthero.top</code> 配置 SSL 证书，并更新 Nginx 配置以使用这些证书。Certbot 会询问你一些问题，比如电子邮件地址（用于紧急联系和证书续订提醒），以及是否重定向所有 HTTP 请求到 HTTPS（强烈建议启用）。</p><p>生成的证书位置<code>/etc/letsencrypt/live/</code></p><h2 id="步骤-3-更新-nginx-配置">步骤 3: 更新 Nginx 配置</h2><p>如果你想手动编辑 Nginx 配置文件，可以按以下方式配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-available/gallery.lthero.top</span><br></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> gallery.lthero.top;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;  <span class="comment"># 强制重定向所有 HTTP 请求到 HTTPS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span> gallery.lthero.top;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/gallery.lthero.top/fullchain.pem;  <span class="comment"># 证书文件路径</span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/gallery.lthero.top/privkey.pem;  <span class="comment"># 私钥文件路径</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">1d</span>;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:MozSSL:<span class="number">10m</span>;  <span class="comment"># 缓存 SSL 会话以提升性能</span></span><br><span class="line">    <span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 现代加密套件配置</span></span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> <span class="string">&#x27;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384&#x27;</span>;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 其他 SSL 优化设置</span></span><br><span class="line">    <span class="attribute">ssl_stapling</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">ssl_stapling_verify</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 允许最大请求体大小为 1000MB</span></span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">1000m</span>;  </span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:3000;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&#x27;upgrade&#x27;</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个配置不仅启用了 HTTPS，还包括了一些现代的安全实践，如启用 HTTP/2，配置加密套件和协议等。</p><h2 id="步骤-4-重新加载-nginx">步骤 4: 重新加载 Nginx</h2><p>启用配置文件通过创建一个符号链接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -s /etc/nginx/sites-available/gallery.lthero.top /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure><p>更改配置后，需要重新加载 Nginx 以应用新的配置：</p><blockquote><p>检查配置文件是否有语法错误，如果有warn!直接看“遇到的问题”部分，重新加载配置是不一定能work的</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查配置文件是否有语法错误</span></span><br><span class="line">sudo nginx -t  </span><br><span class="line"><span class="comment"># 重新加载配置</span></span><br><span class="line">sudo systemctl reload nginx  </span><br><span class="line"><span class="comment"># 如果重新加载配置后无效，可以尝试重启nginx</span></span><br><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure><h2 id="步骤-5-验证-https">步骤 5: 验证 HTTPS</h2><p>在浏览器中访问 <code>https://gallery.lthero.top</code> 来检查是否配置成功。你应该能够看到一个安全锁标志，表明连接是通过 HTTPS 加密的。</p><h2 id="步骤-6-自动续订证书">步骤 6: 自动续订证书</h2><p>Let’s Encrypt 的证书有效期为90天，因此建议设置自动续订：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot renew</span><br></pre></td></tr></table></figure><p>这个命令会测试证书续订过程。如果这个测试成功，添加定时任务<code>crontab</code>：</p><p><code>crontab -e</code>再填写下面内容，表示每月第一天会自动执行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1 * * /usr/local/bin/certbot renew --manual --preferred-challenges dns --manual-auth-hook <span class="string">&quot;alidns&quot;</span> --manual-cleanup-hook <span class="string">&quot;alidns clean&quot;</span> --deploy-hook <span class="string">&quot;nginx -s reload&quot;</span></span><br></pre></td></tr></table></figure><p>续签的证书位置<code>/etc/letsencrypt/renewal</code></p><p>通过以上步骤，你的站点 <code>gallery.lthero.top</code> 现在应该能够安全地使用 HTTPS 进行通信了。</p><p>如果要换编辑器，运行下面的命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select-editor</span><br></pre></td></tr></table></figure><h1 id="遇到的问题">遇到的问题</h1><p>输入了这条命令后<code>sudo nginx -t</code>，发现存在warn</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-sf:~/zfile<span class="comment"># sudo nginx -t</span></span><br><span class="line">nginx: [warn] conflicting server name <span class="string">&quot;gallery.lthero.top&quot;</span> on 0.0.0.0:80, ignored</span><br><span class="line">nginx: [warn] conflicting server name <span class="string">&quot;gallery.lthero.top&quot;</span> on 0.0.0.0:443, ignored</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successfu</span><br></pre></td></tr></table></figure><blockquote><p>问题原因，certbot自动修改了/etc/nginx/sites-available/default文件</p></blockquote><p>解决方法：<a href="https://stackoverflow.com/questions/11426087/nginx-error-conflicting-server-name-ignored">https://stackoverflow.com/questions/11426087/nginx-error-conflicting-server-name-ignored</a></p><p>我的解决方法：</p><p>进入<code>sites-available</code>目录</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/nginx/sites-available</span><br></pre></td></tr></table></figure><p>随后执行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -rnw . -e gallery.lthero.top</span><br></pre></td></tr></table></figure><p>这个命令会输出当前目录下，所有包含“gallery.lthero.top”字段的文件，以及出现的行数，如下</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-sf:/etc/nginx/sites-available<span class="comment"># grep -rnw . -e gallery.lthero.top</span></span><br><span class="line">./default:115:    server_name gallery.lthero.top; <span class="comment"># managed by Certbot</span></span><br><span class="line">./default:145:    ssl_certificate /etc/letsencrypt/live/gallery.lthero.top/fullchain.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line">./default:146:    ssl_certificate_key /etc/letsencrypt/live/gallery.lthero.top/privkey.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line">./default:152:    <span class="keyword">if</span> (<span class="variable">$host</span> = gallery.lthero.top) &#123;</span><br><span class="line">./default:159:    server_name gallery.lthero.top;</span><br><span class="line">./gallery.lthero.top:3:    server_name gallery.lthero.top;</span><br><span class="line">./gallery.lthero.top:10:    server_name gallery.lthero.top;</span><br></pre></td></tr></table></figure><p>出现的问题是在default中出来了<code>gallery.lthero.top</code>相关的内容</p><p>随后，我把default替换成原来的内容，如下</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># You should look at the following URL&#x27;s in order to grasp a solid understanding</span></span><br><span class="line"><span class="comment"># of Nginx configuration files in order to fully unleash the power of Nginx.</span></span><br><span class="line"><span class="comment"># https://www.nginx.com/resources/wiki/start/</span></span><br><span class="line"><span class="comment"># https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/</span></span><br><span class="line"><span class="comment"># https://wiki.debian.org/Nginx/DirectoryStructure</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In most cases, administrators will remove this file from sites-enabled/ and</span></span><br><span class="line"><span class="comment"># leave it as reference inside of sites-available where it will continue to be</span></span><br><span class="line"><span class="comment"># updated by the nginx packaging team.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This file will automatically load configuration files provided by other</span></span><br><span class="line"><span class="comment"># applications, such as Drupal or Wordpress. These applications will be made</span></span><br><span class="line"><span class="comment"># available underneath a path with that package name, such as /drupal8.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default server configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"><span class="attribute">listen</span> <span class="number">80</span> default_server;</span><br><span class="line"><span class="attribute">listen</span> [::]:<span class="number">80</span> default_server;</span><br><span class="line"></span><br><span class="line"><span class="comment"># SSL configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># listen 443 ssl default_server;</span></span><br><span class="line"><span class="comment"># listen [::]:443 ssl default_server;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note: You should disable gzip for SSL traffic.</span></span><br><span class="line"><span class="comment"># See: https://bugs.debian.org/773332</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Read up on ssl_ciphers to ensure a secure configuration.</span></span><br><span class="line"><span class="comment"># See: https://bugs.debian.org/765782</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Self signed certs generated by the ssl-cert package</span></span><br><span class="line"><span class="comment"># Don&#x27;t use them in a production server!</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># include snippets/snakeoil.conf;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">root</span> /var/www/html;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add index.php to the list if you are using PHP</span></span><br><span class="line"><span class="attribute">index</span> index.html index.htm index.nginx-debian.html;</span><br><span class="line"></span><br><span class="line"><span class="attribute">server_name</span> _;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line"><span class="comment"># First attempt to serve request as file, then</span></span><br><span class="line"><span class="comment"># as directory, then fall back to displaying a 404.</span></span><br><span class="line"><span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ =<span class="number">404</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># pass PHP scripts to FastCGI server</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line"><span class="comment">#include snippets/fastcgi-php.conf;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## With php-fpm (or other unix sockets):</span></span><br><span class="line"><span class="comment">#fastcgi_pass unix:/run/php/php7.4-fpm.sock;</span></span><br><span class="line"><span class="comment">## With php-cgi (or other tcp sockets):</span></span><br><span class="line"><span class="comment">#fastcgi_pass 127.0.0.1:9000;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># deny access to .htaccess files, if Apache&#x27;s document root</span></span><br><span class="line"><span class="comment"># concurs with nginx&#x27;s one</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#location ~ /\.ht &#123;</span></span><br><span class="line"><span class="comment">#deny all;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Virtual Host configuration for example.com</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># You can move that to a different file under sites-available/ and symlink that</span></span><br><span class="line"><span class="comment"># to sites-enabled/ to enable it.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#server &#123;</span></span><br><span class="line"><span class="comment">#listen 80;</span></span><br><span class="line"><span class="comment">#listen [::]:80;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#server_name example.com;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#root /var/www/example.com;</span></span><br><span class="line"><span class="comment">#index index.html;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#location / &#123;</span></span><br><span class="line"><span class="comment">#try_files $uri $uri/ =404;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br></pre></td></tr></table></figure><p>再执行reload和restart就好了</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl reload nginx  <span class="comment"># 重新加载配置</span></span><br><span class="line"><span class="comment"># 如果重新加载配置后无效，可以尝试重启nginx</span></span><br><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;自建画廊&quot;&gt;自建画廊&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;home-gallery项目：&lt;a href=&quot;https://docs.home-gallery.org/install/&quot;&gt;https://docs.home-gallery.org/instal</summary>
      
    
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/tags/%E6%8A%98%E8%85%BE/"/>
    
  </entry>
  
  <entry>
    <title>Rclone 挂载 OneDrive 为本地硬盘</title>
    <link href="https://blog.lthero.cn/2024/05/12/MountOneDriveUsingRclone/"/>
    <id>https://blog.lthero.cn/2024/05/12/MountOneDriveUsingRclone/</id>
    <published>2024-05-12T11:49:42.000Z</published>
    <updated>2024-10-21T07:13:18.421Z</updated>
    
    <content type="html"><![CDATA[<h1 id="windows平台下使用-rclone-挂载-onedrive-为本地硬盘">Windows平台下使用 Rclone 挂载 OneDrive 为本地硬盘</h1><blockquote><p>参考：<a href="https://zhuanlan.zhihu.com/p/139200172">https://zhuanlan.zhihu.com/p/139200172</a></p></blockquote><p>Rclone (rsync for cloud storage) 是一个命令行程序,用于同步文件和目录，支持常见的 Amazon Drive 、Google Drive 、OneDrive 、Dropbox 等云存储。本文将演示在 Windows 平台下将 OneDrive 挂载为本地硬盘，并使用跨平台的 Rclone GUI 连接到云盘。</p><h2 id="rclone下载地址">rclone下载地址</h2><p>首先下载适用于 Windows 的 rclone</p><p>官网下载：</p><p><a href="https://rclone.org/downloads/">Rclone downloadsrclone.org/downloads/</a></p><p>GitHub下载：</p><p><a href="https://github.com/ncw/rclone">rclone/rclonegithub.com/ncw/rclone</a></p><p>在<a href="https://rclone.org/downloads/">rclone官网</a>中，Windows 平台下选择下载 AMD64 - 64 Bit</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/v2-dba90fa9447c3ce0c59cd628b099f89a_r.jpg" alt="img"></p><p>或者在<a href="https://github.com/rclone/rclone/releases">github</a>下载。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/v2-6fe076f9b3c1b74e59bafcc454b2457e_r.jpg" alt="img"></p><p>下载后解压到一个英文路径中。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/v2-2c598f613124fd234541d5b64bd5cd35_r.jpg" alt="img"></p><h2 id="必安装">必安装</h2><p>另外在Windows平台使用rclone还需要另一个依赖工具<code>winfsp</code>，下载地址：</p><p><a href="http://www.secfs.net/winfsp/download/">http://www.secfs.net/winfsp/download/www.secfs.net/winfsp/download/</a></p><p>下载后一路安装即可。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/v2-185ca574a84e6ddab1639bc10788db20_r.jpg" alt="img"></p><h2 id="rclone配置环境变量">rclone配置环境变量</h2><ol><li>在电脑桌面右键点击“此电脑”的“属性”选项</li><li>选择“高级系统设置”选项</li><li>在系统变量中找到path，添加刚才解压后的路径</li></ol><p><img src="https://cdn.lthero.cn/post_images/course/ML/v2-3f0af66bf0619eaa28ffc968c41548f7_r.jpg" alt="img"></p><h2 id="检查rclone是否配置成功">检查rclone是否配置成功</h2><p>按<code>win</code>+<code>X</code>，然后按<code>A</code> 打开 <code>powershell</code> ，当然也可以去打开 <code>cmd</code> ，输入<code>rclone --version</code>，如果出现下面的输出则安装成功，否则检查上面步骤的环境变量是否配置正确。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/v2-c8592fd9860d57cd2b88c60ecb932f6c_r.jpg" alt="img"></p><h2 id="开始配置rclone">开始配置rclone</h2><p>在终端中依次输入以下命令行，请根据下的步骤进操作。</p><p>第一步在终端输入 rclone config</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ rclone config</span><br><span class="line"></span><br><span class="line">n) New remote</span><br><span class="line">d) Delete remote</span><br><span class="line">r) <span class="built_in">Rename</span> remote</span><br><span class="line">c) <span class="built_in">Copy</span> remote</span><br><span class="line">s) <span class="built_in">Set</span> configuration password</span><br><span class="line">q) Quit config</span><br></pre></td></tr></table></figure><p>第二步输入n创建新的配置</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ e/n/d/r/c/s/q&gt; n</span><br></pre></td></tr></table></figure><p>第三步 输入一个英文名称，用来表示，中间也不要有空格</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ name&gt; OneDriveLocal</span><br></pre></td></tr></table></figure><p>第四步 输入要配置的网盘类型 因为我们要<strong>配置Microsoft OneDrive 因此输入5</strong>（具体问题具体分析）</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Type</span> of storage to configure.</span><br><span class="line">Enter a string value. Press Enter <span class="keyword">for</span> the default (&quot;&quot;).</span><br><span class="line">Choose a number from below, or <span class="built_in">type</span> <span class="keyword">in</span> your own value</span><br><span class="line"> <span class="number">1</span> / <span class="number">1</span>Fichier</span><br><span class="line"> \ &quot;fichier&quot;</span><br><span class="line"> <span class="number">2</span> / Alias <span class="keyword">for</span> an existing remote</span><br><span class="line"> \ &quot;alias&quot;</span><br><span class="line"> <span class="number">3</span> / Amazon Drive</span><br><span class="line"> \ &quot;amazon cloud drive&quot;</span><br><span class="line"> <span class="number">4</span> / Amazon S3 Compliant Storage Provider (AWS, Alibaba, Ceph, Digital Ocean, Dreamhost, IBM COS, Minio, etc)</span><br><span class="line"> \ &quot;s3&quot;</span><br><span class="line"> <span class="number">5</span> / Microsoft OneDrive</span><br><span class="line"> \ &quot;onedrive&quot;</span><br><span class="line"> Storage&gt; <span class="number">5</span></span><br></pre></td></tr></table></figure><p>第五步 要输入 client_id 时直接回车</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">** See <span class="built_in">help</span> <span class="keyword">for</span> onedrive backend <span class="built_in">at</span>: https://rclone.org/onedrive/ **</span><br><span class="line">Microsoft App Client Id</span><br><span class="line">Leave blank normally.</span><br><span class="line">Enter a string value. Press Enter <span class="keyword">for</span> the default (&quot;&quot;).</span><br><span class="line">client_id&gt; </span><br></pre></td></tr></table></figure><p>第六步 要输入 client_secret 时直接回车</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Microsoft App Client Secret                                  </span><br><span class="line">Leave blank normally.                                        </span><br><span class="line">Enter a string value. Press Enter <span class="keyword">for</span> the default (&quot;&quot;).      </span><br><span class="line">client_secret&gt;</span><br></pre></td></tr></table></figure><p>第七步 输入n 不进行高级配置</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Edit advanced config? (y/n)                                  </span><br><span class="line">y) Yes </span><br><span class="line">n) No (default)                                              </span><br><span class="line">y/n&gt; n </span><br></pre></td></tr></table></figure><p>第八步 输入y 使用自动配置授权</p><blockquote><p>输入y后会打开默认浏览器 登录Microsoft账号后 选择 是 即可</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Remote config                                                </span><br><span class="line">Use auto config? </span><br><span class="line"> * Say Y if not sure </span><br><span class="line"> * Say N if you are working on a remote or headless machine</span><br><span class="line">y) Yes (default) </span><br><span class="line">n) No                                                        </span><br><span class="line">y/n&gt; y </span><br></pre></td></tr></table></figure><p>第九步 输入1 因为现在我配置的是 OneDrive Personal or Business 类型的网盘</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">If</span> your browser doesn&#x27;t open automatically go to the following link: http://<span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">53682</span>/auth?state=sUuYaGWtxruA81JiCokJGg</span><br><span class="line">Log <span class="keyword">in</span> and authorize rclone <span class="keyword">for</span> access</span><br><span class="line">Waiting <span class="keyword">for</span> code...</span><br><span class="line">Got code</span><br><span class="line">Choose a number from below, or <span class="built_in">type</span> <span class="keyword">in</span> an existing value</span><br><span class="line"> <span class="number">1</span> / OneDrive Personal or Business</span><br><span class="line"> \ &quot;onedrive&quot;</span><br><span class="line"> <span class="number">2</span> / Root Sharepoint site</span><br><span class="line"> \ &quot;sharepoint&quot;</span><br><span class="line"> <span class="number">3</span> / <span class="built_in">Type</span> <span class="keyword">in</span> driveID</span><br><span class="line"> \ &quot;driveid&quot;</span><br><span class="line"> <span class="number">4</span> / <span class="built_in">Type</span> <span class="keyword">in</span> SiteID</span><br><span class="line"> \ &quot;siteid&quot;</span><br><span class="line"> <span class="number">5</span> / Search a Sharepoint site</span><br><span class="line"> \ &quot;search&quot;</span><br><span class="line">Your choice&gt;<span class="number">1</span>                            </span><br></pre></td></tr></table></figure><p>第十步 输入0</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Found <span class="number">1</span> drives, please select the one you want to use:</span><br><span class="line"><span class="number">0</span>: OneDrive (business) id=b!qDQvcsZUTU-<span class="number">8</span>eoYyKmtyyP1Jc0D8urZLlkATnfH1nWdJ1kkbrLsvQZLzVUTpeTrc</span><br><span class="line">Chose drive to use:&gt; <span class="number">0</span>    </span><br></pre></td></tr></table></figure><p>第十一步 输入y</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Found drive &#x27;root&#x27; of type &#x27;business&#x27;, URL: https://pmjs-my.sharepoint.com/personal/wld_365_w/Documents</span><br><span class="line">Is that okay?</span><br><span class="line">y) Yes (default)</span><br><span class="line">n) No</span><br><span class="line">y/n&gt; y   </span><br></pre></td></tr></table></figure><p>第十二步 输入y</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[OneDrive_local]</span><br><span class="line">type = onedrive</span><br><span class="line">token = &#123;<span class="string">&quot;access_token&quot;</span>:<span class="string">&quot;eyJ0UxjTLIAA&quot;</span>,<span class="string">&quot;expiry&quot;</span>:<span class="string">&quot;2020-02-10T11:32:10.852646+08:00&quot;</span>&#125;</span><br><span class="line">drive_id = b!qDvcsZUTU8eoYyKmtyyP1Jc0D8urZLlkTnH1nWdJ1kbrLsvQZLzVUTpeTrc</span><br><span class="line">drive_type = business</span><br><span class="line">--------------------</span><br><span class="line">y) Yes <span class="keyword">this</span> is <span class="built_in">OK</span> (<span class="keyword">default</span>)</span><br><span class="line">e) Edit <span class="keyword">this</span> remote</span><br><span class="line">d) Delete <span class="keyword">this</span> remote</span><br><span class="line">y/e/d&gt;y</span><br></pre></td></tr></table></figure><p>此时，就会出现刚刚配置好的网盘名称了</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/v2-422d8ec8d0f2041097092c7b04847554_r.jpg" alt="img"></p><p>最后输入q退出配置即可</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">e) Edit existing remote</span><br><span class="line">n) New remote</span><br><span class="line">d) Delete remote</span><br><span class="line">r) Rename remote</span><br><span class="line">c) Copy remote</span><br><span class="line">s) Set configuration password</span><br><span class="line">q) Quit config</span><br><span class="line">e/n/d/r/c/s/q&gt; q </span><br></pre></td></tr></table></figure><p>在 <code>C:\Users\你的用户名\.config\rclone</code>文件夹下就可以看见配置文件 rclone.conf 啦。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/v2-4263f860072c3db97a3a96c28fb30aa0_r.jpg" alt="img"></p><h3 id="5-挂载onedrive为本地硬盘"><strong>5、挂载OneDrive为本地硬盘</strong></h3><p>在 <code>git bash</code> 或 <code>cmd</code> 中输入以下挂载命令：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone mount OneDriveLocal:/  Q: --cache-dir E:\OneDrive --vfs-cache-mode writes &amp;</span><br></pre></td></tr></table></figure><p>其中：</p><p><code>OneDriveLocal</code> 替换为你自己前面设置的名称 。</p><p><code>Q:</code> 替换为你想要挂载后硬盘的盘符名称即可，记得不要和本地的C盘、D盘等重复。</p><p><code>E:\OneDrive</code> 为本地缓存目录，可自行设置 。</p><p>出现：<code>The service rclone has been started</code> 则说明挂载成功。</p><p>然后输入 <code>exit</code> 退出终端即可。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/v2-51fc3c785cb9cd4fa0db4ef98a9358a8_r.jpg" alt="img"></p><p>然后就可以看见本地多了一个盘，往里面复制文件就是上传，从里面复制文件到其它盘就是下载。</p><h3 id="6-设置开机自启动挂载">6、设置开机自启动挂载</h3><p>进入<code>C:\Users\用户名\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</code> 中</p><blockquote><p>运行中输入%<strong>appdata</strong>% 后点击确定即可进入</p></blockquote><p>创建一个名称为 <code>startup_rclone.txt</code> 的文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CreateObject(&quot;WScript.Shell&quot;).Run &quot;rclone mount OneDriveLocal:/  Q: --cache-dir E:\OneDriveLocalCache --vfs-cache-mode writes &quot;,0</span><br></pre></td></tr></table></figure><p>保存后改文件后缀.txt为.vbs即可，仅需要修改&quot;&quot;内的东西，最后没有’&amp;’</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/v2-8489b2b53a47c3d5e8f2b29cea9aee79_r.jpg" alt="img"></p><h1 id="linux平台下使用rclon-挂载-onedrive-为本地硬盘">Linux平台下使用Rclon 挂载 OneDrive 为本地硬盘</h1><blockquote><p>参考：<a href="https://blog.csdn.net/qq_46264836/article/details/131964857">https://blog.csdn.net/qq_46264836/article/details/131964857</a></p><p>参考：<a href="https://blog.xms.su/archives/91">https://blog.xms.su/archives/91</a></p></blockquote><h2 id="申请onedrive-api">申请OneDrive API</h2><p>前往<a href="https://portal.azure.com/">Microsoft Azure管理界面</a>，登录你的微软账号，打开“应用注册”服务。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/44bc2f6f5f7246b39dc4c2f14121fd61.png" alt="img"></p><p><img src="https://cdn.lthero.cn/post_images/course/ML/ffde0f48ab52424e84dd95009357d614.png" alt="img"></p><p><img src="https://cdn.lthero.cn/post_images/course/ML/81398282bc8540d0a95836556f02c6a6.png" alt="img"></p><p>注册成功后会跳转到应用首页面，记下图中所示的“应用程序(客户端) ID”，供将来挂载使用。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/6486d810e6ba48819517b84803fdb67b.png" alt="img"></p><p>然后再点击“证书与密码”→“生成客户端密码”。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/2a933656469e40b8b99152cea7165e10.png" alt="img"></p><p>添加密码后，记录我们刚刚创建的密码值，供将来挂载使用。<strong>注意这里一定要将密码记录下来，因为它只显示一次。</strong></p><p><img src="https://cdn.lthero.cn/post_images/course/ML/b7bedf0bbb9f44b68e246ea58c38afda.png" alt="img"></p><p>接下来，点击“API权限”，为我们的API获取权限。Files中的权限全部勾选就可以了。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/e91181b1d152472bad89dd8f050a70f3.png" alt="img"></p><p>这一步做完我们就获得了OneDrive的API，以及<strong>客户端ID</strong>以及<strong>密码值</strong>。</p><h2 id="自启动挂载onedrive网盘">自启动挂载OneDrive网盘</h2><h3 id="获取认证token">获取认证token</h3><p>可以挂载Windows以及Linux。以下演示Linux（Ubuntu系统）挂载OneDrive</p><p>在<a href="https://rclone.org/downloads/">rclone下载</a>对应操作系统安装包，后面需要登录获取token我<a href="https://so.csdn.net/so/search?q=VPS&amp;spm=1001.2101.3001.7020">VPS</a>没有浏览器因此需要下载安装Windows版本的rclone。</p><ol><li>下载windows系统下的rclone并解压，按win+R调出运行，输入“cmd”。</li><li>输入cd + 解压的文件夹路径，进入rclone文件夹下，再输入以下命令开始授权。（如果是win11，进入目录右键在终端打开）</li></ol><blockquote><p>ID和密码替换成你自己的<br>rclone.exe 或者（ .\rclone.exe ） authorize “onedrive” “客户端ID” “密码值”</p></blockquote><p>此时，浏览器将会自动打开，然后登录会为我们为刚才创建的api授权。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/9c7760dc77754c3fa98226a1ed967182.png" alt="img"></p><p><img src="https://cdn.lthero.cn/post_images/course/ML/c2a46c369d924b438b6ff037233aec5d.png" alt="img"></p><p>接受后页面返回这个就说明成功了，控制台会返回token。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/23589553ad9e4159baa31079fcc5ce1a.png" alt="img"></p><p>token先保留，后面绑定会用到。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/43557fb6dff943a0bf622c1639556c11.png" alt="img"></p><h3 id="安装rclone">安装rclone</h3><p>在Ubuntu安装rclone：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install curl &amp;&amp; apt install fuse3</span><br><span class="line">curl https://rclone.org/install.sh | sudo bash</span><br></pre></td></tr></table></figure><p>安装成功后，命令行输入<code>rclone config</code>挂载OneDrive网盘，输入“n”新建一个云盘，并输入名称。</p><p>这个名称就是挂载后磁盘的名称，我起的是“OneDrive”。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/912888440d2f4e4780a95c9355f10a50.png" alt="img"></p><p>接下来找对应OneDrive的序号，这个随着版本更新序号可能会变动，注意看清楚。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/2d445310342b463cb5cdae5d419bf9dd.png" alt="img"></p><p>输入序号后，就用到前面保存的客户端ID(client ID)、密码值(Value)，不是SecretID。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/00920eb3af674714b9d6faea934bd696.png" alt="img"></p><p>然后是网盘类型。<strong>此处注意区分你的网盘是什么类型，国内大部分都是(1)，部分高校是世纪互联版(4)。</strong></p><p><img src="https://cdn.lthero.cn/post_images/course/ML/6f7034ca06e345839fb56cab4b83a56a.png" alt="img"></p><p>接下来不进行高级配置(n)，也不进行自动配置(n)。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/5913d1f159f94fe48f33023c48dee26d.png" alt="img"></p><p>然后就用到我们上面获取的token了，我们将整个大括号复制填入。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/b53ab2f1b4b44ad49ddca160e88abbb0.png" alt="img"></p><p><img src="https://cdn.lthero.cn/post_images/course/ML/02628bc90ced440289a7b73576e3a789.png" alt="img"></p><p>配置完成后，我们选择类型为OneDrive Personal or Business(1)。再选择OneDrive(1)此时系统会读取网盘路径，我们输入y确认。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/ea340a3586774cc6bc9486f1b62e2504.png" alt="img"></p><p><img src="https://cdn.lthero.cn/post_images/course/ML/33c73efa3bbc454abb69824189c21396.png" alt="img"></p><p>最后，程序还会列出主要信息让你再次确认：</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/31df4ab0288f43a6a8bd0b4a1b48ae6c.png" alt="img"></p><p>此时，我们看到一个&quot;onedrive&quot;类型的、名为“OneDrive”的网盘已经创建好，我们输入q退出程序，准备将这块网盘挂载到本地目录。</p><p><img src="https://cdn.lthero.cn/post_images/course/ML/922554eb940041c086e99788443aefbb.png" alt="img"></p><h5 id="2-3下载rclone自启动挂载脚本">2.3下载rclone自启动挂载脚本</h5><ul><li>下载并编辑自启脚本</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -N git.io/rcloned </span><br><span class="line">vim rcloned</span><br></pre></td></tr></table></figure><ul><li>修改内容：</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME=<span class="string">&quot;OneDrive&quot;</span>  <span class="comment">#rclone 配置时填写的name</span></span><br><span class="line">REMOTE=<span class="string">&#x27;/VPS&#x27;</span>  <span class="comment">#远程文件夹，网盘里的挂载的一个文件夹，留空为整个网盘</span></span><br><span class="line">LOCAL=<span class="string">&#x27;/home/OneDrive&#x27;</span>  <span class="comment">#挂载地址，VPS本地挂载目录</span></span><br></pre></td></tr></table></figure><ul><li>设置开机自启</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> rcloned /etc/init.d/rcloned</span><br><span class="line"><span class="built_in">chmod</span> +x /etc/init.d/rcloned</span><br><span class="line">update-rc.d -f rcloned defaults <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">chkconfig rcloned on <span class="comment"># CentOS</span></span><br><span class="line">bash /etc/init.d/rcloned start</span><br></pre></td></tr></table></figure><p>看到 <code>[信息] rclone 启动成功 !</code> 即可。</p><p>查看挂载磁盘</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure><p><img src="https://cdn.lthero.cn/post_images/course/ML/581b051a9464410ea74de7f7a99a76bc.png" alt="img"></p><p><strong>这样就可以了，遇到问题可以留言评论看到就会回复！</strong></p><h5 id="管理">管理</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#开始挂载 </span></span><br><span class="line">bash /etc/init.d/rcloned start</span><br><span class="line"></span><br><span class="line"><span class="comment">#停止挂载</span></span><br><span class="line">bash /etc/init.d/rcloned stop</span><br><span class="line"></span><br><span class="line"><span class="comment">#重新挂载 </span></span><br><span class="line">bash /etc/init.d/rcloned restart</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看日志 </span></span><br><span class="line"><span class="built_in">tail</span> -f /<span class="variable">$HOME</span>/.rclone/rcloned.log</span><br></pre></td></tr></table></figure><h5 id="卸载自启挂载">卸载自启挂载</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bash /etc/init.d/rcloned stop</span><br><span class="line"></span><br><span class="line">update-rc.d -f rcloned remove <span class="comment"># Debian/Ubuntu</span></span><br><span class="line"></span><br><span class="line">chkconfig rcloned off <span class="comment"># CentOS</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -f /etc/init.d/rcloned</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;windows平台下使用-rclone-挂载-onedrive-为本地硬盘&quot;&gt;Windows平台下使用 Rclone 挂载 OneDrive 为本地硬盘&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://zhuanlan.zhihu</summary>
      
    
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/tags/%E6%8A%98%E8%85%BE/"/>
    
  </entry>
  
  <entry>
    <title>服务器安装集成云盘</title>
    <link href="https://blog.lthero.cn/2024/05/11/How2install-zfile/"/>
    <id>https://blog.lthero.cn/2024/05/11/How2install-zfile/</id>
    <published>2024-05-11T14:38:48.000Z</published>
    <updated>2024-11-25T06:33:12.925Z</updated>
    
    <content type="html"><![CDATA[<h1 id="下载安装zfile">下载安装zfile</h1><blockquote><p>项目：<a href="https://docs.zfile.vip/install/os-linux">https://docs.zfile.vip/install/os-linux</a></p></blockquote><h2 id="安装依赖">安装依赖</h2><p>首次部署才需要安装依赖，更新部署见下方：更新版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install -y openjdk-8-jre-headless unzip</span><br></pre></td></tr></table></figure><h2 id="下载并解压">下载并解压</h2><p>安装说明</p><p>下面命令中第一行表示默认安装到用户目录下: <code>~/zfile</code> 下。</p><p>对于 <code>root</code> 用户, <code>~</code> = <code>/root</code>, <code>~/zfile</code> 表示在 <code>/root/zfile</code> 路径下。</p><p>对于其他用户, <code>~</code> = <code>/home/用户名</code> 表示在 <code>/home/用户名/</code> 路径下。如对于 <code>oracle</code> 用户, <code>~/zfile</code> 则表示安装在 <code>/home/oracle/zfile</code> 下。</p><p>如需更改安装路径, 请自行修改，如 <code>export ZFILE_INSTALL_PATH=/data/zfile</code>，表示安装在 <code>/data/zfile</code> 路径下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ZFILE_INSTALL_PATH=~/zfile</span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$ZFILE_INSTALL_PATH</span> &amp;&amp; <span class="built_in">cd</span> <span class="variable">$ZFILE_INSTALL_PATH</span></span><br><span class="line">wget --no-check-certificate https://c.jun6.net/ZFILE/zfile-release.war</span><br><span class="line">unzip zfile-release.war &amp;&amp; <span class="built_in">rm</span> -rf zfile-release.war</span><br><span class="line"><span class="built_in">chmod</span> +x <span class="variable">$ZFILE_INSTALL_PATH</span>/bin/*.sh</span><br></pre></td></tr></table></figure><h2 id="启动项目">启动项目</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/zfile/bin/start.sh</span><br></pre></td></tr></table></figure><p>启动后浏览器访问 <strong><code>http://ip:8080</code></strong> 即可，如启动后无法访问，请检查 <strong><code>端口是否冲突</code></strong> 或 <strong><code>防火墙/安全组是否开启</code></strong>。</p><p>简单检查方式为在服务器执行 <code>curl http://127.0.0.1:8080</code></p><ul><li>如返回 <code>curl: (7) Failed connect to 127.0.0.1:8080; Connection refused</code> 表示未启动成功。</li><li>如返回 <code>&lt;!DOCTYPE html&gt; &lt;html lang=&quot;zh-CN&quot;&gt;……</code> 等字样表示启动成功，如启动成功但通过服务器 IP 无法访问，那一般就是防火墙/安全组未放行端口问题。</li></ul><h2 id="其他命令">其他命令</h2><p>以下为默认未修改安装路径下的情况，<strong>如修改了安装路径请自行更改命令所在路径</strong>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">~/zfile/bin/start.sh   </span><br><span class="line"><span class="comment"># 停止</span></span><br><span class="line">~/zfile/bin/stop.sh        </span><br></pre></td></tr></table></figure><h2 id="配置文件路径">配置文件路径</h2><p>如需修改配置文件，配置文件路径为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/zfile/WEB-INF/classes/application.properties</span><br></pre></td></tr></table></figure><h2 id="更新版本">更新版本</h2><p>警告</p><p>更新程序前务必停止程序再进行操作，命令见下方黄色高亮部分。</p><p>如果没修改过安装路径，则停止程序后，删除安装文件夹即可，默认命令为：</p><p>如修改过安装路径，则替换下方命令中的 <code>~/zfile</code> 部分为你的安装路径即可，见下方蓝色高亮部分：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~/zfile/bin/stop.sh                                                 <span class="comment"># 停止程序</span></span><br><span class="line"><span class="built_in">rm</span> -rf ~/zfile                                                      <span class="comment"># 删除安装文件夹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新下载安装最新版</span></span><br><span class="line"><span class="built_in">export</span> ZFILE_INSTALL_PATH=~/zfile                                   <span class="comment"># 声明安装到的路径</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$ZFILE_INSTALL_PATH</span> &amp;&amp; <span class="built_in">cd</span> <span class="variable">$ZFILE_INSTALL_PATH</span>              <span class="comment"># 创建文件夹并进入</span></span><br><span class="line">wget --no-check-certificate https://c.jun6.net/ZFILE/zfile-release.war                     <span class="comment"># 下载 zfile 最新版</span></span><br><span class="line">unzip zfile-release.war &amp;&amp; <span class="built_in">rm</span> -rf zfile-release.war                 <span class="comment"># 解压并删除压缩包</span></span><br><span class="line"><span class="built_in">chmod</span> +x <span class="variable">$ZFILE_INSTALL_PATH</span>/bin/*.sh                               <span class="comment"># 授权启动停止脚本</span></span><br><span class="line"></span><br><span class="line">~/zfile/bin/start.sh                                                <span class="comment"># 启动项目</span></span><br></pre></td></tr></table></figure><h1 id="使用http访问">使用HTTP访问</h1><p>要将运行在Docker容器中的服务通过域名访问，并使用Nginx作为反向代理来转发到宿主机的8080端口，你需要完成几个步骤。这包括设置DNS记录、配置Nginx以及确保网络安全。下面是具体步骤：</p><h2 id="步骤-1-设置dns记录">步骤 1: 设置DNS记录</h2><p>确保你的域名 <code>cloud.lthero.top</code> 的DNS记录指向托管Nginx的服务器的IP地址。这通常在你的域名注册商处进行设置：</p><ul><li><strong>A记录</strong>：将域名指向IPv4地址。</li><li><strong>AAAA记录</strong>：将域名指向IPv6地址（如果适用）。</li></ul><h2 id="步骤-2-安装并启动nginx">步骤 2: 安装并启动Nginx</h2><p>步骤 1: 更新软件包列表</p><p>打开终端，首先使用<code>apt</code>命令更新你的包列表，以确保你安装的是最新版本的Nginx。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure><p>步骤 2: 安装Nginx</p><p>使用<code>apt</code>安装Nginx。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure><h2 id="步骤-3-配置nginx">步骤 3: 配置Nginx</h2><p>你需要在Nginx中创建一个新的服务器块（server block），或者在已有的默认配置中修改，以设置反向代理。以下是一个基本的Nginx配置示例，将会把所有到 <code>cloud.lthero.top</code> 的请求转发到本地的8080端口：</p><ol><li><p>打开或创建一个新的Nginx配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-available/cloud.lthero.top</span><br></pre></td></tr></table></figure></li><li><p>添加以下配置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> cloud.lthero.top;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:8080;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&#x27;upgrade&#x27;</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个配置做了以下几点：</p><ul><li><code>listen 80;</code> 告诉Nginx监听80端口（HTTP标准端口）。</li><li><code>server_name cloud.lthero.top;</code> 设置这个块应当响应的域名。</li><li><code>proxy_pass http://localhost:8080;</code> 指定所有传入的请求转发到本地的8080端口。</li><li><code>proxy_set_header</code> 指令将重要的HTTP头信息转发给后端应用。</li></ul></li><li><p>启用配置文件通过创建一个符号链接(一定要做)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -s /etc/nginx/sites-available/cloud.lthero.top /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure></li><li><p>检查Nginx配置文件是否有语法错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br></pre></td></tr></table></figure></li><li><p>如果没有错误，重启Nginx以应用配置(一定要做)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure></li></ol><h2 id="步骤-4-调整防火墙规则">步骤 4: 调整防火墙规则</h2><p>确保你的服务器的防火墙规则允许HTTP（端口80）和HTTPS（端口443，如果你使用SSL）的流量。如果你正在使用<code>ufw</code>，可以使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow <span class="string">&#x27;Nginx Full&#x27;</span></span><br><span class="line">sudo ufw reload</span><br></pre></td></tr></table></figure><h2 id="步骤-5-测试配置">步骤 5: 测试配置</h2><p>在浏览器中输入 <code>http://cloud.lthero.top</code> 或使用命令行工具如 <code>curl</code> 来测试你的配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://cloud.lthero.top</span><br></pre></td></tr></table></figure><p>你应该能看到从Docker容器中运行的服务响应的内容。</p><p>这样，你就配置好了Nginx作为反向代理，将域名 <code>cloud.lthero.top</code> 的流量转发到宿主机的8080端口上的服务。如果你希望使用HTTPS，你还需要设置SSL证书，可以考虑使用Let’s Encrypt免费证书并配置HTTPS。</p><h1 id="使用https访问">使用HTTPS访问</h1><p>要让你的域名 <code>cloud.lthero.top</code> 使用 HTTPS，你需要获取 SSL/TLS 证书，并配置 Nginx 以使用这些证书来加密网页内容。以下是详细的步骤，包括如何使用 Let’s Encrypt 提供的免费证书自动化这个过程。</p><h2 id="步骤-1-安装-certbot">步骤 1: 安装 Certbot</h2><p>Certbot 是一个自动获取并安装 Let’s Encrypt 证书的客户端。在 Ubuntu 上安装 Certbot 及其 Nginx 插件非常简单：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install certbot python3-certbot-nginx</span><br></pre></td></tr></table></figure><h2 id="步骤-2-获取和安装证书">步骤 2: 获取和安装证书</h2><p>使用 Certbot 获取并为你的域名安装证书：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot --nginx -d cloud.lthero.top</span><br></pre></td></tr></table></figure><p>此命令会自动为指定的域名 <code>cloud.lthero.top</code> 配置 SSL 证书，并更新 Nginx 配置以使用这些证书。Certbot 会询问你一些问题，比如电子邮件地址（用于紧急联系和证书续订提醒），以及是否重定向所有 HTTP 请求到 HTTPS（强烈建议启用）。</p><p>生成的证书位置<code>/etc/letsencrypt/live/</code></p><h2 id="步骤-3-更新-nginx-配置">步骤 3: 更新 Nginx 配置</h2><p>如果你想手动编辑 Nginx 配置文件，可以按以下方式配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-available/cloud.lthero.top</span><br></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> cloud.lthero.top;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;  <span class="comment"># 强制重定向所有 HTTP 请求到 HTTPS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span> cloud.lthero.top;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/cloud.lthero.top/fullchain.pem;  <span class="comment"># 证书文件路径</span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/cloud.lthero.top/privkey.pem;  <span class="comment"># 私钥文件路径</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">1d</span>;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:MozSSL:<span class="number">10m</span>;  <span class="comment"># 缓存 SSL 会话以提升性能</span></span><br><span class="line">    <span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 现代加密套件配置</span></span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> <span class="string">&#x27;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384&#x27;</span>;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 其他 SSL 优化设置</span></span><br><span class="line">    <span class="attribute">ssl_stapling</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">ssl_stapling_verify</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 允许最大请求体大小为 1000MB</span></span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">1000m</span>;  </span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:8080;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&#x27;upgrade&#x27;</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个配置不仅启用了 HTTPS，还包括了一些现代的安全实践，如启用 HTTP/2，配置加密套件和协议等。</p><h2 id="步骤-4-重新加载-nginx">步骤 4: 重新加载 Nginx</h2><p>启用配置文件通过创建一个符号链接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -s /etc/nginx/sites-available/cloud.lthero.top /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure><p>更改配置后，需要重新加载 Nginx 以应用新的配置：</p><blockquote><p>检查配置文件是否有语法错误，如果有warn!直接看“遇到的问题”部分，重新加载配置是不一定能work的</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查配置文件是否有语法错误</span></span><br><span class="line">sudo nginx -t  </span><br><span class="line"><span class="comment"># 重新加载配置</span></span><br><span class="line">sudo systemctl reload nginx  </span><br><span class="line"><span class="comment"># 如果重新加载配置后无效，可以尝试重启nginx</span></span><br><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure><h2 id="步骤-5-验证-https">步骤 5: 验证 HTTPS</h2><p>在浏览器中访问 <code>https://cloud.lthero.top</code> 来检查是否配置成功。你应该能够看到一个安全锁标志，表明连接是通过 HTTPS 加密的。</p><h2 id="步骤-6-自动续订证书">步骤 6: 自动续订证书</h2><p>Let’s Encrypt 的证书有效期为90天，因此建议设置自动续订：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot renew</span><br></pre></td></tr></table></figure><p>这个命令会测试证书续订过程。如果这个测试成功，添加定时任务<code>crontab</code>：</p><p><code>crontab -e</code>再填写下面内容，表示每月第一天会自动执行</p><p>先用<code>which certbot</code>查看软件位置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1 * * /usr/local/bin/certbot renew --manual --preferred-challenges dns --manual-auth-hook <span class="string">&quot;alidns&quot;</span> --manual-cleanup-hook <span class="string">&quot;alidns clean&quot;</span> --deploy-hook <span class="string">&quot;nginx -s reload&quot;</span></span><br></pre></td></tr></table></figure><p>续签的证书位置<code>/etc/letsencrypt/renewal</code></p><p>通过以上步骤，你的站点 <code>cloud.lthero.top</code> 现在应该能够安全地使用 HTTPS 进行通信了。</p><p>如果要换编辑器，运行下面的命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select-editor</span><br></pre></td></tr></table></figure><h1 id="遇到的问题">遇到的问题</h1><p>输入了这条命令后<code>sudo nginx -t</code>，发现存在warn</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-sf:~/zfile<span class="comment"># sudo nginx -t</span></span><br><span class="line">nginx: [warn] conflicting server name <span class="string">&quot;cloud.lthero.top&quot;</span> on 0.0.0.0:80, ignored</span><br><span class="line">nginx: [warn] conflicting server name <span class="string">&quot;cloud.lthero.top&quot;</span> on 0.0.0.0:443, ignored</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successfu</span><br></pre></td></tr></table></figure><p>解决方法：<a href="https://stackoverflow.com/questions/11426087/nginx-error-conflicting-server-name-ignored">https://stackoverflow.com/questions/11426087/nginx-error-conflicting-server-name-ignored</a></p><p>我的解决方法：</p><p>进入<code>sites-available</code>目录</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/nginx/sites-available</span><br></pre></td></tr></table></figure><p>随后执行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -rnw . -e cloud.lthero.top</span><br></pre></td></tr></table></figure><p>这个命令会输出当前目录下，所有包含“cloud.lthero.top”字段的文件，以及出现的行数，如下</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-sf:/etc/nginx/sites-available<span class="comment"># grep -rnw . -e cloud.lthero.top</span></span><br><span class="line">./default:115:    server_name cloud.lthero.top; <span class="comment"># managed by Certbot</span></span><br><span class="line">./default:145:    ssl_certificate /etc/letsencrypt/live/cloud.lthero.top/fullchain.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line">./default:146:    ssl_certificate_key /etc/letsencrypt/live/cloud.lthero.top/privkey.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line">./default:152:    <span class="keyword">if</span> (<span class="variable">$host</span> = cloud.lthero.top) &#123;</span><br><span class="line">./default:159:    server_name cloud.lthero.top;</span><br><span class="line">./cloud.lthero.top:3:    server_name cloud.lthero.top;</span><br><span class="line">./cloud.lthero.top:10:    server_name cloud.lthero.top;</span><br></pre></td></tr></table></figure><p>出现的问题是在default中出来了<code>cloud.lthero.top</code>相关的内容</p><p>随后，我把default替换成原来的内容，如下</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># You should look at the following URL&#x27;s in order to grasp a solid understanding</span></span><br><span class="line"><span class="comment"># of Nginx configuration files in order to fully unleash the power of Nginx.</span></span><br><span class="line"><span class="comment"># https://www.nginx.com/resources/wiki/start/</span></span><br><span class="line"><span class="comment"># https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/</span></span><br><span class="line"><span class="comment"># https://wiki.debian.org/Nginx/DirectoryStructure</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In most cases, administrators will remove this file from sites-enabled/ and</span></span><br><span class="line"><span class="comment"># leave it as reference inside of sites-available where it will continue to be</span></span><br><span class="line"><span class="comment"># updated by the nginx packaging team.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This file will automatically load configuration files provided by other</span></span><br><span class="line"><span class="comment"># applications, such as Drupal or Wordpress. These applications will be made</span></span><br><span class="line"><span class="comment"># available underneath a path with that package name, such as /drupal8.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default server configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"><span class="attribute">listen</span> <span class="number">80</span> default_server;</span><br><span class="line"><span class="attribute">listen</span> [::]:<span class="number">80</span> default_server;</span><br><span class="line"></span><br><span class="line"><span class="comment"># SSL configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># listen 443 ssl default_server;</span></span><br><span class="line"><span class="comment"># listen [::]:443 ssl default_server;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note: You should disable gzip for SSL traffic.</span></span><br><span class="line"><span class="comment"># See: https://bugs.debian.org/773332</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Read up on ssl_ciphers to ensure a secure configuration.</span></span><br><span class="line"><span class="comment"># See: https://bugs.debian.org/765782</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Self signed certs generated by the ssl-cert package</span></span><br><span class="line"><span class="comment"># Don&#x27;t use them in a production server!</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># include snippets/snakeoil.conf;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">root</span> /var/www/html;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add index.php to the list if you are using PHP</span></span><br><span class="line"><span class="attribute">index</span> index.html index.htm index.nginx-debian.html;</span><br><span class="line"></span><br><span class="line"><span class="attribute">server_name</span> _;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line"><span class="comment"># First attempt to serve request as file, then</span></span><br><span class="line"><span class="comment"># as directory, then fall back to displaying a 404.</span></span><br><span class="line"><span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ =<span class="number">404</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># pass PHP scripts to FastCGI server</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line"><span class="comment">#include snippets/fastcgi-php.conf;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">## With php-fpm (or other unix sockets):</span></span><br><span class="line"><span class="comment">#fastcgi_pass unix:/run/php/php7.4-fpm.sock;</span></span><br><span class="line"><span class="comment">## With php-cgi (or other tcp sockets):</span></span><br><span class="line"><span class="comment">#fastcgi_pass 127.0.0.1:9000;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># deny access to .htaccess files, if Apache&#x27;s document root</span></span><br><span class="line"><span class="comment"># concurs with nginx&#x27;s one</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#location ~ /\.ht &#123;</span></span><br><span class="line"><span class="comment">#deny all;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Virtual Host configuration for example.com</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># You can move that to a different file under sites-available/ and symlink that</span></span><br><span class="line"><span class="comment"># to sites-enabled/ to enable it.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#server &#123;</span></span><br><span class="line"><span class="comment">#listen 80;</span></span><br><span class="line"><span class="comment">#listen [::]:80;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#server_name example.com;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#root /var/www/example.com;</span></span><br><span class="line"><span class="comment">#index index.html;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#location / &#123;</span></span><br><span class="line"><span class="comment">#try_files $uri $uri/ =404;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br></pre></td></tr></table></figure><p>再执行reload和restart就好了</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl reload nginx  <span class="comment"># 重新加载配置</span></span><br><span class="line"><span class="comment"># 如果重新加载配置后无效，可以尝试重启nginx</span></span><br><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;下载安装zfile&quot;&gt;下载安装zfile&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;项目：&lt;a href=&quot;https://docs.zfile.vip/install/os-linux&quot;&gt;https://docs.zfile.vip/install/os-lin</summary>
      
    
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/tags/%E6%8A%98%E8%85%BE/"/>
    
  </entry>
  
  <entry>
    <title>记录一个Conda环境问题</title>
    <link href="https://blog.lthero.cn/2024/04/15/SetBashProfile/"/>
    <id>https://blog.lthero.cn/2024/04/15/SetBashProfile/</id>
    <published>2024-04-15T09:33:56.000Z</published>
    <updated>2024-04-15T09:44:32.185Z</updated>
    
    <content type="html"><![CDATA[<h1 id="起因">起因</h1><blockquote><p>最近发现conda环境中，不论什么环境，都使用的/home/.local/lib/python3.10/site-packages下的包</p></blockquote><p>而理论上Conda的虚拟环境应该优先使用虚拟环境中的包，比如通过查询<code>which pip</code>可以发现其位置在<code>/opt/anaconda3/bin/pip</code>【正确的】</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(base) xxx@xxx-2:~$ <span class="built_in">which</span> pip</span><br><span class="line">/opt/anaconda3/bin/pip</span><br></pre></td></tr></table></figure><p>而下面的结果是【错误的】</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(base) xxx@xxx-2:~$ <span class="built_in">which</span> pip</span><br><span class="line">/home/dongli911/.local/bin/pip</span><br></pre></td></tr></table></figure><h1 id="原因">原因</h1><blockquote><p>原因是PATH的优先级问题</p></blockquote><p><strong>优先级</strong>：应该将Conda环境的<code>bin</code>目录置于<code>PATH</code>的最前面，意味着你在使用任何命令时（如<code>python</code>，<code>pip</code>等），系统都会首先在你当前激活的Conda环境中寻找。</p><p>但实际上的$PATH输出如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/dongli911/.local/bin:/opt/anaconda3/bin:/opt/anaconda3/condabin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin</span><br></pre></td></tr></table></figure><p>即/home/dongli911/.local/bin被写在了/opt/anaconda3/bin前面，<strong>我们要做的是把$PATH重写</strong></p><h1 id="解决">解决</h1><blockquote><p>随后发现，不论在<code>~/.bashrc</code>怎么修改<code>$PATH</code>，/home/dongli911/.local/bin还是会在最前面，随后发现</p></blockquote><p>对于登录 shell，<code>~/.bash_profile</code>（或在某些系统上是 <code>~/.profile</code>）会在每次登录时执行。如果 <code>.bashrc</code> 中的设置被覆盖了，可能是因为这些文件中有进一步的修改。</p><p>查看<code>~/.profile</code>，发现到$PATH确实被重写了（如下）</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set PATH so it includes user&#x27;s private bin if it exists</span></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="string">&quot;<span class="variable">$HOME</span>/.local/bin&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">    PATH=<span class="string">&quot;<span class="variable">$HOME</span>/.local/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>在上面的代码后面添加<code>export PATH=&quot;/opt/anaconda3/bin:$PATH&quot;</code>即可</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set PATH so it includes user&#x27;s private bin if it exists</span></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="string">&quot;<span class="variable">$HOME</span>/.local/bin&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">    PATH=<span class="string">&quot;<span class="variable">$HOME</span>/.local/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/opt/anaconda3/bin:<span class="variable">$PATH</span>&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;起因&quot;&gt;起因&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;最近发现conda环境中，不论什么环境，都使用的/home/.local/lib/python3.10/site-packages下的包&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;而理论上Conda的虚拟环境</summary>
      
    
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/tags/%E6%8A%98%E8%85%BE/"/>
    
  </entry>
  
  <entry>
    <title>在线剪贴板|文件传输</title>
    <link href="https://blog.lthero.cn/2024/04/11/OnlineClipBoard/"/>
    <id>https://blog.lthero.cn/2024/04/11/OnlineClipBoard/</id>
    <published>2024-04-11T12:21:43.000Z</published>
    <updated>2024-10-21T05:46:02.405Z</updated>
    
    <content type="html"><![CDATA[<h1 id="在线剪贴板-文件传输">在线剪贴板|文件传输</h1><blockquote><p>项目地址：<a href="https://github.com/TransparentLC/cloud-clipboard">https://github.com/TransparentLC/cloud-clipboard</a></p></blockquote><h1 id="下载项目">下载项目</h1><h2 id="使用-docker-运行">使用 Docker 运行</h2><blockquote><p>Docker Hub 上的镜像是由他人打包的，仅为方便使用而在这里给出，版本可能会滞后于 repo 内的源代码。</p></blockquote><h3 id="从-docker-hub-拉取">从 Docker Hub 拉取</h3><p>如果你在使用时遇到了问题，请先确认这个问题在 repo 内的最新的源代码中是否仍然存在。</p><p><code>lthero1/lthero-onlineclip</code> 是本人稍微修改后并打包的，限制容量1GB，无密码，支持Markdown预览，支持多文件同时上传，上传速度快</p><p><code>chenqiyux/lan-clip:latest</code> 是原Readme中的，版本落后，不支持多文件同时上传</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull lthero1/lthero-onlineclip:latest</span><br><span class="line">docker container run -d -p 9501:9501 lthero1/lthero-onlineclip</span><br></pre></td></tr></table></figure><h3 id="自己打包">自己打包</h3><p>先下载项目<code>git clone https://github.com/TransparentLC/cloud-clipboard.git</code>，随后自己打包</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker image build -t myclip .</span><br><span class="line">docker container run -d --<span class="built_in">rm</span> -p 9501:9501 myclip</span><br></pre></td></tr></table></figure><h2 id="配置文件说明">配置文件说明</h2><p><code>//</code> 开头的部分是注释，<strong>并不需要写入配置文件中</strong>，否则会导致读取失败。</p><blockquote><p>这个配置文件<strong>在server-node/app/config.js直接修改</strong>，在server/config.json中修改不一定生效！</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">9501</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cert&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;forceWss&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;history&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span> <span class="number">40960</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;expire&quot;</span><span class="punctuation">:</span> <span class="number">864000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;chunk&quot;</span><span class="punctuation">:</span> <span class="number">12582912</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span> <span class="number">1073741824</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>HTTPS 的说明：</p><p>如果同时设定了私钥和证书路径，则会使用 HTTPS 协议访问前端界面，未设定则会使用 HTTP 协议。 自用的话，可以使用 <a href="https://mkcert.dev/">mkcert</a> 自行生成证书，并将根证书添加到系统/浏览器的信任列表中。 如果使用了 Nginx 等软件的反向代理，且这些软件已经提供了 HTTPS 连接，则无需在这里设定。</p><p>“密码认证”的说明：</p><p>如果启用“密码认证”，只有输入正确的密码才能连接到服务端并查看剪贴板内容。 可以将 <code>server.auth</code> 字段设为 <code>true</code>（随机生成六位密码）或字符串（自定义密码）“auth”: “123456” 来启用这个功能，启动服务端后终端会以 <code>Authorization code: ******</code> 的格式输出当前使用的密码。</p></blockquote><p><code>在server-node/app/config.js直接修改</code>或者在服务器创建个clip-config.js，内容如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">import crypto from &#x27;node<span class="punctuation">:</span>crypto&#x27;;</span><br><span class="line">import fs from &#x27;node<span class="punctuation">:</span>fs&#x27;;</span><br><span class="line">import path from &#x27;node<span class="punctuation">:</span>path&#x27;;</span><br><span class="line"></span><br><span class="line">const defaultConfigPath = path.join(process.cwd()<span class="punctuation">,</span> &#x27;config.json&#x27;);</span><br><span class="line"></span><br><span class="line">if (!process.argv<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span> &amp;&amp; !fs.existsSync(defaultConfigPath)) <span class="punctuation">&#123;</span></span><br><span class="line">    console.log(`\x1b<span class="punctuation">[</span><span class="number">93</span>mConfig file <span class="string">&quot;$&#123;defaultConfigPath&#125;&quot;</span> does not exist.\x1b<span class="punctuation">[</span><span class="number">39</span>m`);</span><br><span class="line">    console.log(&#x27;\x1b<span class="punctuation">[</span><span class="number">93</span>mA default config file is created and used. Check the descriptions in the repository\&#x27;s README.md to modify it.\x1b<span class="punctuation">[</span><span class="number">39</span>m&#x27;);</span><br><span class="line">    fs.writeFileSync(defaultConfigPath<span class="punctuation">,</span> JSON.stringify(<span class="punctuation">&#123;</span></span><br><span class="line">        server<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            host<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            port<span class="punctuation">:</span> <span class="number">9501</span><span class="punctuation">,</span></span><br><span class="line">            key<span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            cert<span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">            forceWss<span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">            history<span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">            auth<span class="punctuation">:</span> <span class="string">&quot;xxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        text<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            limit<span class="punctuation">:</span> <span class="number">40960</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        file<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            expire<span class="punctuation">:</span> <span class="number">864000</span><span class="punctuation">,</span></span><br><span class="line">            chunk<span class="punctuation">:</span> <span class="number">12582912</span><span class="punctuation">,</span></span><br><span class="line">            limit<span class="punctuation">:</span> <span class="number">1073741824</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="keyword">null</span><span class="punctuation">,</span> <span class="number">4</span>));</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">const config = JSON.parse(fs.readFileSync(process.argv<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span> || defaultConfigPath));</span><br><span class="line"></span><br><span class="line">if (config.server.auth === <span class="keyword">true</span>) <span class="punctuation">&#123;</span></span><br><span class="line">    config.server.auth = &#x27;&#x27;;</span><br><span class="line">    for (let i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) <span class="punctuation">&#123;</span></span><br><span class="line">        config.server.auth += &#x27;<span class="number">0123456789</span>ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&#x27;<span class="punctuation">[</span>crypto.randomInt(<span class="number">62</span>)<span class="punctuation">]</span>;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">if (config.server.auth) <span class="punctuation">&#123;</span></span><br><span class="line">    config.server.auth = config.server.auth.toString();</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">export default config;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>修改配置文件后，不需要重新打包，使用-v映射即可</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker container run -d -p 9501:9501 --<span class="built_in">rm</span> -v ~/clip-config.js:/app/server-node/app/config.js lthero1/lthero-onlineclip</span><br><span class="line"></span><br><span class="line"><span class="comment"># -v ~/clip-config.json:/app/server/config.json</span></span><br></pre></td></tr></table></figure><h1 id="使用http访问">使用HTTP访问</h1><p>要将运行在Docker容器中的服务通过域名访问，并使用Nginx作为反向代理来转发到宿主机的9501端口，你需要完成几个步骤。这包括设置DNS记录、配置Nginx以及确保网络安全。下面是具体步骤：</p><h2 id="步骤-1-设置dns记录">步骤 1: 设置DNS记录</h2><p>确保你的域名 <code>cp.lthero.top</code> 的DNS记录指向托管Nginx的服务器的IP地址。这通常在你的域名注册商处进行设置：</p><ul><li><strong>A记录</strong>：将域名指向IPv4地址。</li><li><strong>AAAA记录</strong>：将域名指向IPv6地址（如果适用）。</li></ul><h2 id="步骤-2-安装并启动nginx">步骤 2: 安装并启动Nginx</h2><p>步骤 1: 更新软件包列表</p><p>打开终端，首先使用<code>apt</code>命令更新你的包列表，以确保你安装的是最新版本的Nginx。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure><p>步骤 2: 安装Nginx</p><p>使用<code>apt</code>安装Nginx。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure><h2 id="步骤-3-配置nginx">步骤 3: 配置Nginx</h2><p>你需要在Nginx中创建一个新的服务器块（server block），或者在已有的默认配置中修改，以设置反向代理。以下是一个基本的Nginx配置示例，将会把所有到 <code>cp.lthero.top</code> 的请求转发到本地的9501端口：</p><ol><li><p>打开或创建一个新的Nginx配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-available/cp.lthero.top</span><br></pre></td></tr></table></figure></li><li><p>添加以下配置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> cp.lthero.top;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:9501;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&#x27;upgrade&#x27;</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个配置做了以下几点：</p><ul><li><code>listen 80;</code> 告诉Nginx监听80端口（HTTP标准端口）。</li><li><code>server_name cp.lthero.top;</code> 设置这个块应当响应的域名。</li><li><code>proxy_pass http://localhost:9501;</code> 指定所有传入的请求转发到本地的9501端口。</li><li><code>proxy_set_header</code> 指令将重要的HTTP头信息转发给后端应用。</li></ul></li><li><p>启用配置文件通过创建一个符号链接：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -s /etc/nginx/sites-available/cp.lthero.top /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure></li><li><p>检查Nginx配置文件是否有语法错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br></pre></td></tr></table></figure></li><li><p>如果没有错误，重启Nginx以应用配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure></li></ol><h2 id="步骤-4-调整防火墙规则">步骤 4: 调整防火墙规则</h2><p>确保你的服务器的防火墙规则允许HTTP（端口80）和HTTPS（端口443，如果你使用SSL）的流量。如果你正在使用<code>ufw</code>，可以使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow <span class="string">&#x27;Nginx Full&#x27;</span></span><br><span class="line">sudo ufw reload</span><br></pre></td></tr></table></figure><h2 id="步骤-5-测试配置">步骤 5: 测试配置</h2><p>在浏览器中输入 <code>http://cp.lthero.top</code> 或使用命令行工具如 <code>curl</code> 来测试你的配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://cp.lthero.top</span><br></pre></td></tr></table></figure><p>你应该能看到从Docker容器中运行的服务响应的内容。</p><p>这样，你就配置好了Nginx作为反向代理，将域名 <code>cp.lthero.top</code> 的流量转发到宿主机的9501端口上的服务。如果你希望使用HTTPS，你还需要设置SSL证书，可以考虑使用Let’s Encrypt免费证书并配置HTTPS。</p><h1 id="使用https访问">使用HTTPS访问</h1><p>要让你的域名 <code>cp.lthero.top</code> 使用 HTTPS，你需要获取 SSL/TLS 证书，并配置 Nginx 以使用这些证书来加密网页内容。以下是详细的步骤，包括如何使用 Let’s Encrypt 提供的免费证书自动化这个过程。</p><h2 id="步骤-1-安装-certbot">步骤 1: 安装 Certbot</h2><p>Certbot 是一个自动获取并安装 Let’s Encrypt 证书的客户端。在 Ubuntu 上安装 Certbot 及其 Nginx 插件非常简单：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install certbot python3-certbot-nginx -y</span><br></pre></td></tr></table></figure><h2 id="步骤-2-获取和安装证书">步骤 2: 获取和安装证书</h2><p>使用 Certbot 获取并为你的域名安装证书：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot --nginx -d cp.lthero.top</span><br></pre></td></tr></table></figure><p>此命令会自动为指定的域名 <code>cp.lthero.top</code> 配置 SSL 证书，并更新 Nginx 配置以使用这些证书。Certbot 会询问你一些问题，比如电子邮件地址（用于紧急联系和证书续订提醒），以及是否重定向所有 HTTP 请求到 HTTPS（强烈建议启用）。</p><p>生成的证书位置<code>/etc/letsencrypt/live/</code></p><h2 id="步骤-3-更新-nginx-配置">步骤 3: 更新 Nginx 配置</h2><p>如果你想手动编辑 Nginx 配置文件，可以按以下方式配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-available/cp.lthero.top</span><br></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> cp.lthero.top;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;  <span class="comment"># 强制重定向所有 HTTP 请求到 HTTPS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span> cp.lthero.top;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/cp.lthero.top/fullchain.pem;  <span class="comment"># 证书文件路径</span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/cp.lthero.top/privkey.pem;  <span class="comment"># 私钥文件路径</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">1d</span>;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:MozSSL:<span class="number">10m</span>;  <span class="comment"># 缓存 SSL 会话以提升性能</span></span><br><span class="line">    <span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 现代加密套件配置</span></span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> <span class="string">&#x27;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384&#x27;</span>;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 其他 SSL 优化设置</span></span><br><span class="line">    <span class="attribute">ssl_stapling</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">ssl_stapling_verify</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 允许最大请求体大小为 1000MB</span></span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">1000m</span>;  </span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:9501;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&#x27;upgrade&#x27;</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个配置不仅启用了 HTTPS，还包括了一些现代的安全实践，如启用 HTTP/2，配置加密套件和协议等。</p><blockquote><p>允许最大请求体大小为 1000MB</p><p>client_max_body_size 1000m;</p><p>这行最好与config.js中保持一致，如果<strong>nginx设置小了，会出现“上传失败”的结果！</strong></p></blockquote><h2 id="步骤-4-重新加载-nginx">步骤 4: 重新加载 Nginx</h2><p>启用配置文件通过创建一个符号链接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -s /etc/nginx/sites-available/cp.lthero.top /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure><p>更改配置后，需要重新加载 Nginx 以应用新的配置：</p><blockquote><p>检查配置文件是否有语法错误，如果有warn!直接看“遇到的问题”部分，重新加载配置是不一定能work的</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t  <span class="comment"># 检查配置文件是否有语法错误</span></span><br><span class="line">sudo systemctl reload nginx  <span class="comment"># 重新加载配置</span></span><br><span class="line"><span class="comment"># 如果重新加载配置后无效，可以尝试重启nginx</span></span><br><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure><h2 id="步骤-5-验证-https">步骤 5: 验证 HTTPS</h2><p>在浏览器中访问 <code>https://cp.lthero.top</code> 来检查是否配置成功。你应该能够看到一个安全锁标志，表明连接是通过 HTTPS 加密的。</p><h2 id="步骤-6-自动续订证书">步骤 6: 自动续订证书</h2><p>Let’s Encrypt 的证书有效期为90天，因此建议设置自动续订：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot renew</span><br></pre></td></tr></table></figure><p>这个命令会测试证书续订过程。如果这个测试成功，添加定时任务<code>crontab</code>：</p><p><code>crontab -e</code>再填写下面内容，表示每月第一天会自动执行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1 * * /usr/local/bin/certbot renew --deploy-hook <span class="string">&quot;nginx -s reload&quot;</span></span><br></pre></td></tr></table></figure><p>通过<code>which certbot</code>查看具体程序位置<code>/usr/local/bin/certbot</code></p><p>续签的证书位置<code>/etc/letsencrypt/renewal</code></p><p>通过以上步骤，你的站点 <code>cp.lthero.top</code> 现在应该能够安全地使用 HTTPS 进行通信了。</p><p>如果要换crontab编辑器，运行下面的命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select-editor</span><br></pre></td></tr></table></figure><h2 id="解析到阿里云dns的申请方法">解析到阿里云DNS的申请方法</h2><blockquote><p>如果域名解析在阿里云，可以安装这个插件从而完成证书申请，<a href="https://github.com/tengattack/certbot-dns-aliyun">https://github.com/tengattack/certbot-dns-aliyun</a></p></blockquote><h3 id="credentials-file">Credentials File</h3><p>在某个熟悉的目录下，把下面的内容写入<code>credentials.ini</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dns_aliyun_access_key = 12345678</span><br><span class="line">dns_aliyun_access_key_secret = 1234567890abcdef1234567890abcdef</span><br></pre></td></tr></table></figure><p>dns_aliyun_access_key是阿里云账号的AccessKey ID</p><p>dns_aliyun_access_key_secret是阿里云账号的AccessKey Secret</p><p>这两个值可以在阿里云控制台-&gt;用户头像-&gt;accesskeys按指引获取AccessKey/SecretKey</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 600 /path/to/credentials.ini</span><br></pre></td></tr></table></figure><h3 id="obtain-certificates">Obtain Certificates</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">certbot certonly \</span><br><span class="line">    --authenticator=dns-aliyun \</span><br><span class="line">    --dns-aliyun-credentials=<span class="string">&#x27;/path/to/credentials.ini&#x27;</span> \</span><br><span class="line">    -d <span class="string">&quot;*.example.com,example.com&quot;</span></span><br></pre></td></tr></table></figure><p>申请下来的证书位置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/letsencrypt/archive/</span><br></pre></td></tr></table></figure><p>适合阿里云的自动命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1 * * /usr/local/bin/certbot renew --manual --preferred-challenges dns --manual-auth-hook <span class="string">&quot;alidns&quot;</span> --manual-cleanup-hook <span class="string">&quot;alidns clean&quot;</span> --deploy-hook <span class="string">&quot;nginx -s reload&quot;</span></span><br></pre></td></tr></table></figure><hr><h1 id="密码认证">密码认证</h1><p>要求用户在访问 <code>cp.lthero.top</code> 域名时输入密码，可以通过在 Nginx 服务器上配置基本的 HTTP 认证来实现。这需要设置用户名和密码，以及修改 Nginx 的配置文件来要求认证。以下是详细步骤：</p><h2 id="步骤-1-创建密码文件">步骤 1: 创建密码文件</h2><p>首先，你需要创建一个密码文件来存储用户名和经过加密的密码。这通常使用 <code>htpasswd</code> 工具完成，该工具随 Apache 提供的 <code>apache2-utils</code> 包一起安装。如果你的系统上还没有安装这个包，可以使用以下命令安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install apache2-utils</span><br></pre></td></tr></table></figure><p>接着，创建密码文件并添加用户。例如，创建一个名为 <code>clipadmin</code> 的用户：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo htpasswd -c /etc/nginx/.htpasswd clipadmin</span><br></pre></td></tr></table></figure><p>系统会提示你输入并确认密码。<code>-c</code> 选项用于创建新文件，如果已经有文件存在且仅需要添加或更新用户，不要使用 <code>-c</code> 选项。</p><h2 id="步骤-2-配置-nginx-以要求认证">步骤 2: 配置 Nginx 以要求认证</h2><p>编辑你的 Nginx 配置文件，通常位于 <code>/etc/nginx/sites-available/cp.lthero.top</code>，在适当的 <code>location</code> 或 <code>server</code> 块中添加认证配置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">server_name</span> cp.lthero.top;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/cp.lthero.top/fullchain.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/cp.lthero.top/privkey.pem;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">auth_basic</span> <span class="string">&quot;Restricted Content&quot;</span>;</span><br><span class="line">        <span class="attribute">auth_basic_user_file</span> /etc/nginx/.htpasswd;  <span class="comment"># 指向你的密码文件</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:9501;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&#x27;upgrade&#x27;</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的 <code>auth_basic</code> 指令启用基本认证，并设置提示信息为 “Restricted Content”。<code>auth_basic_user_file</code> 指定了包含用户名和密码的文件路径。</p><h2 id="步骤-3-重新加载-nginx">步骤 3: 重新加载 Nginx</h2><p>更改配置后，确保测试 Nginx 配置文件没有错误，然后重新加载 Nginx 使配置生效：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br><span class="line">sudo systemctl reload nginx</span><br></pre></td></tr></table></figure><h2 id="步骤-4-测试认证功能">步骤 4: 测试认证功能</h2><p>现在，当你访问 <code>https://cp.lthero.top</code> 时，浏览器应该会弹出一个登录对话框要求输入用户名和密码。只有正确输入认证信息后，用户才能访问站点内容。</p><p>这样你就完成了为 <code>cp.lthero.top</code> 配置基本 HTTP 认证的所有步骤，增加了一个访问该站点的安全层。</p><h2 id="修改用户名">修改用户名</h2><p>对于修改用户名，<code>htpasswd</code> 工具本身不提供直接修改用户名的选项。你需要先删除旧的用户名，然后添加新的用户名与密码。这里是如何操作的：</p><ol><li><p><strong>删除旧用户名</strong>:<br>使用 <code>htpasswd</code> 命令删除旧的用户名 <code>clipadmin</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo htpasswd -D /etc/nginx/.htpasswd clipadmin</span><br></pre></td></tr></table></figure><p>这个命令会从指定的密码文件中删除 <code>clipadmin</code> 用户。</p></li><li><p><strong>添加新用户名</strong>:<br>现在，你可以添加新的用户名 <code>lthero</code>，并为其设置密码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo htpasswd -b /etc/nginx/.htpasswd lthero 新密码</span><br></pre></td></tr></table></figure><p><code>-b</code> 参数允许你直接在命令行中提供密码，这可以简化脚本中的使用。但请注意，这种方式可能会导致密码暴露在历史记录中。如果安全是一个关注点，应该省略 <code>-b</code> 参数，命令将提示你输入密码。</p></li></ol><h3 id="确保-nginx-使用更新的密码文件">确保 Nginx 使用更新的密码文件</h3><p>完成用户名更新后，无需修改 Nginx 的配置，只要确保使用的是同一个 <code>.htpasswd</code> 文件。你可以通过重载 Nginx 来确保所有设置都是最新的：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t  <span class="comment"># 检查配置是否正确</span></span><br><span class="line">sudo systemctl reload nginx  <span class="comment"># 应用更改</span></span><br></pre></td></tr></table></figure><p>这样就完成了用户名的更改，用户在访问 <code>cp.lthero.top</code> 时现在需要使用新的用户名 <code>lthero</code> 和其密码进行认证。</p><hr><h1 id="命令行上传文件-上传内容">命令行上传文件|上传内容</h1><h2 id="curl-上传文字内容">【curl】上传文字内容</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -H <span class="string">&quot;Content-Type: text/plain&quot;</span> -d <span class="string">&quot;这里是您要发送的文本&quot;</span> https://cp.lthero.top/text?room=<span class="built_in">test</span></span><br></pre></td></tr></table></figure><ul><li><code>?room</code>参数一定要有</li><li><code>?room=</code> 表示公共房间</li><li><code>?room=test</code>则是上传到test房间</li></ul><h2 id="python-上传文字内容">【python】上传文字内容</h2><p><code>upload_text.py</code></p><blockquote><p>支持同时上传多段内容，支持中文，支持从标准输入流作参数如echo, cat</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_text</span>(<span class="params">text_url, data, room</span>):</span><br><span class="line">    text_url += <span class="string">f&quot;?room=<span class="subst">&#123;room&#125;</span>&quot;</span></span><br><span class="line">    headers = &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/plain; charset=utf-8&#x27;</span>&#125;</span><br><span class="line">    response = requests.post(text_url, data=data.encode(<span class="string">&#x27;utf-8&#x27;</span>), headers=headers)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;Send text to a specified room via the web API.&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;data&#x27;</span>, nargs=<span class="string">&#x27;*&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;The text data to send directly as arguments.&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--room&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">help</span>=<span class="string">&#x27;The name of the room (optional).&#x27;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">upload_url = <span class="string">&#x27;https://cp.lthero.top&#x27;</span></span><br><span class="line">    text_url = upload_url+<span class="string">&#x27;/text&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Handle multiple command-line arguments or single stdin input</span></span><br><span class="line">    <span class="keyword">if</span> args.data:</span><br><span class="line">        <span class="comment"># If data arguments are provided, send each one</span></span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> args.data:</span><br><span class="line">            response = send_text(text_url, data, args.room)</span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;发送成功: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;发送失败，状态码 <span class="subst">&#123;response.status_code&#125;</span>: <span class="subst">&#123;response.text&#125;</span>, 内容: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="keyword">not</span> sys.stdin.isatty():</span><br><span class="line">        <span class="comment"># If no data arguments but stdin has data</span></span><br><span class="line">        data = sys.stdin.read().strip()</span><br><span class="line">        <span class="comment">#for data in datas:</span></span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            response = send_text(text_url, data, args.room)</span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;发送成功: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;发送失败，状态码 <span class="subst">&#123;response.status_code&#125;</span>: <span class="subst">&#123;response.text&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;未接收到待发送的数据，请从标准输入流或从参数传入数据.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><ul><li>使用命令：</li><li><code>python upload_text.py 1234 </code> 上传1234到公共房间</li><li><code>python upload_text.py  &quot;这是第一条消息&quot; &quot;这是第二条消息&quot; --room test</code>   上传&quot;<strong>这是第一条消息</strong>&quot; &quot;<strong>这是第二条消息</strong>&quot;到test房间</li><li><code>echo &quot;11111111&quot; &quot;22222&quot;| python upload_text.py</code> 从echo传输多次数据到upload_text.py</li><li><code>cat upload_text.py | python upload_text.py --room lthero</code> 从cat传输数据到upload_text.py</li></ul><h2 id="python-上传文件">【python】上传文件</h2><p><code>upload_file.py</code></p><h3 id="无进度条版本">无进度条版本</h3><blockquote><p>支持同时上传多个文件</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>(<span class="params">url, file_paths, room</span>):</span><br><span class="line">    <span class="keyword">for</span> file_path <span class="keyword">in</span> file_paths:</span><br><span class="line">        file_name = os.path.basename(file_path)</span><br><span class="line">        file_size = os.path.getsize(file_path)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化上传</span></span><br><span class="line">        init_response = requests.post(<span class="string">f&#x27;<span class="subst">&#123;url&#125;</span>/upload&#x27;</span>, data=file_name, headers=&#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span>&#125;)</span><br><span class="line">        <span class="keyword">if</span> init_response.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;初始化失败: <span class="subst">&#123;file_name&#125;</span>, <span class="subst">&#123;init_response.text&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        uuid = init_response.json()[<span class="string">&#x27;result&#x27;</span>][<span class="string">&#x27;uuid&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 分块上传文件</span></span><br><span class="line">        chunk_size = <span class="number">12582912</span>  <span class="comment"># 12MB</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            uploaded_size = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> uploaded_size &lt; file_size:</span><br><span class="line">                chunk = f.read(chunk_size)</span><br><span class="line">                chunk_response = requests.post(<span class="string">f&#x27;<span class="subst">&#123;url&#125;</span>/upload/chunk/<span class="subst">&#123;uuid&#125;</span>&#x27;</span>, data=chunk, headers=&#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/octet-stream&#x27;</span>&#125;)</span><br><span class="line">                <span class="keyword">if</span> chunk_response.status_code != <span class="number">200</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;上传块失败: <span class="subst">&#123;file_name&#125;</span>, <span class="subst">&#123;chunk_response.text&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                uploaded_size += <span class="built_in">len</span>(chunk)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 完成上传</span></span><br><span class="line">        finish_response = requests.post(<span class="string">f&#x27;<span class="subst">&#123;url&#125;</span>/upload/finish/<span class="subst">&#123;uuid&#125;</span>&#x27;</span>, params=&#123;<span class="string">&#x27;room&#x27;</span>: room&#125;)</span><br><span class="line">        <span class="keyword">if</span> finish_response.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;完成上传失败: <span class="subst">&#123;file_name&#125;</span>, <span class="subst">&#123;finish_response.text&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;文件上传成功: <span class="subst">&#123;file_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;File Upload Script&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;file_paths&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, nargs=<span class="string">&#x27;+&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Path(s) to the files to be uploaded&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--room&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Room name for the upload context (optional)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    upload_url = <span class="string">&#x27;https://cp.lthero.top&#x27;</span></span><br><span class="line">    upload_file(upload_url, args.file_paths, args.room)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>使用命令：</li><li><code>python upload_file.py /media/Stuff/config.json</code> 上传config.json文件到公共房间</li><li><code>python upload_file.py /media/Stuff/config.json --room test </code> 上传config.json文件到test房间</li><li><code>python upload_file.py file1.txt file2.jpg file3.pdf --room test </code> 上传多个文件到test房间</li><li><code>python upload_file.py file* --room test </code> 支持<strong>符号写法</strong>，上传多个文件（file1.txt file2.jpg file3.pdf）到test房间</li></ul><h3 id="有进度条版本">有进度条版本</h3><blockquote><p>必须在python安装tqdm，命令：<code>pip3 install tqdm</code>或<code>pip install tqdm</code></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>(<span class="params">url, file_paths, room</span>):</span><br><span class="line">    <span class="keyword">for</span> file_path <span class="keyword">in</span> file_paths:</span><br><span class="line">        file_name = os.path.basename(file_path)</span><br><span class="line">        file_size = os.path.getsize(file_path)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化上传</span></span><br><span class="line">        init_response = requests.post(<span class="string">f&#x27;<span class="subst">&#123;url&#125;</span>/upload&#x27;</span>, data=file_name, headers=&#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span>&#125;)</span><br><span class="line">        <span class="keyword">if</span> init_response.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;初始化失败: <span class="subst">&#123;file_name&#125;</span>, <span class="subst">&#123;init_response.text&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        uuid = init_response.json()[<span class="string">&#x27;result&#x27;</span>][<span class="string">&#x27;uuid&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 分块上传文件</span></span><br><span class="line">        chunk_size = <span class="number">12582912</span>  <span class="comment"># 12MB</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f, tqdm(total=file_size, unit=<span class="string">&#x27;B&#x27;</span>, unit_scale=<span class="literal">True</span>, desc=file_name) <span class="keyword">as</span> progress:</span><br><span class="line">            uploaded_size = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> uploaded_size &lt; file_size:</span><br><span class="line">                chunk = f.read(chunk_size)</span><br><span class="line">                chunk_response = requests.post(<span class="string">f&#x27;<span class="subst">&#123;url&#125;</span>/upload/chunk/<span class="subst">&#123;uuid&#125;</span>&#x27;</span>, data=chunk, headers=&#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/octet-stream&#x27;</span>&#125;)</span><br><span class="line">                <span class="keyword">if</span> chunk_response.status_code != <span class="number">200</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;上传块失败: <span class="subst">&#123;file_name&#125;</span>, <span class="subst">&#123;chunk_response.text&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                chunk_size = <span class="built_in">len</span>(chunk)</span><br><span class="line">                uploaded_size += chunk_size</span><br><span class="line">                progress.update(chunk_size)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 完成上传</span></span><br><span class="line">        finish_response = requests.post(<span class="string">f&#x27;<span class="subst">&#123;url&#125;</span>/upload/finish/<span class="subst">&#123;uuid&#125;</span>&#x27;</span>, params=&#123;<span class="string">&#x27;room&#x27;</span>: room&#125;)</span><br><span class="line">        <span class="keyword">if</span> finish_response.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;完成上传失败: <span class="subst">&#123;file_name&#125;</span>, <span class="subst">&#123;finish_response.text&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;文件上传成功: <span class="subst">&#123;file_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;File Upload Script&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;file_paths&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, nargs=<span class="string">&#x27;+&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Path(s) to the files to be uploaded&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--room&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Room name for the upload context (optional)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    upload_url = <span class="string">&#x27;https://cp.lthero.top&#x27;</span></span><br><span class="line">    upload_file(upload_url, args.file_paths, args.room)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="全局使用">全局使用</h2><p>要在全局任意路径都可以使用 <code>upload_file.py</code> 和 <code>upload_text.py</code> 这两个脚本，涉及到以下几个步骤：</p><h3 id="1-将脚本移动到全局可访问的路径">1. 将脚本移动到全局可访问的路径</h3><p>将脚本放在一个所有用户都能访问的目录中，如 <code>/usr/local/bin</code>。这个目录通常已经在大多数 Linux 发行版的环境变量 <code>$PATH</code> 中，所以放在这里的程序可以被全局调用。</p><p>首先，确保脚本具有可执行权限：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x upload_file.py</span><br><span class="line"><span class="built_in">chmod</span> +x upload_text.py</span><br></pre></td></tr></table></figure><p>然后，将它们移动到 <code>/usr/local/bin</code> 目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> upload_file.py /usr/local/bin/upf</span><br><span class="line">sudo <span class="built_in">cp</span> upload_text.py /usr/local/bin/upt</span><br></pre></td></tr></table></figure><h3 id="2-修改脚本的首行-shebang">2. 修改脚本的首行（Shebang）</h3><p>修改<code>/usr/local/bin/upf</code>和<code>/usr/local/bin/upt</code></p><p>确保脚本的第一行指向 Python 解释器的正确路径。这被称为 “shebang” 行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br></pre></td></tr></table></figure><p>如果不知道python路径，使用<code>which python</code>可以查询出来</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">which</span> python</span><br><span class="line">/opt/anaconda3/bin/python</span><br></pre></td></tr></table></figure><p>则需要添加<code>#!/opt/anaconda3/bin/python</code>在<code>/usr/local/bin/upt</code>首行</p><h3 id="3-更新环境变量-如果需要">3. 更新环境变量（如果需要）</h3><p>如果将脚本放在除了 <code>/usr/local/bin</code> 之外的目录，可能需要将该目录添加到环境变量 <code>$PATH</code> 中。编辑 shell 配置文件（例如 <code>~/.bashrc</code> 或 <code>~/.zshrc</code>），添加以下行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$PATH</span>:/path/to/your/script_directory&quot;</span></span><br></pre></td></tr></table></figure><p>之后，运行 <code>source ~/.bashrc</code> （或对应的配置文件），以使更改生效。</p><h3 id="4-直接调用脚本">4. 直接调用脚本</h3><p>完成上述步骤后，应该能够从任何目录直接调用 <code>upload_file</code> 和 <code>upload_text</code>，如下所示：</p><h4 id="上传文件">上传文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">upf somefile.txt --room <span class="string">&quot;test&quot;</span></span><br><span class="line">upf --room <span class="string">&quot;lthero&quot;</span> somefile.txt</span><br><span class="line">upf --room <span class="string">&quot;lthero&quot;</span> file*</span><br></pre></td></tr></table></figure><ul><li><code>file*</code>: 支持通符号</li><li><strong>不支持</strong>整个文件夹上传</li></ul><h4 id="上传文字">上传文字</h4><p>支持多种写法</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upt <span class="string">&quot;Here is some text&quot;</span> --room <span class="string">&quot;test&quot;</span></span><br><span class="line">upt --room <span class="string">&quot;test&quot;</span> <span class="string">&quot;Here is some text&quot;</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;11111111&quot;</span> <span class="string">&quot;22222&quot;</span> | upt</span><br><span class="line"><span class="built_in">cat</span> upload_file.py | upt</span><br></pre></td></tr></table></figure><hr><h1 id="微信">微信</h1><blockquote><p>项目：<a href="https://github.com/wangrongding/wechat-bot">https://github.com/wangrongding/wechat-bot</a></p></blockquote><p>把<code>config.js</code>修改成这样</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义机器人的名称，这里是为了防止群聊消息太多，所以只有艾特机器人才会回复，</span></span><br><span class="line"><span class="comment">// 这里不要把@去掉，在@后面加上你启动机器人账号的微信名称</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> botName = <span class="string">&#x27;@Lthero&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> uploadTextURL=<span class="string">&#x27;https://cp.lthero.top/text&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> uploadFileURL=<span class="string">&#x27;https://cp.lthero.top&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 群聊白名单，白名单内的群聊才会自动回复</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> roomWhiteList = [<span class="string">&#x27;LtheroG&#x27;</span>, <span class="string">&#x27;YesRight&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 联系人白名单，白名单内的联系人才会自动回复</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> aliasWhiteList = [<span class="string">&#x27;lthero&#x27;</span>,<span class="string">&#x27;Lthero_&#x27;</span>,<span class="string">&#x27;Jntm&#x27;</span>,<span class="string">&#x27;zbter&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置upt的名字，如果设置为空，则发送任意内容都会被上传，否则以&quot;upt&quot;开头的文字才会被上传</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> uptName = <span class="string">&#x27;upt&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置上传到的room的参数名，upt --room test </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> up2roomName = <span class="string">&#x27;--room&#x27;</span></span><br></pre></td></tr></table></figure><p>把<code>sendMessage.js</code>修改成这样</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; botName, roomWhiteList, aliasWhiteList, uploadTextURL,uploadFileURL,uptName,up2roomName&#125; <span class="keyword">from</span> <span class="string">&#x27;../../config.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; getServe &#125; <span class="keyword">from</span> <span class="string">&#x27;./serve.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; promises &#125; <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Uploads text to a specified URL.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">text_url</span> - Base URL for the text upload.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">data</span> - Text data to be uploaded.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">cliproom</span> - The room parameter to be appended to the URL.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Promise</span>&#125; The HTTP response.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">send_text</span>(<span class="params">text_url, data, cliproom = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">  text_url += <span class="string">`?room=<span class="subst">$&#123;cliproom&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> axios.<span class="title function_">post</span>(text_url, data, &#123;</span><br><span class="line">          <span class="attr">headers</span>: &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/plain; charset=utf-8&#x27;</span>&#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span> response;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;HTTP request failed:&#x27;</span>, error);</span><br><span class="line">      <span class="keyword">throw</span> error; <span class="comment">// Rethrow to handle it in the calling function</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">upText2ClipBoard</span>(<span class="params">uploadURL, isRoom, content ,remarkName=<span class="string">&quot;&quot;</span></span>)&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> args = content.<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    <span class="comment">// const cliproomIndex = args.indexOf(&#x27;--room&#x27;);</span></span><br><span class="line">    <span class="keyword">const</span> cliproomIndex = args.<span class="title function_">indexOf</span>(up2roomName);</span><br><span class="line">    <span class="keyword">let</span> data, cliproom;</span><br><span class="line">    cliproom=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (cliproomIndex &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">        cliproom = args[cliproomIndex + <span class="number">1</span>];</span><br><span class="line">        <span class="comment">// Combine all elements after &quot;--room &lt;roomname&gt;&quot; into the data string</span></span><br><span class="line">        data = args.<span class="title function_">slice</span>(cliproomIndex + <span class="number">2</span>).<span class="title function_">join</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If there is no &quot;--room&quot;, treat all arguments after &quot;upt&quot; as data</span></span><br><span class="line">        data = args.<span class="title function_">slice</span>(<span class="number">1</span>).<span class="title function_">join</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        cliproom = remarkName; <span class="comment">// Use a remarkName room if none specified</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">send_text</span>(uploadURL, data, cliproom);</span><br><span class="line">        <span class="keyword">if</span> (response.<span class="property">status</span> === <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(isRoom)&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="string">`内容上传成功`</span></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="string">`内容上传成功, 房间: <span class="subst">$&#123;cliproom&#125;</span>`</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">`内容上传失败，状态码：<span class="subst">$&#123;response.status&#125;</span>`</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`出错啦：<span class="subst">$&#123;error.message&#125;</span>`</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">checkAndUploadFile</span>(<span class="params">uploadURL, isRoom,filePath,remarkName=<span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 检查文件是否存在</span></span><br><span class="line">      <span class="keyword">await</span> promises.<span class="title function_">access</span>(filePath);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🌸🌸🌸 文件收到，准备上传：<span class="subst">$&#123;filePath&#125;</span>`</span>);</span><br><span class="line">      <span class="comment">// 如果文件存在，则上传</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">uploadFile2ClipBoard</span>(uploadURL, isRoom, filePath,remarkName);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`文件检查失败或不存在: <span class="subst">$&#123;error&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">uploadFile2ClipBoard</span>(<span class="params">uploadUrl, isRoom, filePath,room=<span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> fileName = path.<span class="title function_">basename</span>(filePath);</span><br><span class="line">    <span class="comment">// console.log(&#x27;🌸🌸🌸 filePath: &#x27;, filePath)</span></span><br><span class="line">    <span class="comment">// console.log(&#x27;🌸🌸🌸 fileName: &#x27;, fileName)</span></span><br><span class="line">    <span class="keyword">const</span> fileSize = fs.<span class="title function_">statSync</span>(filePath).<span class="property">size</span>;</span><br><span class="line">    <span class="comment">// console.log(&#x27;🌸🌸🌸 fileSize: &#x27;, fileSize)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Initialize upload</span></span><br><span class="line">        <span class="keyword">const</span> initUrl = <span class="string">`<span class="subst">$&#123;uploadUrl&#125;</span>/upload`</span>;</span><br><span class="line">        <span class="comment">// console.log(&#x27;🌸🌸🌸 initUrl: &#x27;, initUrl)</span></span><br><span class="line">        <span class="keyword">const</span> initResponse = <span class="keyword">await</span> axios.<span class="title function_">post</span>(initUrl, fileName, &#123;</span><br><span class="line">            <span class="attr">headers</span>: &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span> &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// console.log(&#x27;🌸🌸🌸 initResponse: &#x27;, initResponse)</span></span><br><span class="line">        <span class="keyword">if</span> (initResponse.<span class="property">status</span> !== <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`初始化失败: <span class="subst">$&#123;initResponse.data&#125;</span>_<span class="subst">$&#123;initResponse.status&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> uuid = initResponse.<span class="property">data</span>.<span class="property">result</span>.<span class="property">uuid</span>;</span><br><span class="line">        <span class="keyword">const</span> chunkSize = <span class="number">12582912</span>; <span class="comment">// 12 MB</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read and upload the file in chunks</span></span><br><span class="line">        <span class="keyword">const</span> stream = fs.<span class="title function_">createReadStream</span>(filePath, &#123; <span class="attr">highWaterMark</span>: chunkSize &#125;);</span><br><span class="line">        <span class="keyword">let</span> uploadedSize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">const</span> chunk <span class="keyword">of</span> stream) &#123;</span><br><span class="line">            <span class="keyword">const</span> chunkUrl = <span class="string">`<span class="subst">$&#123;uploadUrl&#125;</span>/upload/chunk/<span class="subst">$&#123;uuid&#125;</span>`</span>;</span><br><span class="line">            <span class="keyword">const</span> chunkResponse = <span class="keyword">await</span> axios.<span class="title function_">post</span>(chunkUrl, chunk, &#123;</span><br><span class="line">                <span class="attr">headers</span>: &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/octet-stream&#x27;</span> &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">if</span> (chunkResponse.<span class="property">status</span> !== <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`分块上传失败: <span class="subst">$&#123;chunkResponse.data&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            uploadedSize += chunk.<span class="property">length</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Complete the upload</span></span><br><span class="line">        <span class="keyword">const</span> finishUrl = <span class="string">`<span class="subst">$&#123;uploadUrl&#125;</span>/upload/finish/<span class="subst">$&#123;uuid&#125;</span>`</span>;</span><br><span class="line">        <span class="keyword">const</span> finishParams = &#123; <span class="attr">params</span>: &#123; room &#125; &#125;;</span><br><span class="line">        <span class="keyword">const</span> finishResponse = <span class="keyword">await</span> axios.<span class="title function_">post</span>(finishUrl, <span class="literal">null</span>, finishParams);</span><br><span class="line">        <span class="keyword">if</span> (finishResponse.<span class="property">status</span> !== <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Finish upload failed: <span class="subst">$&#123;finishResponse.data&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">await</span> promises.<span class="title function_">unlink</span>(filePath);</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🌸🌸🌸 文件上传成功！房间: <span class="subst">$&#123;room&#125;</span>`</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;🌸🌸🌸 本地文件删除成功！&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(isRoom)&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">`文件上传成功！ <span class="subst">$&#123;fileName&#125;</span>`</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`文件上传成功！ <span class="subst">$&#123;fileName&#125;</span> , 房间: <span class="subst">$&#123;room&#125;</span>`</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Error uploading file: <span class="subst">$&#123;fileName&#125;</span>, <span class="subst">$&#123;error&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`Error uploading file: <span class="subst">$&#123;fileName&#125;</span>, <span class="subst">$&#123;error&#125;</span>`</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Unknown = 0,</span></span><br><span class="line"><span class="comment">// Attachment = 1, // Attach(6),</span></span><br><span class="line"><span class="comment">// Audio = 2, // Audio(1), Voice(34)</span></span><br><span class="line"><span class="comment">// Contact = 3, // ShareCard(42)</span></span><br><span class="line"><span class="comment">// ChatHistory = 4, // ChatHistory(19)</span></span><br><span class="line"><span class="comment">// Emoticon = 5, // Sticker: Emoticon(15), Emoticon(47)</span></span><br><span class="line"><span class="comment">// Image = 6, // Img(2), Image(3)</span></span><br><span class="line"><span class="comment">// Text = 7, // Text(1)</span></span><br><span class="line"><span class="comment">// Location = 8, // Location(48)</span></span><br><span class="line"><span class="comment">// MiniProgram = 9, // MiniProgram(33)</span></span><br><span class="line"><span class="comment">// GroupNote = 10, // GroupNote(53)</span></span><br><span class="line"><span class="comment">// Transfer = 11, // Transfers(2000)</span></span><br><span class="line"><span class="comment">// RedEnvelope = 12, // RedEnvelopes(2001)</span></span><br><span class="line"><span class="comment">// Recalled = 13, // Recalled(10002)</span></span><br><span class="line"><span class="comment">// Url = 14, // Url(5)</span></span><br><span class="line"><span class="comment">// Video = 15, // Video(4), Video(43)</span></span><br><span class="line"><span class="comment">// Post = 16, // Moment, Channel, Tweet, etc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默认消息发送</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">msg</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">bot</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ServiceType 服务类型 &#x27;GPT&#x27; | &#x27;Kimi&#x27;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Promise&lt;void&gt;</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">defaultMessage</span>(<span class="params">msg, bot, ServiceType = <span class="string">&#x27;GPT&#x27;</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> getReply = <span class="title function_">getServe</span>(<span class="title class_">ServiceType</span>)</span><br><span class="line">  <span class="keyword">const</span> contact = msg.<span class="title function_">talker</span>() <span class="comment">// 发消息人</span></span><br><span class="line">  <span class="keyword">const</span> receiver = msg.<span class="title function_">to</span>() <span class="comment">// 消息接收人</span></span><br><span class="line">  <span class="keyword">const</span> content = msg.<span class="title function_">text</span>() <span class="comment">// 消息内容</span></span><br><span class="line">  <span class="keyword">const</span> room = msg.<span class="title function_">room</span>() <span class="comment">// 是否是群消息</span></span><br><span class="line">  <span class="keyword">const</span> roomName = (<span class="keyword">await</span> room?.<span class="title function_">topic</span>()) || <span class="literal">null</span> <span class="comment">// 群名称</span></span><br><span class="line">  <span class="keyword">const</span> alias = (<span class="keyword">await</span> contact.<span class="title function_">alias</span>()) || (<span class="keyword">await</span> contact.<span class="title function_">name</span>()) <span class="comment">// 发消息人昵称</span></span><br><span class="line">  <span class="keyword">const</span> remarkName = <span class="keyword">await</span> contact.<span class="title function_">alias</span>() <span class="comment">// 备注名称</span></span><br><span class="line">  <span class="keyword">const</span> name = <span class="keyword">await</span> contact.<span class="title function_">name</span>() <span class="comment">// 微信名称</span></span><br><span class="line">  <span class="keyword">const</span> isText = msg.<span class="title function_">type</span>() === bot.<span class="property">Message</span>.<span class="property">Type</span>.<span class="property">Text</span> <span class="comment">// 消息类型是否为文本</span></span><br><span class="line">  <span class="keyword">const</span> isRoom = roomWhiteList.<span class="title function_">includes</span>(roomName) &amp;&amp; content.<span class="title function_">includes</span>(<span class="string">`<span class="subst">$&#123;botName&#125;</span>`</span>) <span class="comment">// 是否在群聊白名单内并且艾特了机器人</span></span><br><span class="line">  <span class="keyword">const</span> isAlias = aliasWhiteList.<span class="title function_">includes</span>(remarkName) || aliasWhiteList.<span class="title function_">includes</span>(name) <span class="comment">// 发消息的人是否在联系人白名单内</span></span><br><span class="line">  <span class="keyword">const</span> isBotSelf = botName === remarkName || botName === name <span class="comment">// 是否是机器人自己</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO 你们可以根据自己的需求修改这里的逻辑</span></span><br><span class="line">  <span class="keyword">if</span> (isBotSelf) <span class="keyword">return</span> <span class="comment">// 如果是机器人自己发送的消息</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;🌸🌸🌸 / msg_type: &#x27;</span>, msg.<span class="title function_">type</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if (content.startsWith(&#x27;/upf&#x27;)) &#123;</span></span><br><span class="line">    <span class="comment">//   console.log(&#x27;🌸🌸🌸 / msg_type: &#x27;, msg.type())</span></span><br><span class="line">    <span class="comment">//   console.log(&#x27;🌸🌸🌸 / upf: &#x27;, msg)</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上传文件</span></span><br><span class="line">    <span class="keyword">if</span> ( isAlias &amp;&amp; msg.<span class="title function_">type</span>() === bot.<span class="property">Message</span>.<span class="property">Type</span>.<span class="property">Attachment</span> || msg.<span class="title function_">type</span>()===<span class="number">6</span> ||msg.<span class="title function_">type</span>()===<span class="number">2</span> ||msg.<span class="title function_">type</span>()===<span class="number">15</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;🌸🌸🌸 收到文件消息，准备下载...&#x27;</span>);</span><br><span class="line">      <span class="comment">// 创建文件流</span></span><br><span class="line">      <span class="keyword">const</span> fileBox = <span class="keyword">await</span> msg.<span class="title function_">toFileBox</span>();</span><br><span class="line">      <span class="keyword">const</span> path = <span class="string">&quot;/app/src/TempFiles/&quot;</span></span><br><span class="line">      <span class="keyword">const</span> fileName = path+fileBox.<span class="property">name</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 保存文件到本地</span></span><br><span class="line">      <span class="keyword">await</span> fileBox.<span class="title function_">toFile</span>(fileName, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 检查文件存在并上传</span></span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">checkAndUploadFile</span>(uploadFileURL,room,fileName,remarkName);</span><br><span class="line">      <span class="keyword">if</span> (room)&#123;</span><br><span class="line">        <span class="keyword">await</span> room.<span class="title function_">say</span>(response);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">await</span> contact.<span class="title function_">say</span>(response);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">    <span class="comment">// 区分群聊和私聊</span></span><br><span class="line">    <span class="keyword">if</span> (isText &amp;&amp; isRoom &amp;&amp; room ) &#123;</span><br><span class="line">      <span class="keyword">const</span> question = <span class="keyword">await</span> msg.<span class="title function_">mentionText</span>() || content.<span class="title function_">replace</span>(<span class="string">`<span class="subst">$&#123;botName&#125;</span>`</span>, <span class="string">&#x27;&#x27;</span>) <span class="comment">// 去掉艾特的消息主体</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;🌸🌸🌸 / question: &#x27;</span>, question)</span><br><span class="line">      <span class="comment">// 使用upt上传文字，私聊回复</span></span><br><span class="line">      <span class="comment">// if (question.startsWith(&#x27;upt&#x27;)) &#123;</span></span><br><span class="line">      <span class="keyword">if</span> (question.<span class="title function_">startsWith</span>(uptName)) &#123;</span><br><span class="line">        <span class="comment">// 无contract</span></span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">upText2ClipBoard</span>(uploadTextURL,room, question, remarkName)</span><br><span class="line">        <span class="keyword">await</span> room.<span class="title function_">say</span>(response)</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 使用gpt</span></span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">getReply</span>(question,<span class="string">&quot;gpt3&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> room.<span class="title function_">say</span>(response)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 私人聊天，白名单内的直接发送</span></span><br><span class="line">    <span class="keyword">if</span> (isText &amp;&amp; isAlias &amp;&amp; !room ) &#123;</span><br><span class="line">      <span class="comment">// 用gpt</span></span><br><span class="line">      <span class="keyword">if</span>(content.<span class="title function_">startsWith</span>(<span class="string">&#x27;gpt&#x27;</span>))&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;🌸🌸🌸 / content: &#x27;</span>, content)</span><br><span class="line">        <span class="keyword">let</span> args = content.<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">getReply</span>(content,args[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">await</span> contact.<span class="title function_">say</span>(response)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 使用upt命令上传文字</span></span><br><span class="line">      <span class="comment">// if (question.startsWith(&#x27;upt&#x27;)) &#123;</span></span><br><span class="line">      <span class="keyword">if</span> (content.<span class="title function_">startsWith</span>(uptName)) &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">upText2ClipBoard</span>(uploadTextURL,room, content , remarkName);</span><br><span class="line">        <span class="keyword">await</span> contact.<span class="title function_">say</span>(response);</span><br><span class="line">      &#125;      </span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(e)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分片消息发送</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">message</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">bot</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Promise&lt;void&gt;</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">shardingMessage</span>(<span class="params">message, bot</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> talker = message.<span class="title function_">talker</span>()</span><br><span class="line">  <span class="keyword">const</span> isText = message.<span class="title function_">type</span>() === bot.<span class="property">Message</span>.<span class="property">Type</span>.<span class="property">Text</span> <span class="comment">// 消息类型是否为文本</span></span><br><span class="line">  <span class="keyword">if</span> (talker.<span class="title function_">self</span>() || message.<span class="title function_">type</span>() &gt; <span class="number">10</span> || (talker.<span class="title function_">name</span>() === <span class="string">&#x27;微信团队&#x27;</span> &amp;&amp; isText)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> text = message.<span class="title function_">text</span>()</span><br><span class="line">  <span class="keyword">const</span> room = message.<span class="title function_">room</span>()</span><br><span class="line">  <span class="keyword">if</span> (!room) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Chat GPT Enabled User: <span class="subst">$&#123;talker.name()&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">getChatGPTReply</span>(text)</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">trySay</span>(talker, response)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> realText = <span class="title function_">splitMessage</span>(text)</span><br><span class="line">  <span class="comment">// 如果是群聊但不是指定艾特人那么就不进行发送消息</span></span><br><span class="line">  <span class="keyword">if</span> (text.<span class="title function_">indexOf</span>(<span class="string">`<span class="subst">$&#123;botName&#125;</span>`</span>) === -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  realText = text.<span class="title function_">replace</span>(<span class="string">`<span class="subst">$&#123;botName&#125;</span>`</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> topic = <span class="keyword">await</span> room.<span class="title function_">topic</span>()</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">getChatGPTReply</span>(realText)</span><br><span class="line">  <span class="keyword">const</span> result = <span class="string">`<span class="subst">$&#123;realText&#125;</span>\n ---------------- \n <span class="subst">$&#123;response&#125;</span>`</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">trySay</span>(room, result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分片长度</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SINGLE_MESSAGE_MAX_SIZE</span> = <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> talker 发送哪个  room为群聊类 text为单人</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">msg</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Promise&lt;void&gt;</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">trySay</span>(<span class="params">talker, msg</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> messages = []</span><br><span class="line">  <span class="keyword">let</span> message = msg</span><br><span class="line">  <span class="keyword">while</span> (message.<span class="property">length</span> &gt; <span class="variable constant_">SINGLE_MESSAGE_MAX_SIZE</span>) &#123;</span><br><span class="line">    messages.<span class="title function_">push</span>(message.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="variable constant_">SINGLE_MESSAGE_MAX_SIZE</span>))</span><br><span class="line">    message = message.<span class="title function_">slice</span>(<span class="variable constant_">SINGLE_MESSAGE_MAX_SIZE</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  messages.<span class="title function_">push</span>(message)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> msg <span class="keyword">of</span> messages) &#123;</span><br><span class="line">    <span class="keyword">await</span> talker.<span class="title function_">say</span>(msg)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分组消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">text</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Promise&lt;*&gt;</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">splitMessage</span>(<span class="params">text</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> realText = text</span><br><span class="line">  <span class="keyword">const</span> item = text.<span class="title function_">split</span>(<span class="string">&#x27;- - - - - - - - - - - - - - -&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> (item.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    realText = item[item.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> realText</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在.env文件中</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># .env</span><br><span class="line"></span><br><span class="line"># 选择model</span><br><span class="line">model=<span class="string">&quot;gpt-3&quot;</span></span><br><span class="line"># OpenAi 的api key<span class="punctuation">,</span> 去 https<span class="punctuation">:</span><span class="comment">//beta.openai.com/account/api-keys 中生成一个即可</span></span><br><span class="line">OPENAI_API_KEY=&#x27;sk-xxxxxxx&#x27;</span><br><span class="line"># endpoint默认用https<span class="punctuation">:</span><span class="comment">//api.openai.com</span></span><br><span class="line"># API_ENDPOINT=&#x27;https<span class="punctuation">:</span><span class="comment">//api.openai.com&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Kimi 的api key<span class="punctuation">,</span> 去 https<span class="punctuation">:</span><span class="comment">//platform.moonshot.cn/console/api-keys</span></span><br><span class="line">KIMI_API_KEY=&#x27;&#x27;</span><br><span class="line"></span><br><span class="line"># 科大讯飞<span class="punctuation">,</span> 去 https<span class="punctuation">:</span><span class="comment">//console.xfyun.cn/services</span></span><br><span class="line">XUNFEI_APP_ID=&#x27;&#x27;</span><br><span class="line">XUNFEI_API_KEY=&#x27;&#x27;</span><br><span class="line">XUNFEI_API_SECRET=&#x27;&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在openai目录下的index.js修改成</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">import <span class="punctuation">&#123;</span> remark <span class="punctuation">&#125;</span> from &#x27;remark&#x27;</span><br><span class="line">import stripMarkdown from &#x27;strip-markdown&#x27;</span><br><span class="line">import <span class="punctuation">&#123;</span> Configuration<span class="punctuation">,</span> OpenAIApi <span class="punctuation">&#125;</span> from &#x27;openai&#x27;</span><br><span class="line">import axios from &#x27;axios&#x27;  <span class="comment">// 引入axios进行HTTP请求</span></span><br><span class="line"></span><br><span class="line">import dotenv from &#x27;dotenv&#x27;</span><br><span class="line">const env = dotenv.config().parsed <span class="comment">// 环境参数</span></span><br><span class="line">const models=<span class="punctuation">&#123;</span><span class="attr">&quot;gpt4a&quot;</span><span class="punctuation">:</span><span class="string">&quot;gpt-4-all&quot;</span><span class="punctuation">,</span><span class="attr">&quot;gpt3&quot;</span><span class="punctuation">:</span><span class="string">&quot;gpt-3.5-turbo&quot;</span><span class="punctuation">,</span><span class="attr">&quot;gpt4t&quot;</span><span class="punctuation">:</span><span class="string">&quot;gpt-4-turbo-2024-04-09&quot;</span><span class="punctuation">,</span><span class="attr">&quot;gpt4&quot;</span><span class="punctuation">:</span><span class="string">&quot;gpt-4-0613&quot;</span><span class="punctuation">,</span><span class="attr">&quot;gpt&quot;</span><span class="punctuation">:</span><span class="string">&quot;gpt-3.5-turbo&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">const configuration = new Configuration(<span class="punctuation">&#123;</span></span><br><span class="line">  apiKey<span class="punctuation">:</span> env.OPENAI_API_KEY<span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span>)</span><br><span class="line">const openai = new OpenAIApi(configuration)</span><br><span class="line"></span><br><span class="line">export async function getGptReply(prompt<span class="punctuation">,</span>model=<span class="string">&quot;&quot;</span>) <span class="punctuation">&#123;</span></span><br><span class="line">  console.log(&#x27;🚀🚀🚀 / prompt&#x27;<span class="punctuation">,</span> prompt)</span><br><span class="line">  <span class="comment">//let chosen_model = &#x27;text-davinci-003&#x27;</span></span><br><span class="line">  let chosen_model</span><br><span class="line">  if(model==<span class="string">&quot;&quot;</span>)<span class="punctuation">&#123;</span></span><br><span class="line">    chosen_model = env.model</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  else<span class="punctuation">&#123;</span></span><br><span class="line">    chosen_model = models<span class="punctuation">[</span>model<span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  let reply = &#x27;&#x27;</span><br><span class="line">  if (chosen_model == &#x27;text-davinci<span class="number">-003</span>&#x27;) <span class="punctuation">&#123;</span></span><br><span class="line">    console.log(&#x27;🚀🚀🚀 / Using model&#x27;<span class="punctuation">,</span> chosen_model)</span><br><span class="line">    const response = await openai.createCompletion(<span class="punctuation">&#123;</span></span><br><span class="line">      model<span class="punctuation">:</span> chosen_model<span class="punctuation">,</span></span><br><span class="line">      prompt<span class="punctuation">:</span> prompt<span class="punctuation">,</span></span><br><span class="line">      temperature<span class="punctuation">:</span> <span class="number">0.8</span><span class="punctuation">,</span> <span class="comment">// 每次返回的答案的相似度0-1（0：每次都一样，1：每次都不一样）</span></span><br><span class="line">      max_tokens<span class="punctuation">:</span> <span class="number">4</span>_000<span class="punctuation">,</span></span><br><span class="line">      top_p<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      frequency_penalty<span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">      presence_penalty<span class="punctuation">:</span> <span class="number">0.6</span><span class="punctuation">,</span></span><br><span class="line">      stop<span class="punctuation">:</span> <span class="punctuation">[</span>&#x27; Human<span class="punctuation">:</span>&#x27;<span class="punctuation">,</span> &#x27; AI<span class="punctuation">:</span>&#x27;<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#125;</span>)</span><br><span class="line"></span><br><span class="line">    reply = markdownToText(response.data.choices<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>.text)</span><br><span class="line">  <span class="punctuation">&#125;</span> else if (chosen_model == &#x27;gpt<span class="number">-3.5</span>-turbo&#x27;) <span class="punctuation">&#123;</span></span><br><span class="line">    console.log(&#x27;🚀🚀🚀 / Using model&#x27;<span class="punctuation">,</span> chosen_model)</span><br><span class="line">    const response = await openai.createChatCompletion(<span class="punctuation">&#123;</span></span><br><span class="line">      model<span class="punctuation">:</span> chosen_model<span class="punctuation">,</span></span><br><span class="line">      messages<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system&quot;</span><span class="punctuation">,</span> content<span class="punctuation">:</span> <span class="string">&quot;You are a personal assistant.&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span><span class="punctuation">,</span> content<span class="punctuation">:</span> prompt <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span>)</span><br><span class="line"></span><br><span class="line">    reply = markdownToText(response.data.choices<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>.message.content)</span><br><span class="line">  <span class="punctuation">&#125;</span>else<span class="punctuation">&#123;</span></span><br><span class="line">    console.log(&#x27;🚀🚀🚀 / Using model&#x27;<span class="punctuation">,</span> chosen_model)</span><br><span class="line"></span><br><span class="line">    const response = await axios.post(env.API_ENDPOINT<span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">      model<span class="punctuation">:</span> chosen_model<span class="punctuation">,</span></span><br><span class="line">      messages<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system&quot;</span><span class="punctuation">,</span> content<span class="punctuation">:</span> <span class="string">&quot;You are a helpful assistant.&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span><span class="punctuation">,</span> content<span class="punctuation">:</span> prompt <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      max_tokens<span class="punctuation">:</span> <span class="number">1500</span><span class="punctuation">,</span></span><br><span class="line">      temperature<span class="punctuation">:</span> <span class="number">0.7</span><span class="punctuation">,</span></span><br><span class="line">      top_p<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      frequency_penalty<span class="punctuation">:</span> <span class="number">0.0</span><span class="punctuation">,</span></span><br><span class="line">      presence_penalty<span class="punctuation">:</span> <span class="number">0.6</span><span class="punctuation">,</span></span><br><span class="line">      stop<span class="punctuation">:</span> <span class="punctuation">[</span>&#x27; Human<span class="punctuation">:</span>&#x27;<span class="punctuation">,</span> &#x27; AI<span class="punctuation">:</span>&#x27;<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">      headers<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        &#x27;Authorization&#x27;<span class="punctuation">:</span> `Bearer $<span class="punctuation">&#123;</span>env.OPENAI_API_KEY<span class="punctuation">&#125;</span>`<span class="punctuation">,</span> <span class="comment">// Make sure your API key is correctly set</span></span><br><span class="line">        &#x27;Content-Type&#x27;<span class="punctuation">:</span> &#x27;application/json&#x27;</span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span>);</span><br><span class="line">    <span class="comment">// Extract and clean the markdown response</span></span><br><span class="line">    reply = markdownToText(response.data.choices<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]</span>.message.content);</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  console.log(&#x27;🚀🚀🚀 / reply&#x27;<span class="punctuation">,</span> reply)</span><br><span class="line">  return `$<span class="punctuation">&#123;</span>reply<span class="punctuation">&#125;</span>\nVia $<span class="punctuation">&#123;</span>chosen_model<span class="punctuation">&#125;</span>`</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">function markdownToText(markdown) <span class="punctuation">&#123;</span></span><br><span class="line">  return remark()</span><br><span class="line">    .use(stripMarkdown)</span><br><span class="line">    .processSync(markdown ?? &#x27;&#x27;)</span><br><span class="line">    .toString()</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>另外，在src/wechaty/index.js修改以下内容，从而只使用ChatGPT，以避免要用户选择</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">  inquirer</span><br><span class="line">    <span class="title function_">handleStart</span>(<span class="string">&#x27;ChatGPT&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改完成后，进行docker打包</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker build . -t wechat-bot</span><br></pre></td></tr></table></figure><p>运行docker容器</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d -it --<span class="built_in">rm</span> --name wechat-bot -v $(<span class="built_in">pwd</span>)/config.js:/app/config.js -v $(<span class="built_in">pwd</span>)/.env:/app/.env wechat-bot</span><br></pre></td></tr></table></figure><ul><li>这里的-it一定要加，否则运行后可能会自动停止</li></ul><p>随后，使用下面的命令查看日志，<strong>运行时会跳出来二维码，扫码登录即可</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker logs -f wechat-bot</span><br></pre></td></tr></table></figure><p>或用我打包的镜像</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意，这里的latest不一定是最新的</span></span><br><span class="line">sudo docker pull lthero1/wechat-bot-lthero:latest</span><br><span class="line"><span class="comment"># lthero1/wechat-bot-lthero:1.6   是最新版本</span></span><br><span class="line">sudo docker run -d -it --<span class="built_in">rm</span> --name wechat-bot -v $(<span class="built_in">pwd</span>)/config.js:/app/config.js -v $(<span class="built_in">pwd</span>)/.env:/app/.env lthero1/wechat-bot-lthero:latest</span><br></pre></td></tr></table></figure><p>运行后效果</p><ol><li>给机器人微信账号发送文件、图像等会直接上传到<code>微信备注的</code>房间</li><li>使用<code>upt --room test xxxxxxxxx</code> 可以将内容发送到test房间</li><li>使用<code>upt  xxxxxxxxx</code> 可以将内容发送到公共房间</li><li>直接发送内容会使用chatgpt3.5</li></ol><h1 id="代码的修改">代码的修改</h1><blockquote><p>在原代码基础上添加了支持markdown语法的功能</p></blockquote><p>SendText.vue</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;div class=<span class="string">&quot;headline text--primary mb-4&quot;</span>&gt;发送文本&lt;/div&gt;</span><br><span class="line">        &lt;v-textarea</span><br><span class="line">            outlined</span><br><span class="line">            dense</span><br><span class="line">            rows=<span class="string">&quot;6&quot;</span></span><br><span class="line">            :counter=<span class="string">&quot;<span class="variable">$root</span>.config.text.limit&quot;</span></span><br><span class="line">            placeholder=<span class="string">&quot;请输入需要发送的文本&quot;</span></span><br><span class="line">            v-model=<span class="string">&quot;<span class="variable">$root</span>.send.text&quot;</span></span><br><span class="line">        &gt;&lt;/v-textarea&gt;</span><br><span class="line">        &lt;div v-html=<span class="string">&quot;renderedContent&quot;</span> class=<span class="string">&quot;rendered-markdown&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">        &lt;div class=<span class="string">&quot;text-right&quot;</span>&gt;</span><br><span class="line">            &lt;v-btn</span><br><span class="line">                color=<span class="string">&quot;primary&quot;</span></span><br><span class="line">                :block=<span class="string">&quot;<span class="variable">$vuetify</span>.breakpoint.smAndDown&quot;</span></span><br><span class="line">                :disabled=<span class="string">&quot;!<span class="variable">$root</span>.send.text || !<span class="variable">$root</span>.websocket || <span class="variable">$root</span>.send.text.length &gt; <span class="variable">$root</span>.config.text.limit&quot;</span></span><br><span class="line">                @click=<span class="string">&quot;send&quot;</span></span><br><span class="line">            &gt;发送&lt;/v-btn&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">.rendered-markdown &#123;</span><br><span class="line">    max-height: 300px; /* 设置最大高度，超过这个高度的内容将通过滚动条显示 */</span><br><span class="line">    overflow-y: auto; /* 垂直方向上，如果内容超出则显示滚动条 */</span><br><span class="line">    padding: 10px; /* 可选，为内容添加一些内边距 */</span><br><span class="line">    border: 1px solid <span class="comment">#ccc; /* 可选，为容器添加边框，使之更清晰 */</span></span><br><span class="line">    background-color: <span class="comment">#f9f9f9; /* 可选，设置背景颜色 */</span></span><br><span class="line">    margin-bottom: 10px; /* 可选，为容器添加下外边距 */</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import MarkdownIt from <span class="string">&#x27;markdown-it&#x27;</span>;</span><br><span class="line"><span class="built_in">export</span> default &#123;</span><br><span class="line">    name: <span class="string">&#x27;send-text&#x27;</span>,</span><br><span class="line">    <span class="function"><span class="title">data</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> &#123;</span><br><span class="line">            md: new MarkdownIt(),</span><br><span class="line">            renderedContent: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    watch: &#123;</span><br><span class="line">        // 当文本变化时，重新渲染 Markdown</span><br><span class="line">        <span class="string">&#x27;$root.send.text&#x27;</span>: <span class="keyword">function</span>(newVal) &#123;</span><br><span class="line">            this.renderedContent = this.md.render(newVal);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        <span class="function"><span class="title">send</span></span>() &#123;</span><br><span class="line">            this.<span class="variable">$http</span>.post(</span><br><span class="line">                <span class="string">&#x27;/text&#x27;</span>,</span><br><span class="line">                this.<span class="variable">$root</span>.send.text,</span><br><span class="line">                &#123;</span><br><span class="line">                    params: new URLSearchParams([[<span class="string">&#x27;room&#x27;</span>, this.<span class="variable">$root</span>.room]]),</span><br><span class="line">                    headers: &#123;</span><br><span class="line">                        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span>,</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">            ).<span class="keyword">then</span>(response =&gt; &#123;</span><br><span class="line">                this.<span class="variable">$toast</span>(<span class="string">&#x27;发送成功&#x27;</span>);</span><br><span class="line">                this.<span class="variable">$root</span>.send.text = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            &#125;).catch(error =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (error.response &amp;&amp; error.response.data.msg) &#123;</span><br><span class="line">                    this.<span class="variable">$toast</span>(`发送失败：<span class="variable">$&#123;error.response.data.msg&#125;</span>`);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    this.<span class="variable">$toast</span>(<span class="string">&#x27;发送失败&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>Text.vue</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;v-hover</span><br><span class="line">        v-slot:default=<span class="string">&quot;&#123; hover &#125;&quot;</span></span><br><span class="line">    &gt;</span><br><span class="line">        &lt;v-card :elevation=<span class="string">&quot;hover ? 6 : 2&quot;</span> class=<span class="string">&quot;mb-2 transition-swing&quot;</span>&gt;</span><br><span class="line">            &lt;v-card-text&gt;</span><br><span class="line">                &lt;div class=<span class="string">&quot;d-flex flex-row align-center&quot;</span>&gt;</span><br><span class="line">                    &lt;div class=<span class="string">&quot;flex-grow-1 mr-2&quot;</span> style=<span class="string">&quot;min-width: 0&quot;</span>&gt;</span><br><span class="line">                        &lt;div class=<span class="string">&quot;title text-truncate text--primary&quot;</span> @click=<span class="string">&quot;expand = !expand&quot;</span>&gt;</span><br><span class="line">                            文本消息&lt;v-icon&gt;&#123;&#123;<span class="built_in">expand</span> ? mdiChevronUp : mdiChevronDown&#125;&#125;&lt;/v-icon&gt;</span><br><span class="line">                        &lt;/div&gt;</span><br><span class="line">                        &lt;div class=<span class="string">&quot;text-truncate&quot;</span> @click=<span class="string">&quot;expand = !expand&quot;</span> v-html=<span class="string">&quot;meta.content.trim()&quot;</span> v-linkified&gt;&lt;/div&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">                    &lt;div class=<span class="string">&quot;align-self-center text-no-wrap&quot;</span>&gt;</span><br><span class="line">                        &lt;v-tooltip bottom&gt;</span><br><span class="line">                            &lt;template v-slot:activator=<span class="string">&quot;&#123; on &#125;&quot;</span>&gt;</span><br><span class="line">                                &lt;v-btn v-on=<span class="string">&quot;on&quot;</span> icon color=<span class="string">&quot;grey&quot;</span> @click=<span class="string">&quot;copyText&quot;</span>&gt;</span><br><span class="line">                                    &lt;v-icon&gt;&#123;&#123;mdiContentCopy&#125;&#125;&lt;/v-icon&gt;</span><br><span class="line">                                &lt;/v-btn&gt;</span><br><span class="line">                            &lt;/template&gt;</span><br><span class="line">                            &lt;span&gt;复制&lt;/span&gt;</span><br><span class="line">                        &lt;/v-tooltip&gt;</span><br><span class="line">                        &lt;v-tooltip bottom&gt;</span><br><span class="line">                            &lt;template v-slot:activator=<span class="string">&quot;&#123; on &#125;&quot;</span>&gt;</span><br><span class="line">                                &lt;v-btn v-on=<span class="string">&quot;on&quot;</span> icon color=<span class="string">&quot;grey&quot;</span> @click=<span class="string">&quot;deleteItem&quot;</span>&gt;</span><br><span class="line">                                    &lt;v-icon&gt;&#123;&#123;mdiClose&#125;&#125;&lt;/v-icon&gt;</span><br><span class="line">                                &lt;/v-btn&gt;</span><br><span class="line">                            &lt;/template&gt;</span><br><span class="line">                            &lt;span&gt;删除&lt;/span&gt;</span><br><span class="line">                        &lt;/v-tooltip&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;v-expand-transition&gt;</span><br><span class="line">                    &lt;div v-show=<span class="string">&quot;expand&quot;</span>&gt;</span><br><span class="line">                        &lt;v-divider class=<span class="string">&quot;my-2&quot;</span>&gt;&lt;/v-divider&gt;</span><br><span class="line">                        &lt;div ref=<span class="string">&quot;content&quot;</span> v-html=<span class="string">&quot;renderMarkdown(meta.content)&quot;</span> v-linkified&gt;&lt;/div&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &lt;/v-expand-transition&gt;</span><br><span class="line">            &lt;/v-card-text&gt;</span><br><span class="line">        &lt;/v-card&gt;</span><br><span class="line">    &lt;/v-hover&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import MarkdownIt from <span class="string">&#x27;markdown-it&#x27;</span>;</span><br><span class="line">import &#123;</span><br><span class="line">    mdiChevronUp,</span><br><span class="line">    mdiChevronDown,</span><br><span class="line">    mdiContentCopy,</span><br><span class="line">    mdiClose,</span><br><span class="line">&#125; from <span class="string">&#x27;@mdi/js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> default &#123;</span><br><span class="line">    name: <span class="string">&#x27;received-text&#x27;</span>,</span><br><span class="line">    props: &#123;</span><br><span class="line">        meta: &#123;</span><br><span class="line">            <span class="built_in">type</span>: Object,</span><br><span class="line">            <span class="function"><span class="title">default</span></span>() &#123;</span><br><span class="line">                <span class="built_in">return</span> &#123;&#125;;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">data</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> &#123;</span><br><span class="line">            <span class="built_in">expand</span>: <span class="literal">false</span>,</span><br><span class="line">            mdiChevronUp,</span><br><span class="line">            mdiChevronDown,</span><br><span class="line">            mdiContentCopy,</span><br><span class="line">            mdiClose,</span><br><span class="line">            md: new MarkdownIt(),  // Markdown 解析器实例</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        renderMarkdown(text) &#123;</span><br><span class="line">            <span class="built_in">return</span> this.md.render(text);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">copyText</span></span>() &#123;</span><br><span class="line">            <span class="built_in">let</span> el = document.createElement(<span class="string">&#x27;textarea&#x27;</span>);</span><br><span class="line">            el.value = new DOMParser().parseFromString(this.meta.content, <span class="string">&#x27;text/html&#x27;</span>).documentElement.textContent;</span><br><span class="line">            el.style.cssText = <span class="string">&#x27;top:0;left:0;position:fixed&#x27;</span>;</span><br><span class="line">            document.body.appendChild(el);</span><br><span class="line">            el.focus();</span><br><span class="line">            el.select();</span><br><span class="line">            document.execCommand(<span class="string">&#x27;copy&#x27;</span>);</span><br><span class="line">            document.body.removeChild(el);</span><br><span class="line">            this.<span class="variable">$toast</span>(<span class="string">&#x27;复制成功&#x27;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">deleteItem</span></span>() &#123;</span><br><span class="line">            this.<span class="variable">$http</span>.delete(`/revoke/<span class="variable">$&#123;this.meta.id&#125;</span>`, &#123;</span><br><span class="line">                params: new URLSearchParams([[<span class="string">&#x27;room&#x27;</span>, this.<span class="variable">$root</span>.room]]),</span><br><span class="line">            &#125;).<span class="keyword">then</span>(() =&gt; &#123;</span><br><span class="line">                this.<span class="variable">$toast</span>(<span class="string">&#x27;已删除文本消息&#x27;</span>);</span><br><span class="line">            &#125;).catch(error =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (error.response &amp;&amp; error.response.data.msg) &#123;</span><br><span class="line">                    this.<span class="variable">$toast</span>(`消息删除失败：<span class="variable">$&#123;error.response.data.msg&#125;</span>`);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    this.<span class="variable">$toast</span>(<span class="string">&#x27;消息删除失败&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;在线剪贴板-文件传输&quot;&gt;在线剪贴板|文件传输&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;项目地址：&lt;a href=&quot;https://github.com/TransparentLC/cloud-clipboard&quot;&gt;https://github.com/Trans</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>【Hysteria2】安装</title>
    <link href="https://blog.lthero.cn/2024/04/03/Hysteria2Installion/"/>
    <id>https://blog.lthero.cn/2024/04/03/Hysteria2Installion/</id>
    <published>2024-04-03T13:43:50.000Z</published>
    <updated>2024-11-29T12:51:41.077Z</updated>
    
    <content type="html"><![CDATA[<p>本文分为两大部分</p><p>1、hysteria2的安装与使用</p><p>2、自建机场（内包含另一种hysteria2的安装方法）<a href="https://blog.lthero.top/2024/11/26/BuildYourOwnProxyhub/">跳转到自建机场文章</a></p><h1 id="hysteria2安装与使用">Hysteria2安装与使用</h1><h2 id="真-一键安装">真·一键安装</h2><p>项目：<a href="https://github.com/lthero-big/Hysteria2Installer">https://github.com/lthero-big/Hysteria2Installer</a></p><p>此脚本目前仅支持使用伪装域名（自签证书）的方式安装</p><h3 id="下载脚本与安装">下载脚本与安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/lthero-big/Hysteria2Installer/main/Hy2Install.sh -O Hy2Install.sh &amp;&amp; bash Hy2Install.sh</span><br></pre></td></tr></table></figure><p>内含了</p><ol><li>最新hysteria2官方的安装脚本，来源：<a href="https://github.com/apernet/hysteria">hysteria</a></li><li>开启BBR算法的脚本，来源：<a href="https://teddysun.com/489.html">秋水逸冰</a></li></ol><p><strong>运行本脚本，你只需要</strong></p><ol><li>输入伪装域名（可以直接回车，<a href="http://xn--bing-uk1gj6rny3dxuybdeyb.com">用默认域名bing.com</a>）</li><li>输入密码（可以直接回车，自动生成密码，<strong>需要你记录下来</strong>）</li><li>输入端口（可以直接回车，用输入端口6688）</li></ol><p><strong>随后等待安装成功即可，后面的过程可以全部跳过</strong></p><hr><h2 id="相关链接">相关链接</h2><p>v2rayN 下载：<a href="https://github.com/2dust/v2rayN/releases/latest">https://github.com/2dust/v2rayN/releases/latest</a></p><p>Hysteria 2下载：<a href="https://github.com/apernet/hysteria/releases">https://github.com/apernet/hysteria/releases</a></p><p>Hysteria 2文档：<a href="https://v2.hysteria.network/zh/">https://v2.hysteria.network/zh/</a></p><p>sing-box文档：<a href="https://sing-box.sagernet.org/zh/">https://sing-box.sagernet.org/zh/</a></p><p>Android客户端（SFA）：<a href="https://install.appcenter.ms/users/nekohasekai/apps/sfa/distribution_groups/publictest">https://install.appcenter.ms/users/nekohasekai/apps/sfa/distribution_groups/publictest</a></p><p>IOS客户端（TestFlight）：<a href="https://testflight.apple.com/join/AcqO44FH">https://testflight.apple.com/join/AcqO44FH</a> （1.5.0 beta版支持Hysteria 2）</p><p>IOS客户端（AppStore）：<a href="https://apps.apple.com/us/app/sing-box/id6451272673">https://apps.apple.com/us/app/sing-box/id6451272673</a> （暂不支持Hysteria 2）</p><h2 id="1-下载安装hy2">1、下载安装hy2</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#一键安装Hysteria2</span></span><br><span class="line">bash &lt;(curl -fsSL https://get.hy2.sh/)</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成自签证书</span></span><br><span class="line">openssl req -x509 -nodes -newkey ec:&lt;(openssl ecparam -name prime256v1) -keyout /etc/hysteria/server.key -out /etc/hysteria/server.crt -subj <span class="string">&quot;/CN=bing.com&quot;</span> -days 36500 &amp;&amp; sudo <span class="built_in">chown</span> hysteria /etc/hysteria/server.key &amp;&amp; sudo <span class="built_in">chown</span> hysteria /etc/hysteria/server.crt</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="2-服务端：配置文件">2、服务端：配置文件</h2><blockquote><p>这里有两种方式</p><p>1.使用acme申请域名</p><p>2.使用自签证书</p><p>推荐用自签</p></blockquote><h3 id="acme申请域名">acme申请域名</h3><p>编辑服务器配置文件<code>vim /etc/hysteria/config.yaml</code>，填写下面的内容</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">listen:</span> <span class="string">:6688</span> <span class="comment">#监听端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用CA证书</span></span><br><span class="line"><span class="attr">acme:</span></span><br><span class="line">  <span class="attr">domains:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">xx.lthero.xx</span> <span class="comment">#你的域名，需要先解析到服务器ip</span></span><br><span class="line">  <span class="attr">email:</span> <span class="string">xxxx@gmail.com</span></span><br><span class="line"></span><br><span class="line"><span class="attr">auth:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">password</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">xxxxxx</span>   <span class="comment"># 输入密码</span></span><br><span class="line"></span><br><span class="line"><span class="attr">masquerade:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">proxy</span></span><br><span class="line">  <span class="attr">proxy:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://bing.com</span> <span class="comment">#伪装网址</span></span><br><span class="line">    <span class="attr">rewriteHost:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="使用自签证书">使用自签证书</h3><p>编辑服务器配置文件<code>vim /etc/hysteria/config.yaml</code>，填写下面的内容</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">listen:</span> <span class="string">:6688</span> <span class="comment">#监听端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用自签证书</span></span><br><span class="line"><span class="attr">tls:</span></span><br><span class="line">  <span class="attr">cert:</span> <span class="string">/etc/hysteria/server.crt</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">/etc/hysteria/server.key</span></span><br><span class="line"></span><br><span class="line"><span class="attr">auth:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">password</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">xxxxxx</span>   <span class="comment"># 输入密码</span></span><br><span class="line"></span><br><span class="line"><span class="attr">masquerade:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">proxy</span></span><br><span class="line">  <span class="attr">proxy:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://bing.com</span> <span class="comment">#伪装网址</span></span><br><span class="line">    <span class="attr">rewriteHost:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="3-服务端：启动hysteria2">3、服务端：启动Hysteria2</h2><p>随后启动hy即可，另外<strong>首次需要设置开机自启</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动Hysteria2</span></span><br><span class="line">systemctl start hysteria-server.service</span><br><span class="line"><span class="comment">#设置开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> hysteria-server.service</span><br><span class="line"><span class="comment">#查看Hysteria2状态</span></span><br><span class="line">systemctl status hysteria-server.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Hysteria2</span></span><br><span class="line">systemctl restart hysteria-server.service</span><br><span class="line"><span class="comment">#停止Hysteria2</span></span><br><span class="line">systemctl stop hysteria-server.service</span><br><span class="line"><span class="comment">#停止开机自启Hysteria2</span></span><br><span class="line">systemctl <span class="built_in">disable</span> hysteria-server.service</span><br><span class="line"><span class="comment">#查看日志</span></span><br><span class="line">journalctl -u hysteria-server.service</span><br></pre></td></tr></table></figure><h2 id="4-客户端：pc配置文件">4、客户端：PC配置文件</h2><p>可以导入到v2ray中</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server: xx.xx.xx.xx:6688 <span class="comment"># 服务器ip和端口</span></span><br><span class="line">auth: xxxxxx  <span class="comment"># 输入密码</span></span><br><span class="line"></span><br><span class="line">bandwidth:</span><br><span class="line">  up: 100 mbps  </span><br><span class="line">  down: 200 mbps</span><br><span class="line">  </span><br><span class="line">tls:</span><br><span class="line">  sni: xx.lthero.xx <span class="comment">#你的域名，需要先解析到服务器ip，#使用自签时需要填写#伪装网址</span></span><br><span class="line">  insecure: <span class="literal">false</span> <span class="comment">#使用自签时需要改成true</span></span><br><span class="line"></span><br><span class="line">socks5:</span><br><span class="line">  listen: 127.0.0.1:1080</span><br><span class="line">http:</span><br><span class="line">  listen: 127.0.0.1:8080</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="5-客户端：sing-box配置文件-android-ios">5、客户端：sing-box配置文件(Android/IOS)</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cf&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://1.1.1.1/dns-query&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;223.5.5.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;detour&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;block&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rcode://success&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;geosite&quot;</span><span class="punctuation">:</span> <span class="string">&quot;category-ads-all&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;block&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;disable_cache&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;outbound&quot;</span><span class="punctuation">:</span> <span class="string">&quot;any&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;geosite&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;local&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ipv4_only&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tun&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;inet4_address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.19.0.1/30&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;auto_route&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;strict_route&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sniff&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hysteria2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;proxy&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ip&quot;</span><span class="punctuation">,</span> #填写ip</span><br><span class="line">      <span class="attr">&quot;server_port&quot;</span><span class="punctuation">:</span> <span class="number">443</span><span class="punctuation">,</span>#填写端口</span><br><span class="line">      <span class="attr">&quot;up_mbps&quot;</span><span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span>#填写上行</span><br><span class="line">      <span class="attr">&quot;down_mbps&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span> #填写下行</span><br><span class="line">      <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span><span class="punctuation">,</span>#填写密码</span><br><span class="line">      <span class="attr">&quot;tls&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;server_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xx.lthero.xx&quot;</span><span class="punctuation">,</span> #填写自己的域名或伪装网址</span><br><span class="line">        <span class="attr">&quot;insecure&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span> #使用自签时需要改成<span class="keyword">true</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;block&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;block&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dns&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dns-out&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;route&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dns&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;outbound&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dns-out&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;geosite&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;geoip&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;private&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;cn&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;outbound&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;geosite&quot;</span><span class="punctuation">:</span> <span class="string">&quot;category-ads-all&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;outbound&quot;</span><span class="punctuation">:</span> <span class="string">&quot;block&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;auto_detect_interface&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h1 id="bbr加速脚本">BBR加速脚本</h1><blockquote><p>来源：<a href="https://teddysun.com/489.html">秋水逸冰</a></p></blockquote><h2 id="使用方法">使用方法</h2><p>使用root用户登录，运行以下命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate -O /opt/bbr.sh https://github.com/teddysun/across/raw/master/bbr.sh</span><br><span class="line"><span class="built_in">chmod</span> 755 /opt/bbr.sh</span><br><span class="line">/opt/bbr.sh</span><br></pre></td></tr></table></figure><p>安装完成后，脚本会提示需要重启 VPS，输入 y 并回车后重启。【部分系统已经不需要验证】</p><p>重启完成后，进入 VPS，<strong>验证一下</strong>是否成功安装最新内核并开启 TCP BBR，输入以下检查：</p><p>No.1</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -r</span><br></pre></td></tr></table></figure><p>查看内核版本，显示为新版内核就表示 OK 了。</p><p>No.2</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl net.ipv4.tcp_available_congestion_control</span><br></pre></td></tr></table></figure><p>返回值一般为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_available_congestion_control = bbr cubic reno</span><br></pre></td></tr></table></figure><p>或者：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_available_congestion_control = reno cubic bbr</span><br></pre></td></tr></table></figure><p>No.3</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl net.ipv4.tcp_congestion_control</span><br></pre></td></tr></table></figure><p>返回值一般为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_congestion_control = bbr</span><br></pre></td></tr></table></figure><p>No.4</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl net.core.default_qdisc</span><br></pre></td></tr></table></figure><p>返回值一般为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.core.default_qdisc = fq</span><br></pre></td></tr></table></figure><p>No.5</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep bbr</span><br></pre></td></tr></table></figure><p>返回值有 tcp_bbr 模块即说明 bbr 已启动。比如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp_bbr                20480  3</span><br></pre></td></tr></table></figure><p>注意：并不是所有的 VPS 都会有此返回值，若没有也属正常。</p><h1 id="自建机场">自建机场</h1><blockquote><p>先用两句话说明机场的逻辑</p><p>1、用<code>Xboard</code>创建机场的前端，<strong>在一台服务器A上部署</strong>即可，用户管理、流量管理等功能全在这上面</p><p>2、使用<code>V2bX</code>创建机场的后端（运行了各种代理服务，如ss, v2ray, hysteria2等）。V2bX会获取节点信息、用户鉴权信息与上报用户流量到服务器A，<strong>V2bX部署在服务器A,B,C,D等</strong></p></blockquote><h2 id="xboard部署教程">Xboard部署教程</h2><h3 id="安装">安装</h3><p>下面是使用Docker-Compose进行部署</p><blockquote><p><strong>仅在服务器A上部署</strong></p><p>Xboard更多安装方式参考：<a href="https://github.com/cedar2025/Xboard">https://github.com/cedar2025/Xboard</a></p></blockquote><p>安装docker</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://get.docker.com | bash</span><br></pre></td></tr></table></figure><p>获取Docker compose 文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone -b  docker-compose --depth 1 https://github.com/cedar2025/Xboard</span><br><span class="line">cd Xboard</span><br></pre></td></tr></table></figure><p>执行数据库安装命令</p><blockquote><p>自动选择 <strong>启用sqlite</strong> 和 <strong>Docker内置的Redis</strong></p><p>修改下面的your_admin_email@example.com 为自己的管理员账号</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose run -it --rm -e enable_sqlite=true -e enable_redis=true -e admin_account=your_admin_email@example.com xboard php artisan xboard:install</span><br></pre></td></tr></table></figure><blockquote><p>手动根据自己的需要在运行时选择sqlite和redis，以及手动输入管理员账号</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose run -it --rm xboard php artisan xboard:install</span><br></pre></td></tr></table></figure><blockquote><p>执行这条命令之后，会返回你的后台地址(asdfasqeb)和管理员账号密码（<strong>你需要记录下来后台地址</strong>）！<br>你需要执行下面的 <strong>启动xborad</strong> 步骤之后才能访问后台</p></blockquote><p>启动Xboard</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure><blockquote><p>安装完成之后即可访问你的站点</p></blockquote><p>访问站点</p><blockquote><p>启动之后网站端口默认为7001, 你可以配置nginx反向代理使用80端口</p></blockquote><p>网站地址: <a href="http://xn--IP-0p3cm89l:7001/">http://你的IP:7001/</a></p><p>后台地址：<a href="http://xn--IP-0p3cm89l:7001/asdfasqeb">http://你的IP:7001/asdfasqeb</a></p><p>在此你已经成功部署了, 你可以访问网址体验Xboard的完整功能，</p><blockquote><p>如果你需要使用mysql，请自行安装Mysql后重新部署</p></blockquote><h3 id="更新"><strong>更新</strong></h3><p>修改版本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd Xboard</span><br><span class="line">vi docker-compose.yaml</span><br></pre></td></tr></table></figure><blockquote><p>修改docker-compose.yaml 当中image后面的版本号为你需要的版本<br>如果为版本为latest 则可以忽略这一步，直接进行第二步</p></blockquote><p>更新数据库（可以执行多次都是安全的）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker compose pull</span><br><span class="line">docker compose down</span><br><span class="line">docker compose run -it --rm xboard php artisan xboard:update</span><br><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure><blockquote><p>即可更新成功</p></blockquote><h3 id="回滚"><strong>回滚</strong></h3><blockquote><p>此回滚不回滚数据库，是否回滚数据库请查看相关文档</p></blockquote><p>回退版本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi docker-compose.yaml</span><br></pre></td></tr></table></figure><blockquote><p>修改docker-compose.yaml 当中image后面的版本号为更新前的版本号</p></blockquote><p>启动</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure><h3 id="注意">注意</h3><p>启用webman后做的任何代码修改都需要重启生效</p><h2 id="xboard添加节点">Xboard添加节点</h2><blockquote><p>在Xboard的管理页面添加节点，在添加节点前，先添加一个订阅服务（金额流量等信息可以随便填写）</p></blockquote><p>这里以配置hysteria2为例，并且是使用自签证书的形式，<a href="http://xn--bing-494f58bbyus1hf9y35i7i9b1o8e.com">所以下面的域名是bing.com</a></p><p>在Xboard里先一个节点</p><ul><li><p>节点名称 ：任意</p></li><li><p>倍率：任意</p></li><li><p>节点地址：<strong>将运行hysteria的服务器</strong>（可以是服务器A,B,C,D等），写公网<strong>IP地址</strong></p></li><li><p>连接端口：选择服务器A（运行了board）上<strong>空闲的端口</strong></p></li><li><p>服务端口：将运行hysteria2的服务器（如B,C,D）中hysteria2进程的端口</p><ul><li><strong>连接端口和服务端口要写一样的，否则无法正常使用</strong>，理论上应该是可以不同的，但可能是bug</li></ul></li><li><p>允许不安全：是</p></li><li><p>协议版本：v2</p></li><li><p>开启obfs：否</p></li><li><p>sni：<a href="http://bing.com">bing.com</a></p><ul><li>如果使用公认证书，请输入指向这台服务器的域名（A,B,C,D等运行hy协议的服务器）</li></ul></li><li><p>上行带宽：100</p></li><li><p>下行带宽：200</p></li><li><p>父节点：无</p></li></ul><p><img src="https://cdn.lthero.cn/post_images/course/ML/image-20241125235329948.png" alt="image-20241125235329948"></p><p>至此，已经完成了前端的工作，后面是将添加的节点进行实际运行起来，<strong>节点的部署</strong>可以运行在不同于服务器A(运行了Xboard)的机器B,C,D上</p><blockquote><p>强烈推荐在部署节点之前，<strong>先配置好https访问</strong>，后面两步是配置https的过程</p></blockquote><ol><li>先配置http访问</li><li>再配置https访问，不要跳过</li></ol><h2 id="使用http访问">使用HTTP访问</h2><p>要将运行在Docker容器中的服务通过域名访问，并使用Nginx作为反向代理来转发到宿主机的7001端口，你需要完成几个步骤。这包括设置DNS记录、配置Nginx以及确保网络安全。下面是具体步骤：</p><h3 id="步骤-1-设置dns记录">步骤 1: 设置DNS记录</h3><p>确保你的域名 <code>board.lthero.top</code> 的DNS记录指向托管Nginx的服务器的IP地址。这通常在你的域名注册商处进行设置：</p><ul><li><strong>A记录</strong>：将域名指向IPv4地址。</li><li><strong>AAAA记录</strong>：将域名指向IPv6地址（如果适用）。</li></ul><h3 id="步骤-2-安装并启动nginx">步骤 2: 安装并启动Nginx</h3><p>步骤 1: 更新软件包列表</p><p>打开终端，首先使用<code>apt</code>命令更新你的包列表，以确保你安装的是最新版本的Nginx。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure><p>步骤 2: 安装Nginx</p><p>使用<code>apt</code>安装Nginx。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure><h3 id="步骤-3-配置nginx">步骤 3: 配置Nginx</h3><p>你需要在Nginx中创建一个新的服务器块（server block），或者在已有的默认配置中修改，以设置反向代理。以下是一个基本的Nginx配置示例，将会把所有到 <code>board.lthero.top</code> 的请求转发到本地的7001端口：</p><ol><li><p>打开或创建一个新的Nginx配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-available/board.lthero.top</span><br></pre></td></tr></table></figure></li><li><p>添加以下配置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> board.lthero.top;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:7001;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&#x27;upgrade&#x27;</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个配置做了以下几点：</p><ul><li><code>listen 80;</code> 告诉Nginx监听80端口（HTTP标准端口）。</li><li><code>server_name board.lthero.top;</code> 设置这个块应当响应的域名。</li><li><code>proxy_pass http://localhost:7001;</code> 指定所有传入的请求转发到本地的7001端口。</li><li><code>proxy_set_header</code> 指令将重要的HTTP头信息转发给后端应用。</li></ul></li><li><p>启用配置文件通过创建一个符号链接：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -s /etc/nginx/sites-available/board.lthero.top /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure></li><li><p>检查Nginx配置文件是否有语法错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br></pre></td></tr></table></figure></li><li><p>如果没有错误，重启Nginx以应用配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure></li></ol><h3 id="步骤-4-调整防火墙规则">步骤 4: 调整防火墙规则</h3><p>确保你的服务器的防火墙规则允许HTTP（端口80）和HTTPS（端口443，如果你使用SSL）的流量。如果你正在使用<code>ufw</code>，可以使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow <span class="string">&#x27;Nginx Full&#x27;</span></span><br><span class="line">sudo ufw reload</span><br></pre></td></tr></table></figure><h3 id="步骤-5-测试配置">步骤 5: 测试配置</h3><p>在浏览器中输入 <code>http://board.lthero.top</code> 或使用命令行工具如 <code>curl</code> 来测试你的配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://board.lthero.top</span><br></pre></td></tr></table></figure><p>你应该能看到从Docker容器中运行的服务响应的内容。</p><p>这样，你就配置好了Nginx作为反向代理，将域名 <code>board.lthero.top</code> 的流量转发到宿主机的7001端口上的服务。如果你希望使用HTTPS，你还需要设置SSL证书，可以考虑使用Let’s Encrypt免费证书并配置HTTPS。</p><h2 id="使用https访问">使用HTTPS访问</h2><p>要让你的域名 <code>board.lthero.top</code> 使用 HTTPS，你需要获取 SSL/TLS 证书，并配置 Nginx 以使用这些证书来加密网页内容。以下是详细的步骤，包括如何使用 Let’s Encrypt 提供的免费证书自动化这个过程。</p><h3 id="步骤-1-安装-certbot">步骤 1: 安装 Certbot</h3><p>Certbot 是一个自动获取并安装 Let’s Encrypt 证书的客户端。在 Ubuntu 上安装 Certbot 及其 Nginx 插件非常简单：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install certbot python3-certbot-nginx -y</span><br></pre></td></tr></table></figure><h3 id="步骤-2-获取和安装证书">步骤 2: 获取和安装证书</h3><p>使用 Certbot 获取并为你的域名安装证书：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot --nginx -d board.lthero.top</span><br></pre></td></tr></table></figure><p>此命令会自动为指定的域名 <code>board.lthero.top</code> 配置 SSL 证书，并更新 Nginx 配置以使用这些证书。</p><p>Certbot 会询问你一些问题，比如电子邮件地址（用于紧急联系和证书续订提醒）</p><p>以及<strong>是否重定向所有 HTTP 请求到 HTTPS（强烈建议启用）</strong>，如果启用，它用自动修改board.lthero.top的nginx配置文件，</p><p>生成的证书位置<code>/etc/letsencrypt/live/</code></p><h3 id="步骤-3-更新-nginx-配置">步骤 3: 更新 Nginx 配置</h3><p>如果你想手动编辑 Nginx 配置文件，可以按以下方式配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-available/board.lthero.top</span><br></pre></td></tr></table></figure><ol><li>如果你的配置文件里已经出现“# managed by Certbot”等内容，说明Certbot已经将配置文件修改好了，直接重启nginx即可</li><li>记得将下面所有的board.lthero.top换成你的域名</li><li>这里的7001端口是Xboard运行端口</li></ol><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> board.lthero.top;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:7001;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&#x27;upgrade&#x27;</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$http_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/board.lthero.top/fullchain.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/board.lthero.top/privkey.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">include</span> /etc/letsencrypt/options-ssl-nginx.conf; <span class="comment"># managed by Certbot</span></span><br><span class="line">    <span class="attribute">ssl_dhparam</span> /etc/letsencrypt/ssl-dhparams.pem; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$host</span> = board.lthero.top) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> board.lthero.top;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">404</span>; <span class="comment"># managed by Certbot</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="步骤-4-重新加载-nginx">步骤 4: 重新加载 Nginx</h3><p>更改配置后，需要重新加载 Nginx 以应用新的配置：</p><blockquote><p>检查配置文件是否有语法错误，如果有warn!直接看“遇到的问题”部分，重新加载配置是不一定能work的</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t  <span class="comment"># 检查配置文件是否有语法错误</span></span><br><span class="line">sudo systemctl reload nginx  <span class="comment"># 重新加载配置</span></span><br><span class="line"><span class="comment"># 如果重新加载配置后无效，可以尝试重启nginx</span></span><br><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure><h3 id="步骤-5-验证-https">步骤 5: 验证 HTTPS</h3><p>在浏览器中访问 <code>https://board.lthero.top</code> 来检查是否配置成功。你应该能够看到一个安全锁标志，表明连接是通过 HTTPS 加密的。</p><h3 id="步骤-6-自动续订证书">步骤 6: 自动续订证书</h3><p>Let’s Encrypt 的证书有效期为90天，因此建议设置自动续订：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo certbot renew</span><br></pre></td></tr></table></figure><p>这个命令会测试证书续订过程。如果这个测试成功，添加定时任务<code>crontab</code>：</p><p><code>crontab -e</code>再填写下面内容，表示每月第一天会自动执行</p><p>通过<code>which certbot</code>查看具体程序位置<code>/usr/local/bin/certbot</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1 * * /usr/local/bin/certbot renew --deploy-hook <span class="string">&quot;nginx -s reload&quot;</span></span><br></pre></td></tr></table></figure><p>续签的证书位置<code>/etc/letsencrypt/renewal</code></p><p>通过以上步骤，你的站点 <code>board.lthero.top</code> 现在应该能够安全地使用 HTTPS 进行通信了。</p><p>如果要换crontab编辑器，运行下面的命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select-editor</span><br></pre></td></tr></table></figure><p>至此，已经配置好https访问，下面开始<strong>部署代理服务</strong></p><hr><h2 id="v2bx部署代理服务">V2bX部署代理服务</h2><blockquote><p>在需要**运行节点的服务器（A,B,C,D等）**上安装V2bX，从而运行hysteria2, v2ray, vless, ss等协议</p><p>在V2bX上运行的代理协议可对接到Xboard上，会将用户使用情况上传到Xboard上并统计</p><p>视频参考：<a href="https://youtu.be/Fwn0nFbB0zY?t=720">https://youtu.be/Fwn0nFbB0zY?t=720</a></p></blockquote><h3 id="v2bx安装">V2bX安装</h3><p>执行下面的命令，安装V2bX</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -N https://raw.githubusercontent.com/wyx2685/V2bX-script/master/install.sh &amp;&amp; bash install.sh</span><br></pre></td></tr></table></figure><p>配置文件路径：<code>/etc/V2bX</code> 配置文件详见：<a href="https://v2bx.v-50.me/v2bx/v2bx-pei-zhi-wen-jian-shuo-ming/config">配置文件说明</a></p><p>下面是在<strong>服务器B</strong>上运行hysteria2协议的配置过程</p><ul><li><p>输入机场网址与API Key</p><ul><li>机场网址就是域名https://board.lthero.top（不要带最后的斜杠’/’)，而API key在Xboard的管理网页中，找到“系统配置”-&gt;“节点”-&gt;“通讯密钥”</li><li>原理是V2bX拿着密钥，到board.lthero.top上面获取你配置的节点的信息；根据这些节点信息，V2bX在服务器(A,B,C,D)上运行服务（如hysteria2协议，Vless协议等）</li></ul></li><li><p>选择核心：<strong>singbox</strong> 对应的序号</p></li><li><p>选择协议：<strong>hysteria2</strong> 对应的序号</p></li><li><p>证书模式：<strong>self模式</strong> 对应的序号</p><ul><li>如果使用公认证书，请使用<strong>http模式</strong>，你需要解析一个域名到这个<strong>服务器B的节点服务</strong>，如：hy-jp-b.lthero.top</li><li>如果你仍然使用<strong>服务器A</strong>运行节点，请不要使用board.lthero.top，请重新配置一条域名解析到<strong>节点服务</strong>,如：，如：hy-jp-a.lthero.top</li></ul></li><li><p>输入节点证书域名：<strong><a href="http://bing.com">bing.com</a></strong></p><ul><li>如果使用公认证书，请输入指向这台VPS的域名</li></ul></li><li><p>输入n退出（除非想添加其它协议）</p></li></ul><p><img src="https://cdn.lthero.cn/post_images/course/ML/image-20241125235810854.png" alt="image-20241125235810854"></p><p>随后，输入 <code>V2bX</code> 查看V2bX的配置或修改配置文件，<strong>每次修改配置文件后V2bX会自动重启</strong></p><p>这里吐槽一句啊，它只能初始化的时候使用交互方式进行文件配置，后续只能手动修改配置文件，对新手不友好。</p><p>如果想重新使用交互方式，只能将V2bX卸载后重装。</p><h3 id="hysteria2自签证书的配置文件">hysteria2自签证书的配置文件</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Output&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Cores&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sing&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Timestamp&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;NTP&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Enable&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time.apple.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ServerPort&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;OriginalPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/V2bX/sing_origin.json&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Core&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sing&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ApiHost&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://xxx.lthero.top&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ApiKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;NodeID&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;NodeType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hysteria2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Timeout&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ListenIP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;::&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;SendIP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;DeviceOnlineMinTraffic&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;TCPFastOpen&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;SniffEnabled&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;CertConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;CertMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;self&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;RejectUnknownSni&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;CertDomain&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bing.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;CertFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/V2bX/fullchain.cer&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;KeyFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/V2bX/cert.key&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;Email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v2bx@github.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;Provider&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cloudflare&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;DNSEnv&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;EnvName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;env1&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="hysteria2使用证书">hysteria2使用证书</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;Nodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Core&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sing&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ApiHost&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://board.lthero.top&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ApiKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;NodeID&quot;</span><span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;NodeType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hysteria2&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Timeout&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ListenIP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;::&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;SendIP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;DeviceOnlineMinTraffic&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;TCPFastOpen&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;SniffEnabled&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;CertConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;CertMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;RejectUnknownSni&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">                <span class="comment">//唯一的区别是，这里写解析到节点服务的域名</span></span><br><span class="line">                <span class="attr">&quot;CertDomain&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ak-jp.lthero.top&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;CertFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/V2bX/fullchain.cer&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;KeyFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/V2bX/cert.key&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;Email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v2bx@github.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;Provider&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cloudflare&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;DNSEnv&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;EnvName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;env1&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><hr><h2 id="其它对接xboard的工具">其它对接Xboard的工具</h2><p>除了V2bX，还有个对接Xboard的工具：</p><p><a href="https://github.com/FireinRainLab/hysteria-v2board">https://github.com/FireinRainLab/hysteria-v2board</a></p><p><a href="https://github.com/cedar2025/hysteria">https://github.com/cedar2025/hysteria</a></p><p>这工具是将hysteria2打包到docker中，并且将用户使用数据对接到Xboard/V2board</p><h1 id="蒸蒸日上的工具">蒸蒸日上的工具</h1><h2 id="主机全方面测试">主机全方面测试</h2><blockquote><p>包含主机cpu性能、磁盘测试、流媒体解锁测试、速度及延迟测试等</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://github.com/spiritLHLS/ecs/raw/main/ecs.sh -o ecs.sh &amp;&amp; <span class="built_in">chmod</span> +x ecs.sh &amp;&amp; bash ecs.sh</span><br></pre></td></tr></table></figure><p>工具来源：<a href="https://digvps.com/tools/ecs">https://digvps.com/tools/ecs</a></p><h2 id="流媒体解锁检测">流媒体解锁检测</h2><p>RegionRestrictionCheck 检测脚本检测项目比较全面，且支持Docker运行，杜绝污染VPS服务器，检测流媒体除了主流的Netflix、Disney+、YouTube Premium，还可以支持检测Dazn、Viu TV、4GTV和KKTV等比较冷门的流媒体服务。</p><blockquote><p>支持OS/Platform：CentOS 6+, Ubuntu 14.04+, Debian 8+, MacOS, Android with Termux</p></blockquote><h3 id="使用方法">使用方法</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L -s check.unlock.media)</span><br></pre></td></tr></table></figure><p>只检测IPv4结果:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L -s check.unlock.media) -M 4</span><br></pre></td></tr></table></figure><p>只检测IPv6结果：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L -s check.unlock.media) -M 6</span><br></pre></td></tr></table></figure><h2 id="部分测试结果">部分测试结果</h2><h3 id="do">DO</h3><p>美国SF-2c2g</p><p><a href="https://paste.spiritlhl.net/code/K1XMh0.txt">https://paste.spiritlhl.net/code/K1XMh0.txt</a></p><h3 id="racknerd">RackNerd</h3><p>美国LA-1c2g</p><p><a href="https://paste.spiritlhl.net/code/ECrxxe.txt">https://paste.spiritlhl.net/code/ECrxxe.txt</a></p><h3 id="akile">Akile</h3><p>美国LA-1c1g</p><p><a href="https://paste.spiritlhl.net/code/GWNS6v.txt">https://paste.spiritlhl.net/code/GWNS6v.txt</a></p><h3 id="vkvm">vkvm</h3><p>美国LA-2c4g</p><p><a href="https://paste.spiritlhl.net/u/9taqwb.txt">https://paste.spiritlhl.net/u/9taqwb.txt</a></p><h1 id="遇到的问题">遇到的问题</h1><h2 id="用户订阅链接无输出">用户订阅链接无输出</h2><p>如果所有节点都是hysteria2协议，会出现订阅链接输出是空白；此时直接在pc端导入到clash是正常的</p><p>尝试添加如vless协议的节点，但在安卓、苹果端仍然无法直接导入hysteria2协议</p><h2 id="数据迁移">数据迁移</h2><p>数据库位置：/root/Xboard/.docker/.data/database.sqlite</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;本文分为两大部分&lt;/p&gt;
&lt;p&gt;1、hysteria2的安装与使用&lt;/p&gt;
&lt;p&gt;2、自建机场（内包含另一种hysteria2的安装方法）&lt;a href=&quot;https://blog.lthero.top/2024/11/26/BuildYourOwnProxyhub/&quot;&gt;跳</summary>
      
    
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/tags/%E6%8A%98%E8%85%BE/"/>
    
    <category term="代理" scheme="https://blog.lthero.cn/tags/%E4%BB%A3%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>VPS测试工具</title>
    <link href="https://blog.lthero.cn/2024/04/03/RegionRestrictionCheck/"/>
    <id>https://blog.lthero.cn/2024/04/03/RegionRestrictionCheck/</id>
    <published>2024-04-03T13:29:17.000Z</published>
    <updated>2024-11-24T15:41:26.547Z</updated>
    
    <content type="html"><![CDATA[<h1 id="最强主机评测">最强主机评测</h1><p><a href="https://digvps.com/review">https://digvps.com/review</a></p><p>几乎包含了市面上大中小型主机提供商（不含AWS，Google等）</p><h1 id="主机全方面测试">主机全方面测试</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://github.com/spiritLHLS/ecs/raw/main/ecs.sh -o ecs.sh &amp;&amp; chmod +x ecs.sh &amp;&amp; bash ecs.sh</span><br></pre></td></tr></table></figure><p>工具来源：<a href="https://digvps.com/tools/ecs">https://digvps.com/tools/ecs</a></p><h1 id="流媒体解锁检测">流媒体解锁检测</h1><h2 id="脚本一：regionrestrictioncheck">脚本一：RegionRestrictionCheck</h2><p>RegionRestrictionCheck 检测脚本检测项目比较全面，且支持Docker运行，杜绝污染VPS服务器，检测流媒体除了主流的Netflix、Disney+、YouTube Premium，还可以支持检测Dazn、Viu TV、4GTV和KKTV等比较冷门的流媒体服务。</p><blockquote><p>支持OS/Platform：CentOS 6+, Ubuntu 14.04+, Debian 8+, MacOS, Android with Termux</p></blockquote><h3 id="使用方法">使用方法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L -s check.unlock.media)</span><br><span class="line"></span><br><span class="line">bash &lt;(curl -L -s check.unlock.media)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>只检测IPv4结果:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L -s check.unlock.media) -M 4</span><br><span class="line"></span><br><span class="line">bash &lt;(curl -L -s check.unlock.media) -M 4</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>只检测IPv6结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L -s check.unlock.media) -M 6</span><br><span class="line"></span><br><span class="line">bash &lt;(curl -L -s check.unlock.media) -M 6</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>指定检测的网卡名称：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L -s check.unlock.media) -I eth0</span><br><span class="line"></span><br><span class="line">bash &lt;(curl -L -s check.unlock.media) -I eth0</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>选择脚本语言为英文：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -L -s check.unlock.media) -E</span><br><span class="line"></span><br><span class="line">bash &lt;(curl -L -s check.unlock.media) -E</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>或者直接运行以下Docker命令 (兼容ARM架构)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -ti --net=host lmc999/regioncheck &amp;&amp; docker rmi lmc999/regioncheck</span><br><span class="line"></span><br><span class="line">docker run --rm -ti --net=host lmc999/regioncheck &amp;&amp; docker rmi lmc999/regioncheck</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="例子：">例子：</h3><p><img src="https://cdn.lthero.cn/post_images/course/ML/20221113-001.png.webp" alt="RegionRestrictionCheck 脚本测试结果"></p><h2 id="脚本二：mediaunlocktest">脚本二：MediaUnlockTest</h2><p>MediaUnlockTest 检测与 RegionRestrictionCheck 不一样，MediaUnlockTest 并非bash脚本，而是使用golang，检测项目与 RegionRestrictionCheck 差不多。</p><h3 id="使用方法">使用方法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -Ls unlock.moe)</span><br><span class="line"></span><br><span class="line">bash &lt;(curl -Ls unlock.moe)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>只检测IPv4结果:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -Ls unlock.moe) -m 4</span><br><span class="line"></span><br><span class="line">bash &lt;(curl -Ls unlock.moe) -m 4</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>只检测IPv6结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -Ls unlock.moe) -m 6</span><br><span class="line"></span><br><span class="line">bash &lt;(curl -Ls unlock.moe) -m 6</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="例子：">例子：</h3><p><img src="https://cdn.lthero.cn/post_images/course/ML/20221113-002.png.webp" alt="MediaUnlockTest 脚本测试结果"></p><h2 id="geosite媒体">Geosite媒体</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">geosite:apple</span><br><span class="line">geosite:bahamut</span><br><span class="line">geosite:hulu</span><br><span class="line">geosite:hbo</span><br><span class="line">geosite:disney</span><br><span class="line">geosite:bbc</span><br><span class="line">geosite:4chan</span><br><span class="line">geosite:fox</span><br><span class="line">geosite:abema</span><br><span class="line">geosite:dmm</span><br><span class="line">geosite:niconico</span><br><span class="line">geosite:pixiv</span><br><span class="line">geosite:bilibili</span><br><span class="line">geosite:viu</span><br><span class="line">domain:apple.com</span><br><span class="line">domain:paypal.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">geoip:paypal</span><br><span class="line">geoip:google</span><br></pre></td></tr></table></figure><h1 id="测试结果">测试结果</h1><h3 id="do">DO</h3><p>2c2g</p><p><a href="https://paste.spiritlhl.net/code/K1XMh0.txt">https://paste.spiritlhl.net/code/K1XMh0.txt</a></p><h3 id="racknerd">RackNerd</h3><p>1c2g</p><p><a href="https://paste.spiritlhl.net/code/ECrxxe.txt">https://paste.spiritlhl.net/code/ECrxxe.txt</a></p><h3 id="akile">Akile</h3><p>1c1g</p><p><a href="https://paste.spiritlhl.net/code/GWNS6v.txt">https://paste.spiritlhl.net/code/GWNS6v.txt</a></p><h3 id="vkvm">vkvm</h3><p>2c4g</p><p><a href="https://paste.spiritlhl.net/u/9taqwb.txt">https://paste.spiritlhl.net/u/9taqwb.txt</a></p><h1 id="其它工具">其它工具</h1><h2 id="服务器测速">服务器测速</h2><p>项目地址：<a href="https://github.com/ztelliot/taierspeed-cli/releases">https://github.com/ztelliot/taierspeed-cli/releases</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/ztelliot/taierspeed-cli/releases/download/v1.7.0/taierspeed-cli_1.7.0_linux_amd64</span><br><span class="line"><span class="built_in">mv</span> taierspeed-cli_1.7.0_linux_amd64 taierspeed-cli</span><br><span class="line"><span class="comment"># 仅检测ipv4</span></span><br><span class="line">taierspeed-cli --ipv4</span><br><span class="line"><span class="comment"># 检测ipv4和ipv6</span></span><br><span class="line">taierspeed-cli</span><br></pre></td></tr></table></figure><h2 id="ip-体检">IP 体检</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash &lt;(curl -Ls IP.Check.Place)</span><br></pre></td></tr></table></figure><p><strong>执行演示：</strong></p><p><img src="https://bigdata.icu/ip-desi-sj.jpg" alt="img"></p><h2 id="路由追踪">路由追踪</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl nxtrace.org/nt |bash</span><br></pre></td></tr></table></figure><h2 id="dd-磁盘读写测试">DD 磁盘读写测试</h2><p>注意</p><p>目前你所接触到综合测试脚本，磁盘读写基本都是娱乐性的。如果确实想好好的测试磁盘的 IO 性能，可以使用我写的 <a href="https://github.com/bihell/fio">FIO</a> 脚本。<br>不过话说回来，小鸡测试 IO 多数时候也只是顺带而已，所以我们直接用 DD 吧，不依赖任何脚本。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 生成 5G 文件，顺序</span><br><span class="line">dd if=/dev/zero of=5GB_file bs=1M count=5120</span><br><span class="line"></span><br><span class="line"># 生成 5G 文件，随机</span><br><span class="line">dd if=/dev/urandom of=5GB_file bs=1M count=5120</span><br></pre></td></tr></table></figure><h2 id="单线程下载测试">单线程下载测试</h2><p>注意</p><p>既然上面生成了文件，那我们就用现代系统都带的 Python3 开个HTTP 服务直接下载他们测试速度。</p><p>部分操作系统或者浏览器会针对同内容文件做下载优化（例如上面顺序生成的文件其实内容是一样的），如果你的下载数据远超预计，那么考虑用随机生成的文件下载吧！</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 启动简易 http 服务</span><br><span class="line">python3 -m http.server</span><br><span class="line"></span><br><span class="line"># 客户端</span><br><span class="line"># 直接用浏览器下载或其他工具下载</span><br><span class="line">wget http://你服务器的IP:8000/5GB_file</span><br></pre></td></tr></table></figure><h2 id="融合怪">融合怪</h2><blockquote><p>如果<strong>只要测试 IP 体检</strong>，运行脚本之后<strong>选4再选2</strong>。运行完整脚本会<strong>消耗流量</strong>，请注意退款政策，别到时候流量超了<strong>无法退款</strong>。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 使用命令</span><br><span class="line">curl -L https://gitlab.com/spiritysdx/za/-/raw/main/ecs.sh -o ecs.sh &amp;&amp; chmod +x ecs.sh &amp;&amp; bash ecs.sh</span><br></pre></td></tr></table></figure><p><strong>执行演示：</strong></p><p><img src="https://bigdata.icu/ip-V2-TWLite-One.jpg" alt="img"></p><h2 id="查看-kvm-服务器内存是否超售">查看 KVM 服务器内存是否超售</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep virtio_balloon</span><br></pre></td></tr></table></figure><p><strong>工作原理</strong></p><p><code>virtio_balloon</code> 是一种用于虚拟化环境中的内存管理技术，特别是用于动态调整虚拟机 (VM) 内存使用的机制。它由 Virtio 提供，主要用于 KVM (Kernel-based Virtual Machine) 和 QEMU 等虚拟化平台。下面是对 <code>virtio_balloon</code> 机制的详细解释：</p><ol><li><strong>气球膨胀</strong>：<ul><li>当物理主机需要回收内存时，虚拟机管理程序（Hypervisor）会请求虚拟机释放一些内存。</li><li>虚拟机内的 <code>virtio_balloon</code> 驱动程序会分配一块内存，并将其“膨胀”，即将这块内存标记为不可用，然后通知虚拟机管理程序。</li><li>这块内存实际上变成了空闲内存，供物理主机上的其他虚拟机或进程使用。</li></ul></li><li><strong>气球收缩</strong>：<ul><li>当物理主机内存压力减小或虚拟机需要更多内存时，虚拟机管理程序会请求虚拟机恢复部分被释放的内存。</li><li><code>virtio_balloon</code> 驱动程序会“收缩”这块内存，将其重新标记为可用。</li><li>这块内存再次变得可供虚拟机使用。</li></ul></li></ol><h2 id="vps-溢价计算器">VPS 溢价计算器</h2><p>请点击<a href="https://oto.deno.dev/">传送门</a></p><h2 id="ip-检测">IP 检测</h2><p>提示</p><p>可直接访问我的 IP 检测站点<a href="https://ip.bigdata.icu/">ip.bigdata.icu</a>,轻松检查你的 IP，IP 地理位置，检查DNS泄漏，检查 WebRTC 连接，速度测试，ping 测试，MTR测试，检查网站可用性等等。感谢<a href="https://github.com/jason5ng32/MyIP">Jason Ng &amp; Seven Yu</a>开源</p><h3 id="其他-ip-检测工具">其他 IP 检测工具</h3><p>其他-ip-检测工具</p><ul><li><a href="https://dnschecker.org/">DNSCHECKER</a></li><li><a href="https://ipapi.is/">ipapi.is</a></li><li><a href="https://ip-api.com/">ip-api</a></li><li><a href="https://ipdata.co/">ipdata</a></li><li><a href="https://ipinfo.io/">ipinfo.io</a></li><li><a href="https://ipinsight.io/">IPinsight</a></li><li><a href="https://www.ipip.net/">IPIP</a></li><li><a href="https://ping.pe/">ping.pe</a></li><li><a href="https://scamalytics.com/">SCAMALYTICS</a></li><li><a href="https://browserleaks.com/webrtc">WebRTC Leak Test</a></li><li><a href="https://boce.aliyun.com/detect/ping">阿里云网站运维检测平台</a></li></ul><h2 id="服务器监控-哪吒">服务器监控-哪吒</h2><blockquote><p>开源、轻量、易用的服务器监控、运维工具</p></blockquote><p>提示</p><p><a href="https://bigdata.icu/tools/soft/nezha.html">哪吒监控</a>的详细使用视频和文档已撰写完毕，请点击<a href="https://bigdata.icu/tools/soft/nezha.html">传送门</a>查看。<br>如果您正在使用TrueNAS，想把<a href="https://bigdata.icu/tools/soft/nezha.html">哪吒监控</a>安装到APP里面，可以查看我的<a href="https://www.bilibili.com/cheese/play/ep525309">《TrueNAS Scale终极教程》</a>。</p><h2 id="各地区延迟监控-ip">各地区延迟监控 IP</h2><p><a href="https://bigdata.icu/tools/soft/nezha.html#_0x05-%E5%BB%B6%E8%BF%9F%E7%9B%91%E6%8E%A7">传送门</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;最强主机评测&quot;&gt;最强主机评测&lt;/h1&gt;
&lt;p&gt;&lt;a href=&quot;https://digvps.com/review&quot;&gt;https://digvps.com/review&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;几乎包含了市面上大中小型主机提供商（不含AWS，Google等）&lt;/p&gt;</summary>
      
    
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
    <category term="折腾" scheme="https://blog.lthero.cn/tags/%E6%8A%98%E8%85%BE/"/>
    
    <category term="vps" scheme="https://blog.lthero.cn/tags/vps/"/>
    
  </entry>
  
</feed>
