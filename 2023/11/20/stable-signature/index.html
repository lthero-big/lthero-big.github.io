<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>stable-signature | lthero</title><meta name="keywords" content="watermark,AIGC,StableDiffusion"><meta name="author" content="lthero"><meta name="copyright" content="lthero"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Stable Signature运行流程 先安装原始的stable diffusion，目前stable diffusion有两个版本(v1,v2)，建议用v2（v1实际跑越来的问题太多了）；  除了原始的sd，目前还有stable diffusion webui版本，这个版本拥有了UI，而且一键安装不需要自己配置环境，上手即用，但缺点是，目前无法对webui中的txt2img.py文件进行修改，">
<meta property="og:type" content="article">
<meta property="og:title" content="stable-signature">
<meta property="og:url" content="https://blog.lthero.cn/2023/11/20/stable-signature/index.html">
<meta property="og:site_name" content="lthero">
<meta property="og:description" content="Stable Signature运行流程 先安装原始的stable diffusion，目前stable diffusion有两个版本(v1,v2)，建议用v2（v1实际跑越来的问题太多了）；  除了原始的sd，目前还有stable diffusion webui版本，这个版本拥有了UI，而且一键安装不需要自己配置环境，上手即用，但缺点是，目前无法对webui中的txt2img.py文件进行修改，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.lthero.cn/webPic/background/wallhaven-z8qldy.jpg">
<meta property="article:published_time" content="2023-11-20T08:50:14.000Z">
<meta property="article:modified_time" content="2023-11-20T10:53:20.309Z">
<meta property="article:author" content="lthero">
<meta property="article:tag" content="watermark">
<meta property="article:tag" content="AIGC">
<meta property="article:tag" content="StableDiffusion">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.lthero.cn/webPic/background/wallhaven-z8qldy.jpg"><link rel="shortcut icon" href="https://cdn.lthero.cn/webPic/logo/lthero_logo.png"><link rel="canonical" href="https://blog.lthero.cn/2023/11/20/stable-signature/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="iNo3p5pDMQW3QRCjgVQ_A-4vbPCQipgCC1evSSmk8p8"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/5.13.0/css/all.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://ltherocn2.oss-cn-beijing.aliyuncs.com/cdn/css/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":90,"position":"top","messagePrev":"这篇文章距离他上一次更新已经过去了……我算算啊……好像是","messageNext":"天吧，不知道是否还有效啊!"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'stable-signature',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-11-20 18:53:20'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/mycss/lthero-css.css"><!-- hexo injector head_end start --><script> let HEXO_MMEDIA_DATA = { js: [], css: [], aplayerData: [], metingData: [], artPlayerData: [], dplayerData: []}; </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="lthero" type="application/atom+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.lthero.cn/webPic/logo/lthero_avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">149</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">88</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">62</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.lthero.cn/webPic/background/wallhaven-z8qldy.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">lthero</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">stable-signature</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-11-20T08:50:14.000Z" title="发表于 2023-11-20 16:50:14">2023-11-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-11-20T10:53:20.309Z" title="更新于 2023-11-20 18:53:20">2023-11-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/watermark/">watermark</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>10分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="stable-signature"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="stable-signature运行流程">Stable Signature运行流程</h1>
<p>先安装原始的stable diffusion，目前stable diffusion有两个版本(v1,v2)，建议用v2（v1实际跑越来的问题太多了）；</p>
<blockquote>
<p>除了原始的sd，目前还有stable diffusion webui版本，这个版本拥有了UI，而且一键安装不需要自己配置环境，上手即用，但缺点是，目前无法对webui中的txt2img.py文件进行修改，即：无法将stable signature嵌入进去。</p>
</blockquote>
<hr>
<blockquote>
<p>stable signature是基于<strong>stable diffusion</strong>基础上的，所以，要先运行好stable diffusion</p>
<p>下面是stable diffusion【v2】安装流程</p>
<p>stable diffusion【v2】项目：<a target="_blank" rel="noopener" href="https://github.com/Stability-AI/stablediffusion">https://github.com/Stability-AI/stablediffusion</a></p>
<p>注意：作者是Stability-AI</p>
</blockquote>
<h2 id="下载stable-diffusion项目">下载stable diffusion项目</h2>
<p>打开项目的目录，里面有environment.yaml文件，可以打开environment.yaml文件，对<code>name</code>进行修改（默认为ldm）</p>
<h3 id="安装初始环境">安装初始环境</h3>
<p>随后，使用anaconda的shell，<strong>进入到项目的目录</strong>，并<strong>执行下面命令</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conda <span class="built_in">env</span> create -f environment.yaml</span><br><span class="line">conda activate ldm</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="安装必要的库">安装必要的库</h3>
<p>随后，再<strong>执行下面的命令</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">conda install pytorch==1.12.1 torchvision==0.13.1 -c pytorch</span><br><span class="line">pip install transformers==4.19.2 diffusers invisible-watermark</span><br><span class="line">pip install -e .</span><br></pre></td></tr></table></figure>
<p>至此，就可以运行stable diffusion了，但生成速度很慢，需要再安装xformers（交叉注意力相关），项目：<a target="_blank" rel="noopener" href="https://github.com/facebookresearch/xformers">https://github.com/facebookresearch/xformers</a></p>
<hr>
<h3 id="安装xformers的命令">安装xformers的命令</h3>
<ul>
<li><strong>(RECOMMENDED, linux) Install latest stable with conda</strong>: Requires <a target="_blank" rel="noopener" href="https://pytorch.org/get-started/locally/">PyTorch 1.13.1, 2.0.1 or 2.1.0 installed with conda</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install xformers -c xformers</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>(RECOMMENDED, linux &amp; win) Install latest stable with pip</strong>: Requires <a target="_blank" rel="noopener" href="https://pytorch.org/get-started/locally/">PyTorch 2.1.0</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cuda 11.8 version</span></span><br><span class="line">pip3 install -U xformers --index-url https://download.pytorch.org/whl/cu118</span><br><span class="line"><span class="comment"># cuda 12.1 version</span></span><br><span class="line">pip3 install -U xformers --index-url https://download.pytorch.org/whl/cu121</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="运行stable-diffusion项目">运行stable diffusion项目</h2>
<p>在项目的目录中，执行下面命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 成功出图</span></span><br><span class="line">python scripts/txt2img.py --prompt <span class="string">&quot;a professional photograph of an astronaut riding a horse&quot;</span> --ckpt ..\ckpt\512-ema-pruned.ckpt --config .\configs\stable-diffusion\v2-inference.yaml --H 512 --W 512  --device cuda --n_samples 1</span><br><span class="line">---------------</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">python scripts/txt2img.py --prompt <span class="string">&quot;a professional photograph of an astronaut riding a horse&quot;</span> --ckpt 768-ema-pruned.ckpt --config configs/stable-diffusion/v2-inference-v.yaml --H 768 --W 768 --device cuda</span><br></pre></td></tr></table></figure>
<p>参数解读</p>
<p>–prompt</p>
<blockquote>
<p>提示词</p>
</blockquote>
<p>–device cuda</p>
<blockquote>
<p>强制使用cude，一定要添加，不然报错</p>
</blockquote>
<p>–ckpt</p>
<blockquote>
<p>是图片模型文件（weight）</p>
<p>ckpt文件的下载链接：<a target="_blank" rel="noopener" href="https://github.com/Stability-AI/stablediffusion/tree/main/configs/stable-diffusion">https://github.com/Stability-AI/stablediffusion/tree/main/configs/stable-diffusion</a></p>
<p>官网提供了ckpt和safetensor两种版本，目前两个版本可以相互转换</p>
<p>相互转换的工具链接：<a target="_blank" rel="noopener" href="https://github.com/diStyApps/Safe-and-Stable-Ckpt2Safetensors-Conversion-Tool-GUI">https://github.com/diStyApps/Safe-and-Stable-Ckpt2Safetensors-Conversion-Tool-GUI</a></p>
</blockquote>
<p>–config</p>
<blockquote>
<p>配置文件</p>
<p><a target="_blank" rel="noopener" href="https://huggingface.co/stabilityai/stable-diffusion-2-1/tree/main">https://huggingface.co/stabilityai/stable-diffusion-2-1/tree/main</a></p>
<p>ckpt和config文件要相互对应，否则画出来的东西很抽象</p>
<p>如</p>
<p>模型：768-ema-pruned.ckpt要对应配置文件v2-1_768-ema-pruned.yaml<br>
模型：512-ema-pruned.ckpt要对应配置文件v2-inference.yaml</p>
<p>在本命令中，使用的是下面两种相对应的，这里的v2-inference-v.yaml就是v2-1_768-ema-pruned.yaml，两个内容是一样的，所以还是按照模型和配置文件对应的定理<br>
768model.ckpt --config configs/stable-diffusion/v2-inference-v.yaml</p>
</blockquote>
<p>–H</p>
<blockquote>
<p>高度，同理–W是宽度</p>
</blockquote>
<p>–n_samples</p>
<blockquote>
<p>批次数，默认设置3，会生成9张图，若设置5则生成15张图。</p>
</blockquote>
<p>–seed</p>
<blockquote>
<p>种子，默认是42，如果执行两次命令，使用相同的seed，生成出来的图片是相同的</p>
</blockquote>
<p>在<code>outputs\txt2img-samples</code> 可以看到生成的图片，下面将使用stable signature</p>
<hr>
<h2 id="stable-signature运行流程">stable signature运行流程</h2>
<blockquote>
<p>确保stable diffusion能正常运行后</p>
<p>stable signature项目地址：<a target="_blank" rel="noopener" href="https://github.com/facebookresearch/stable_signature">https://github.com/facebookresearch/stable_signature</a></p>
</blockquote>
<p>项目中提供了一个已经训练好的<strong>decoder</strong>，下载这个<strong>decoder</strong>即可使用—&gt; <a target="_blank" rel="noopener" href="https://dl.fbaipublicfiles.com/ssl_watermarking/sd2_decoder.pth">下载链接</a></p>
<h3 id="使用decoder">使用decoder</h3>
<blockquote>
<p>需要将LDM<strong>自带的decoder</strong>切换到“<strong>下载的decoder</strong>”，需要做的</p>
<ol>
<li>打开stable diffusion的txt2img.py文件（它的路径<code>stablediffusion\scripts\txt2img.py</code>）</li>
<li>在220行左右添加下面的代码</li>
<li>还要注释掉 <code>img = put_watermark(img, wm_encoder)</code> 这行代码，不让stable diffusion自带的水印函数生效</li>
</ol>
<p>Reload weights of the LDM decoder in the Stable Diffusion scripts by appending the following lines after loading the checkpoint (for instance, <a target="_blank" rel="noopener" href="https://github.com/Stability-AI/stablediffusion/blob/main/scripts/txt2img.py#L220">L220 in the SD repo</a>)</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">state_dict = torch.load(path/to/ldm/checkpoint_000.pth)[<span class="string">&#x27;ldm_decoder&#x27;</span>]</span><br><span class="line">msg = model.first_stage_model.load_state_dict(state_dict, strict=<span class="literal">False</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;loaded LDM decoder state_dict with message\n<span class="subst">&#123;msg&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;you should check that the decoder keys are correctly matched&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>大致添加的位置如下</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">opt</span>):</span><br><span class="line">    seed_everything(opt.seed)</span><br><span class="line"></span><br><span class="line">    config = OmegaConf.load(<span class="string">f&quot;<span class="subst">&#123;opt.config&#125;</span>&quot;</span>)</span><br><span class="line">    device = torch.device(<span class="string">&quot;cuda&quot;</span>) <span class="keyword">if</span> opt.device == <span class="string">&quot;cuda&quot;</span> <span class="keyword">else</span> torch.device(<span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">    model = load_model_from_config(config, <span class="string">f&quot;<span class="subst">&#123;opt.ckpt&#125;</span>&quot;</span>, device)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 下面是添加的代码</span></span><br><span class="line">    state_dict = torch.load(path/to/ldm/checkpoint_000.pth)[<span class="string">&#x27;ldm_decoder&#x27;</span>]</span><br><span class="line">    msg = model.first_stage_model.load_state_dict(state_dict, strict=<span class="literal">False</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;loaded LDM decoder state_dict with message\n<span class="subst">&#123;msg&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;you should check that the decoder keys are correctly matched&quot;</span>)</span><br></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>如果使用**“下载的decoder”<strong>（<a target="_blank" rel="noopener" href="https://justpaste.it/ae93f">生成此decoder的命令</a>），而不是使用自己训练的decoder，那么就不需要选择</strong>ldm_decoder**这个键，即<code>state_dict = torch.load(path/to/ckpt.pth)</code>，在220行左右添加下面的代码，并且仍需要注释掉 <code>img = put_watermark(img, wm_encoder)</code> 这行代码</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">state_dict = torch.load(path/to/ldm/checkpoint_000.pth)</span><br><span class="line">msg = model.first_stage_model.load_state_dict(state_dict, strict=<span class="literal">False</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;loaded LDM decoder state_dict with message\n<span class="subst">&#123;msg&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;you should check that the decoder keys are correctly matched&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>随后，按上面<strong>运行stable diffusion的命令执行即可</strong>生成包含水印的图片</p>
<h3 id="自己训练decoder">自己训练decoder</h3>
<h4 id="下载data集">下载Data集</h4>
<p>The paper uses the <a target="_blank" rel="noopener" href="https://cocodataset.org/">COCO</a> dataset to fine-tune the LDM decoder (we filtered images containing people). All you need is around 500 images for training (preferably over 256x256).</p>
<hr>
<h4 id="下载ldm-configs-and-checkpoints">下载LDM configs and checkpoints</h4>
<p>Create LDM configs and checkpoints from the <a target="_blank" rel="noopener" href="https://huggingface.co/stabilityai">Hugging Face</a> and <a target="_blank" rel="noopener" href="https://github.com/Stability-AI/stablediffusion/tree/main/configs/stable-diffusion">Stable Diffusion</a> repositories. The code should also work for Stable Diffusion v1 without any change. For other models (like old LDMs or VQGANs), you may need to adapt the code to load the checkpoints.</p>
<blockquote>
<p>这里的configs和ckeckpoints要对应好</p>
</blockquote>
<hr>
<h4 id="下载提取器文件">下载提取器文件</h4>
<blockquote>
<p>想提取水印，需要有个<strong>提取器文件</strong>，即dec_48b_whit.torchscript.pt，下载方式如下</p>
</blockquote>
<p>pth文件没有经过白化处理，pt文件经过了处理可以直接用</p>
<p><a target="_blank" rel="noopener" href="https://dl.fbaipublicfiles.com/ssl_watermarking/dec_48b_whit.torchscript.pt">dec_48b_whit.torchscript.pt </a>是可以直接用的</p>
<p><a target="_blank" rel="noopener" href="https://dl.fbaipublicfiles.com/ssl_watermarking/other_dec_48b_whit.torchscript.pt">other_dec_48b_whit.torchscript.pt</a> 鲁棒性可能更好，但会稍微降低图片质量</p>
<table>
<thead>
<tr>
<th>Model</th>
<th>Checkpoint</th>
<th>Torch-Script</th>
</tr>
</thead>
<tbody>
<tr>
<td>Extractor</td>
<td><a target="_blank" rel="noopener" href="https://dl.fbaipublicfiles.com/ssl_watermarking/dec_48b.pth">dec_48b.pth</a></td>
<td><a target="_blank" rel="noopener" href="https://dl.fbaipublicfiles.com/ssl_watermarking/dec_48b_whit.torchscript.pt">dec_48b_whit.torchscript.pt</a></td>
</tr>
<tr>
<td>Other</td>
<td><a target="_blank" rel="noopener" href="https://dl.fbaipublicfiles.com/ssl_watermarking/other_dec_48b.pth">other_dec_48b_whit.pth</a></td>
<td><a target="_blank" rel="noopener" href="https://dl.fbaipublicfiles.com/ssl_watermarking/other_dec_48b_whit.torchscript.pt">other_dec_48b_whit.torchscript.pt</a></td>
</tr>
</tbody>
</table>
<hr>
<h4 id="下载perceptual-losses">下载Perceptual Losses</h4>
<p>The perceptual losses are based on <a target="_blank" rel="noopener" href="https://github.com/SteffenCzolbe/PerceptualSimilarity/">this repo</a>. You should download the weights here: <a target="_blank" rel="noopener" href="https://github.com/SteffenCzolbe/PerceptualSimilarity/tree/master/src/loss/weights">https://github.com/SteffenCzolbe/PerceptualSimilarity/tree/master/src/loss/weights</a>, and put them in a folder called <code>losses</code> (this is used in <a target="_blank" rel="noopener" href="https://github.com/facebookresearch/stable_signature/blob/main/src/loss/loss_provider.py#L22">src/loss/loss_provider.py#L22</a>). To do so you can run</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/SteffenCzolbe/PerceptualSimilarity.git</span><br><span class="line"><span class="built_in">cp</span> -r PerceptualSimilarity/src/loss/weights src/loss/losses/</span><br><span class="line"><span class="built_in">rm</span> -r PerceptualSimilarity</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="生成微调解码器decoder">生成微调解码器decoder</h4>
<p>下载完上面的东西，现在可以使用以下命令来生成微调的decoder</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">python finetune_ldm_decoder.py --num_keys 1 \</span><br><span class="line">    --ldm_config path/to/ldm/config.yaml \</span><br><span class="line">    --ldm_ckpt path/to/ldm/ckpt.pth \</span><br><span class="line">    --msg_decoder_path path/to/msg/decoder/ckpt.torchscript.pt \</span><br><span class="line">    --train_dir path/to/train/dir \</span><br><span class="line">    --val_dir path/to/val/dir</span><br></pre></td></tr></table></figure>
<blockquote>
<p>参数解读</p>
<ol>
<li>ldm_config 是ldm配置文件，一般叫&quot;v2-inference.ymal&quot;</li>
<li>ldm_ckpt 是ldm的模型权重，一般为ckpt格式</li>
<li>msg_decoder_path 是HiDDen的提取器，即dec_48b_whit.torchscript.pt</li>
<li>train_dir和val_dir是训练集和验证集目录</li>
</ol>
</blockquote>
<p>执行后会生成下面三种文件</p>
<ul>
<li><em>num_keys</em> checkpoints of the LDM decoder with watermark fine-tuning (checkpoint_000.pth, etc.),</li>
<li><code>keys.txt</code>: text file containing the keys used for fine-tuning (one key per line),</li>
<li><code>imgs</code>: folder containing examples of auto-encoded images.</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://justpaste.it/aw0gj">Params of LDM fine-tuning used in the paper</a><br>
<a target="_blank" rel="noopener" href="https://justpaste.it/cse0x">Logs during LDM fine-tuning</a></p>
<hr>
<h3 id="提取水印">提取水印</h3>
<p>打开decoding.ipynb文件，把<strong>dec_48b_whit.torchscript.pt</strong>路径填写进去</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msg_extractor = torch.jit.load(<span class="string">&quot;E:/C_code/Python/AIGC/stable_signature/hidden/models/dec_48b_whit.torchscript.pt&quot;</span>).to(<span class="string">&quot;cuda&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>顺便把生成好的包含<strong>水印图片的路径</strong>写进去</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img = Image.<span class="built_in">open</span>(<span class="string">&quot;E:/C_code/Python/AIGC/stablediffusion_v2/outputs/txt2img-samples/samples/batch_02_withmark/qq11.png&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>随后按顺便运行decoding.ipynb文件即可<strong>提取出key</strong>，再与decoding.ipynb文件中的key对比，如果bit accuracy比较高（大于0.8，基本则说明包含水印），对于一个不包含水印的图片，bit accuracy一般在0.5浮动</p>
<hr>
<h3 id="鲁棒性测试">鲁棒性测试</h3>
<p>The <code>run_eval.py</code> script can be used to get the robustness and quality metrics on a folder of images. For instance:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python run_eval.py --eval_imgs False --eval_bits True \</span><br><span class="line">    --img_dir path/to/imgs_w \</span><br><span class="line">    --key_str <span class="string">&#x27;111010110101000001010111010011010100010000100111&#x27;</span></span><br></pre></td></tr></table></figure>
<p>will return a csv file containing bit accuracy for different attacks applied before decoding.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python run_eval.py --eval_imgs True --eval_bits False \</span><br><span class="line">    --img_dir path/to/imgs_w --img_dir_nw path/to/imgs_nw </span><br></pre></td></tr></table></figure>
<p>will return a csv file containing image metrics (PSNR, SSIM, LPIPS) between watermarked (<code>_w</code>) and non-watermarked (<code>_nw</code>) images.</p>
<hr>
<h2 id="运行时遇到的一些问题">运行时遇到的一些问题</h2>
<p>问题一：画出的东西很奇怪，很抽像</p>
<p><a target="_blank" rel="noopener" href="https://www.reddit.com/r/StableDiffusion/comments/zlzn70/i_switched_to_v21_768nonemapruned_and_now/">https://www.reddit.com/r/StableDiffusion/comments/zlzn70/i_switched_to_v21_768nonemapruned_and_now/</a></p>
<blockquote>
<p>来自reddit的回复</p>
<p>You can download YAML files that work with v2-1 checkpoints from this webpage:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Stability-AI/stablediffusion/tree/main/configs/stable-diffusion">https://github.com/Stability-AI/stablediffusion/tree/main/configs/stable-diffusion</a></p>
<p>Use the v2-inference.yaml with the v2-1_512-ema-pruned.ckpt and v2-1_512-nonema-pruned.ckpt files.</p>
<p>Use the v2-inference-v.yaml with the v2-1_768-ema-pruned.ckpt and v2-1_768-nonema-pruned.ckpt files.</p>
<p>In order to properly use a YAML file, copy the appropriate YAML file to the same directory as the appropriate CKPT file. Then you rename the YAML so that it has the exact same name as corresponding CKPT file. Do not change the extensions of the file names.</p>
</blockquote>
<p>问题二：无法下载checkpoint_liberty_with_aug.pth</p>
<blockquote>
<p>把这个项目下载下来：<a target="_blank" rel="noopener" href="https://github.com/DagnyT/hardnet/tree/master%EF%BC%8C%E5%9C%A8%E8%BF%99%E4%B8%AA%E9%A1%B9%E7%9B%AE%E7%9A%84hardnet/pretrained/train_liberty_with_aug/%E8%B7%AF%E5%BE%84%E6%9C%89%E4%B8%AAcheckpoint_liberty_with_aug.pth%E6%96%87%E4%BB%B6">https://github.com/DagnyT/hardnet/tree/master，在这个项目的hardnet/pretrained/train_liberty_with_aug/路径有个checkpoint_liberty_with_aug.pth文件</a></p>
<p>把checkpoint_liberty_with_aug.pth粘贴到下面的目录即可<br>
C:\Users\12904.cache\torch\hub\checkpoints\checkpoint_liberty_with_aug.pth</p>
<p>原因：SD项目里面的下载链接无效了，导致这个文件无法被下载</p>
</blockquote>
<p>问题三：不使用–device cuda报错</p>
<blockquote>
<p>具体报错不记得了</p>
</blockquote>
<p>将safetenors转成ckpt</p>
<p>项目：<a target="_blank" rel="noopener" href="https://github.com/huggingface/diffusers/tree/main/scripts">https://github.com/huggingface/diffusers/tree/main/scripts</a><br>
工具：<a target="_blank" rel="noopener" href="https://github.com/diStyApps/Safe-and-Stable-Ckpt2Safetensors-Conversion-Tool-GUI">https://github.com/diStyApps/Safe-and-Stable-Ckpt2Safetensors-Conversion-Tool-GUI</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://blog.lthero.cn">lthero</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.lthero.cn/2023/11/20/stable-signature/">https://blog.lthero.cn/2023/11/20/stable-signature/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.lthero.cn" target="_blank">lthero</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/watermark/">watermark</a><a class="post-meta__tags" href="/tags/AIGC/">AIGC</a><a class="post-meta__tags" href="/tags/StableDiffusion/">StableDiffusion</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/12/16/Linear-transformations/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.lthero.cn/webPic/background/RD2.jpg" onerror="onerror=null;src='https://cdn.lthero.cn/webPic/background/wallhaven-rdekew.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linear transformations</div></div></a></div><div class="next-post pull-right"><a href="/2023/10/20/what-is-a-convolution/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.lthero.cn/webPic/background/6c7ccc_28_painter_4k.jpg" onerror="onerror=null;src='https://cdn.lthero.cn/webPic/background/wallhaven-rdekew.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">But What's a convolution?</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/03/07/GS-watermark/" title="针对SD的Gaussian Shading鲁棒水印实现"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.lthero.cn/webPic/background/wallhaven-l3z192.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-07</div><div class="title">针对SD的Gaussian Shading鲁棒水印实现</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.lthero.cn/webPic/logo/lthero_avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">lthero</div><div class="author-info__description">喜欢折腾|喜欢尝试各种炫酷玩意儿|      Hacking the world</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">149</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">88</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">62</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/lthero-big"><i class="fab fa-github"></i><span>关注我</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/lthero-big" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:ltherowlh@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">感谢github托管|hexo--butterfly主题提供支持</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#stable-signature%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">Stable Signature运行流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDstable-diffusion%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.1.</span> <span class="toc-text">下载stable diffusion项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%88%9D%E5%A7%8B%E7%8E%AF%E5%A2%83"><span class="toc-number">1.1.1.</span> <span class="toc-text">安装初始环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%BF%85%E8%A6%81%E7%9A%84%E5%BA%93"><span class="toc-number">1.1.2.</span> <span class="toc-text">安装必要的库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85xformers%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">1.1.3.</span> <span class="toc-text">安装xformers的命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8Cstable-diffusion%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.2.</span> <span class="toc-text">运行stable diffusion项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stable-signature%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.</span> <span class="toc-text">stable signature运行流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8decoder"><span class="toc-number">1.3.1.</span> <span class="toc-text">使用decoder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%B7%B1%E8%AE%AD%E7%BB%83decoder"><span class="toc-number">1.3.2.</span> <span class="toc-text">自己训练decoder</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDdata%E9%9B%86"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">下载Data集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDldm-configs-and-checkpoints"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">下载LDM configs and checkpoints</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E6%8F%90%E5%8F%96%E5%99%A8%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">下载提取器文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDperceptual-losses"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">下载Perceptual Losses</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%BE%AE%E8%B0%83%E8%A7%A3%E7%A0%81%E5%99%A8decoder"><span class="toc-number">1.3.2.5.</span> <span class="toc-text">生成微调解码器decoder</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E5%8F%96%E6%B0%B4%E5%8D%B0"><span class="toc-number">1.3.3.</span> <span class="toc-text">提取水印</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%B2%81%E6%A3%92%E6%80%A7%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.4.</span> <span class="toc-text">鲁棒性测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98"><span class="toc-number">1.4.</span> <span class="toc-text">运行时遇到的一些问题</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/03/07/GS-watermark/" title="针对SD的Gaussian Shading鲁棒水印实现"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.lthero.cn/webPic/background/wallhaven-l3z192.jpg" onerror="this.onerror=null;this.src='https://cdn.lthero.cn/webPic/background/wallhaven-rdekew.jpg'" alt="针对SD的Gaussian Shading鲁棒水印实现"/></a><div class="content"><a class="title" href="/2024/03/07/GS-watermark/" title="针对SD的Gaussian Shading鲁棒水印实现">针对SD的Gaussian Shading鲁棒水印实现</a><time datetime="2024-03-07T11:23:21.000Z" title="发表于 2024-03-07 19:23:21">2024-03-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/02/02/AutoNet/" title="【selenium】自动登录校园网"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.lthero.cn/webPic/background/wallhaven-pkgkkp.png" onerror="this.onerror=null;this.src='https://cdn.lthero.cn/webPic/background/wallhaven-rdekew.jpg'" alt="【selenium】自动登录校园网"/></a><div class="content"><a class="title" href="/2024/02/02/AutoNet/" title="【selenium】自动登录校园网">【selenium】自动登录校园网</a><time datetime="2024-02-02T12:00:27.000Z" title="发表于 2024-02-02 20:00:27">2024-02-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/01/23/Score-based-generative-models/" title="【Diffusion】基于分数的生成模型"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.lthero.cn/webPic/background/wallhaven-6oe337.png" onerror="this.onerror=null;this.src='https://cdn.lthero.cn/webPic/background/wallhaven-rdekew.jpg'" alt="【Diffusion】基于分数的生成模型"/></a><div class="content"><a class="title" href="/2024/01/23/Score-based-generative-models/" title="【Diffusion】基于分数的生成模型">【Diffusion】基于分数的生成模型</a><time datetime="2024-01-23T04:00:58.000Z" title="发表于 2024-01-23 12:00:58">2024-01-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/01/22/DDIM/" title="【DDIM】详解"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.lthero.cn/webPic/background/x8d8gz.jpg" onerror="this.onerror=null;this.src='https://cdn.lthero.cn/webPic/background/wallhaven-rdekew.jpg'" alt="【DDIM】详解"/></a><div class="content"><a class="title" href="/2024/01/22/DDIM/" title="【DDIM】详解">【DDIM】详解</a><time datetime="2024-01-22T09:04:20.000Z" title="发表于 2024-01-22 17:04:20">2024-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/01/21/Cross-Attention-Control/" title="【Cross-Attention】可视化"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.lthero.cn/webPic/background/wallhaven-285e6x.png" onerror="this.onerror=null;this.src='https://cdn.lthero.cn/webPic/background/wallhaven-rdekew.jpg'" alt="【Cross-Attention】可视化"/></a><div class="content"><a class="title" href="/2024/01/21/Cross-Attention-Control/" title="【Cross-Attention】可视化">【Cross-Attention】可视化</a><time datetime="2024-01-21T08:00:53.000Z" title="发表于 2024-01-21 16:00:53">2024-01-21</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By lthero</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="framework-info"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">浙ICP备2021022809号-1</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://ltherocn2.oss-cn-beijing.aliyuncs.com/cdn/js/fancybox.umd.js"></script><script src="https://ltherocn2.oss-cn-beijing.aliyuncs.com/cdn/js/instantpage.min.js" type="module"></script><script src="https://ltherocn2.oss-cn-beijing.aliyuncs.com/cdn/js/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadWaline () {
  function insertCSS () {
    const link = document.createElement("link")
    link.rel = "stylesheet"
    link.href = "https://ltherocn2.oss-cn-beijing.aliyuncs.com/cdn/css/waline.css"
    document.head.appendChild(link)
  }

  function initWaline () {
    const waline = Waline.init(Object.assign({
      el: '#waline-wrap',
      serverURL: 'vercel-psi-seven.vercel.app',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: false,
    }, null))
  }

  if (typeof Waline === 'function') initWaline()
  else {
    insertCSS()
    getScript('https://ltherocn2.oss-cn-beijing.aliyuncs.com/cdn/js/waline.js').then(initWaline)
  }
}

if ('Waline' === 'Waline' || !true) {
  if (true) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
  else setTimeout(loadWaline, 0)
} else {
  function loadOtherComment () {
    loadWaline()
  }
}</script></div><script src="https://ltherocn2.oss-cn-beijing.aliyuncs.com/cdn/js/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script src="/assets/mmedia/mmedia-loader.js"></script><!-- hexo injector body_end end --></body></html>